This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
backend/.gitignore
backend/api/__init__.py
backend/api/admin.py
backend/api/apps.py
backend/api/gemini_utils.py
backend/api/migrations/__init__.py
backend/api/migrations/0001_initial.py
backend/api/migrations/0002_alter_user_role.py
backend/api/migrations/0003_alter_user_role.py
backend/api/migrations/0004_alter_issue_issue_title.py
backend/api/migrations/0005_alter_minutes_file_path.py
backend/api/migrations/0006_alter_notification_issue_department.py
backend/api/models.py
backend/api/serializers.py
backend/api/services.py
backend/api/templates/emails/overdue_issue.html
backend/api/templates/emails/overdue_issue.txt
backend/api/urls.py
backend/api/views.py
backend/backend/__init__.py
backend/backend/asgi.py
backend/backend/settings.py
backend/backend/urls.py
backend/backend/wsgi.py
backend/fix_db.py
backend/fix_wsgi.py
backend/font/NotoSansMalayalam-Regular.ttf
backend/manage.py
backend/media/minutes/DDC MINUTES 1-03-2025 Final.pdf
backend/media/minutes/DDC MINUTES 26.07.2025.pdf
backend/media/minutes/DDC MINUTES 27.09.2025.pdf
backend/media/minutes/DDC MINUTES keerthi.pdf
backend/media/minutes/DDC MINUTES small (1).pdf
backend/media/minutes/DDC MINUTES small.pdf
backend/media/minutes/pdf&rendition=1-6 (1).pdf
backend/media/minutes/small minutes1.pdf
backend/media/responses/1_USERS_TABLE_3rjgjmz.pdf
backend/media/responses/1_USERS_TABLE_Obphfcu.pdf
backend/media/responses/1_USERS_TABLE_VxpBP14.pdf
backend/media/responses/1_USERS_TABLE_Xtb7w0s.pdf
backend/media/responses/1_USERS_TABLE.pdf
backend/media/responses/DDC_MINUTES_small_1_xXhgvAd.pdf
backend/media/responses/DDC_MINUTES_small_1.pdf
backend/media/responses/PP1_eh0WYOf.pdf
backend/media/responses/PP1.pdf
backend/requirements.txt
client/index.html
client/package.json
client/src/api/axios.js
client/src/App.css
client/src/App.jsx
client/src/components/Collector/CollectorHeader.css
client/src/components/Collector/CollectorHeader.jsx
client/src/components/Collector/IssuePage/CollectorFilterBar.css
client/src/components/Collector/IssuePage/CollectorFilterBar.jsx
client/src/components/Collector/IssuePage/CollectorGenerateReportCard.jsx
client/src/components/Collector/IssuePage/CollectorGenerateReports.css
client/src/components/Collector/IssuePage/CollectorGenerateReports.jsx
client/src/components/Collector/IssuePage/CollectorIssueCard.css
client/src/components/Collector/IssuePage/CollectorIssueCard.jsx
client/src/components/Collector/IssuePage/CollectorTabs.css
client/src/components/Collector/IssuePage/CollectorTabs.jsx
client/src/components/common/EmptyStateCard.css
client/src/components/common/EmptyStateCard.jsx
client/src/components/common/LoadingState.css
client/src/components/common/LoadingState.jsx
client/src/components/Department/DepartmentFilterBar.css
client/src/components/Department/DepartmentFilterBar.jsx
client/src/components/Department/DepartmentHeader.css
client/src/components/Department/DepartmentHeader.jsx
client/src/components/Department/DepartmentIssueCard.css
client/src/components/Department/DepartmentIssueCard.jsx
client/src/components/Department/DepartmentResponseModal.css
client/src/components/Department/DepartmentResponseModal.jsx
client/src/components/Department/DepartmentTabs.css
client/src/components/Department/DepartmentTabs.jsx
client/src/components/DPO/DPOHeader.css
client/src/components/DPO/DPOHeader.jsx
client/src/components/DPO/IssuePage/DPOFilterBar.css
client/src/components/DPO/IssuePage/DPOFilterBar.jsx
client/src/components/DPO/IssuePage/DPOGenerateReportCard.jsx
client/src/components/DPO/IssuePage/DPOGenerateReports.css
client/src/components/DPO/IssuePage/DPOGenerateReports.jsx
client/src/components/DPO/IssuePage/DPOIssueCard.css
client/src/components/DPO/IssuePage/DPOIssueCard.jsx
client/src/components/DPO/IssuePage/DPOSingleIssueAssignCard.css
client/src/components/DPO/IssuePage/DPOSingleIssueAssignCard.jsx
client/src/components/DPO/IssuePage/DPOTabs.css
client/src/components/DPO/IssuePage/DPOTabs.jsx
client/src/components/DPO/UploadPage/DPOAssignIssues.css
client/src/components/DPO/UploadPage/DPOAssignIssues.jsx
client/src/components/DPO/UploadPage/DPOIssueAssignCard.jsx
client/src/components/DPO/UploadPage/DPOUploadForm.css
client/src/components/DPO/UploadPage/DPOUploadForm.jsx
client/src/index.css
client/src/main.jsx
client/src/pages/CollectorPage/CollectorIssuePage.css
client/src/pages/CollectorPage/CollectorIssuePage.jsx
client/src/pages/CollectorPage/CollectorMinutesPage.css
client/src/pages/CollectorPage/CollectorMinutesPage.jsx
client/src/pages/CollectorPage/NotificationPage.css
client/src/pages/CollectorPage/NotificationPage.jsx
client/src/pages/DepartmentPage/DepartmentMinutesPage.css
client/src/pages/DepartmentPage/DepartmentMinutesPage.jsx
client/src/pages/DepartmentPage/DepartmentNotificationPage.css
client/src/pages/DepartmentPage/DepartmentNotificationPage.jsx
client/src/pages/DepartmentPage/DepartmentResponsePage.css
client/src/pages/DepartmentPage/DepartmentResponsePage.jsx
client/src/pages/DPOPage/DPODraftsPage.css
client/src/pages/DPOPage/DPODraftsPage.jsx
client/src/pages/DPOPage/DPOIssuePage.css
client/src/pages/DPOPage/DPOIssuePage.jsx
client/src/pages/DPOPage/DPOMinutesPage.css
client/src/pages/DPOPage/DPOMinutesPage.jsx
client/src/pages/DPOPage/DPONotificationPage.css
client/src/pages/DPOPage/DPONotificationPage.jsx
client/src/pages/LoginPage.css
client/src/pages/LoginPage.jsx
client/src/utils/authStorage.js
client/src/utils/dpoDrafts.js
client/src/utils/liveUpdates.js
ENV_SETUP_GUIDE.md
package.json
README.md
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/.gitignore">
__pycache__/
*.pyc
.env
</file>

<file path="backend/api/__init__.py">

</file>

<file path="backend/api/apps.py">
from django.apps import AppConfig
class ApiConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'api'
</file>

<file path="backend/api/migrations/__init__.py">

</file>

<file path="backend/api/migrations/0002_alter_user_role.py">
# Generated by Django 6.0 on 2026-01-05 04:21

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='user',
            name='role',
            field=models.CharField(choices=[('dpo', 'DPO'), ('collector', 'Collector'), ('department', 'Department')], max_length=20),
        ),
    ]
</file>

<file path="backend/api/migrations/0003_alter_user_role.py">
# Generated by Django 6.0 on 2026-01-05 05:26

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0002_alter_user_role'),
    ]

    operations = [
        migrations.AlterField(
            model_name='user',
            name='role',
            field=models.CharField(choices=[('dpo', 'dpo'), ('collector', 'collector'), ('department', 'department')], max_length=20),
        ),
    ]
</file>

<file path="backend/api/migrations/0004_alter_issue_issue_title.py">
# Generated by Django 6.0 on 2026-01-07 18:54

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0003_alter_user_role'),
    ]

    operations = [
        migrations.AlterField(
            model_name='issue',
            name='issue_title',
            field=models.CharField(max_length=300),
        ),
    ]
</file>

<file path="backend/api/migrations/0005_alter_minutes_file_path.py">
# Generated by Django 6.0 on 2026-02-17 13:30

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0004_alter_issue_issue_title'),
    ]

    operations = [
        migrations.AlterField(
            model_name='minutes',
            name='file_path',
            field=models.FileField(max_length=500, upload_to='minutes/'),
        ),
    ]
</file>

<file path="backend/api/migrations/0006_alter_notification_issue_department.py">
# Generated by Django 6.0.1 on 2026-02-19 07:30

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0005_alter_minutes_file_path'),
    ]

    operations = [
        migrations.AlterField(
            model_name='notification',
            name='issue_department',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='api.issuedepartment'),
        ),
    ]
</file>

<file path="backend/api/templates/emails/overdue_issue.html">
<h2>Overdue Issue Notification</h2>

<p>Hello {{ user.first_name|default:user.username }},</p>

<p>
An issue assigned to your department 
<strong>{{ department.dept_name }}</strong> is overdue.
</p>

<hr>

<p><strong>Issue Title:</strong> {{ issue.issue.issue_title }}</p>
<p><strong>Description:</strong> {{ issue.issue.issue_description }}</p>
<p><strong>Location:</strong> {{ issue.issue.location }}</p>
<p><strong>Priority:</strong> {{ issue.issue.priority }}</p>
<p><strong>Deadline:</strong> {{ issue.deadline_date }}</p>

<hr>

<p>Please take necessary action immediately.</p>
</file>

<file path="backend/api/templates/emails/overdue_issue.txt">
Overdue Issue Notification

Hello {{ user.first_name|default:user.username }},

An issue assigned to your department {{ department.dept_name }} is overdue.

Title: {{ issue.issue.issue_title }}
Description: {{ issue.issue.issue_description }}
Location: {{ issue.issue.location }}
Priority: {{ issue.issue.priority }}
Deadline: {{ issue.deadline_date }}

Please take necessary action immediately.
</file>

<file path="backend/backend/__init__.py">

</file>

<file path="backend/backend/asgi.py">
import os
from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')

application = get_asgi_application()
</file>

<file path="backend/backend/urls.py">
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('api.urls')),
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
</file>

<file path="backend/backend/wsgi.py">
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')

application = get_wsgi_application()
</file>

<file path="backend/fix_db.py">
import os
import django

# Setup Django environment
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')
django.setup()

from django.apps import apps
User = apps.get_model('api', 'User')
Department = apps.get_model('api', 'Department')

def fix():
    print("Linking Users to Departments...")
    # 1. Ensure the 'police' user is linked to the 'POLICE' department
    police_dept, _ = Department.objects.get_or_create(dept_name='POLICE')
    User.objects.filter(username='police').update(department=police_dept)
    
    # 2. Ensure generic department user exists for demo
    pwd_dept, _ = Department.objects.get_or_create(dept_name='PWD')
    User.objects.filter(username='pwd').update(department=pwd_dept)

    print("‚úÖ Done. Users are now linked. Notifications will now trigger.")

if __name__ == "__main__":
    fix()
</file>

<file path="backend/fix_wsgi.py">
import os

# We assume we are in the outer 'backend' folder where manage.py lives.
# We need to target the inner 'backend' folder.
INNER_DIR = 'backend'

if not os.path.exists(INNER_DIR):
    print(f"‚ùå Error: Could not find the inner '{INNER_DIR}' directory!")
    print("Make sure you are running this from the folder containing manage.py")
    exit(1)

print(f"üîß Repairing Configuration in: ./{INNER_DIR}/")

# 1. Create/Fix __init__.py (Required for Python to treat this as a package)
init_path = os.path.join(INNER_DIR, '__init__.py')
with open(init_path, 'w', encoding='utf-8') as f:
    f.write("")
print("‚úÖ Restored: __init__.py")

# 2. Create/Fix wsgi.py (The file causing your crash)
wsgi_path = os.path.join(INNER_DIR, 'wsgi.py')
wsgi_content = """
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')

application = get_wsgi_application()
"""
with open(wsgi_path, 'w', encoding='utf-8') as f:
    f.write(wsgi_content.strip())
print("‚úÖ Restored: wsgi.py")

# 3. Create/Fix asgi.py (Good practice)
asgi_path = os.path.join(INNER_DIR, 'asgi.py')
asgi_content = """
import os
from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')

application = get_asgi_application()
"""
with open(asgi_path, 'w', encoding='utf-8') as f:
    f.write(asgi_content.strip())
print("‚úÖ Restored: asgi.py")

print("\nüéâ Repair Complete.")
print("üëâ Try running: python manage.py runserver")
</file>

<file path="backend/manage.py">
#!/usr/bin/env python
import os
import sys

def main():
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError("Couldn't import Django.") from exc
    execute_from_command_line(sys.argv)

if __name__ == '__main__':
    main()
</file>

<file path="client/package.json">
{
  "name": "client",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "@emotion/react": "^11.11.0",
    "@emotion/styled": "^11.11.0",
    "@mui/icons-material": "^5.15.0",
    "@mui/material": "^5.15.0",
    "axios": "^1.6.0",
    "html2pdf.js": "^0.14.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.20.0"
  },
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "vite": "^7.3.1"
  }
}
</file>

<file path="client/src/App.css">
body {
  margin: 0;
  font-family: "Inter", Arial, sans-serif;
  background-color: #E6F3FF;
  /* overflow: hidden; */
}
</file>

<file path="client/src/components/common/EmptyStateCard.css">
.empty-state-card {
  width: 100%;
  min-height: 100%;
  margin: 0 auto;
  padding: 0;
  border: none;
  border-radius: 0;
  background: transparent;
  box-shadow: none;
  color: #334155;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.empty-state-compact {
  width: 100%;
  min-height: 100%;
  margin-top: 0;
  padding: 0;
}

.empty-state-illustration {
  width: clamp(180px, 28vh, 260px);
  height: clamp(180px, 28vh, 260px);
  margin: 0 auto 4px;
  display: block;
}

.empty-stroke {
  stroke: #3b82f6;
  stroke-width: 2.6;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.empty-state-card h3 {
  margin: 4px 0 4px;
  font-size: 2.1rem;
  font-weight: 700;
  color: #1e3a8a;
  text-align: center;
  width: 100%;
}

.empty-state-card p {
  margin: 0;
  max-width: 700px;
  font-size: 1.28rem;
  line-height: 1.6;
  color: #334155;
  text-align: center;
}

@media (max-width: 768px) {
  .empty-state-card {
    min-height: 100%;
    padding: 0;
  }

  .empty-state-illustration {
    width: clamp(150px, 24vh, 220px);
    height: clamp(150px, 24vh, 220px);
    margin: 0 auto 4px;
  }

  .empty-state-card h3 {
    font-size: 1.7rem;
    margin: 4px 0 4px;
  }

  .empty-state-card p {
    font-size: 1.14rem;
    line-height: 1.5;
  }
}
</file>

<file path="client/src/components/common/EmptyStateCard.jsx">
import React from "react";
import "./EmptyStateCard.css";

function EmptyStateCard({
  title = "No items found",
  description = "There is nothing to show right now.",
  compact = false,
}) {
  return (
    <div className={`empty-state-card ${compact ? "empty-state-compact" : ""}`}>
      <svg
        className="empty-state-illustration"
        viewBox="0 0 120 120"
        fill="none"
        aria-hidden="true"
      >
        <rect x="20" y="24" width="80" height="72" rx="10" className="empty-stroke" />
        <path d="M36 46H84" className="empty-stroke" />
        <path d="M36 58H72" className="empty-stroke" />
        <path d="M36 70H64" className="empty-stroke" />
        <circle cx="84" cy="82" r="10" className="empty-stroke" />
        <path d="M91 89L98 96" className="empty-stroke" />
      </svg>

      <h3>{title}</h3>
      <p>{description}</p>
    </div>
  );
}

export default EmptyStateCard;
</file>

<file path="client/src/components/common/LoadingState.css">
.loading-state {
  width: 100%;
  height: 100%;
  min-height: 180px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 14px;
  text-align: center;
  align-self: stretch;
}

.loading-state-compact {
  height: 100%;
  min-height: 120px;
  gap: 10px;
}

.loading-state-raised {
  transform: translateY(-18px);
}

.loading-state-raised.loading-state-compact {
  transform: translateY(-12px);
}

.loading-state-compact .loading-orbit {
  width: 52px;
  height: 52px;
}

.loading-state-compact .loading-dot {
  width: 10px;
  height: 10px;
}

.loading-state-compact .loading-dot-1 {
  top: -5px;
  left: 21px;
}

.loading-state-compact .loading-dot-2 {
  right: -5px;
  top: 21px;
}

.loading-state-compact .loading-dot-3 {
  bottom: -5px;
  left: 21px;
}

.loading-state-compact p {
  font-size: 0.95rem;
}

.loading-orbit {
  width: 64px;
  height: 64px;
  border: 2px solid rgba(37, 99, 235, 0.22);
  border-radius: 50%;
  position: relative;
  animation: loading-spin 1.5s linear infinite;
}

.loading-dot {
  position: absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #2563eb;
}

.loading-dot-1 {
  top: -6px;
  left: 26px;
}

.loading-dot-2 {
  right: -6px;
  top: 26px;
}

.loading-dot-3 {
  bottom: -6px;
  left: 26px;
}

.loading-state p {
  margin: 0;
  font-size: 1.05rem;
  font-weight: 600;
  color: #1e3a8a;
}

@keyframes loading-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
</file>

<file path="client/src/components/common/LoadingState.jsx">
import React from "react";
import "./LoadingState.css";

function LoadingState({ text = "Loading...", compact = false, raised = true }) {
  return (
    <div
      className={`loading-state ${compact ? "loading-state-compact" : ""} ${raised ? "loading-state-raised" : ""}`}
      role="status"
      aria-live="polite"
    >
      <div className="loading-orbit">
        <span className="loading-dot loading-dot-1"></span>
        <span className="loading-dot loading-dot-2"></span>
        <span className="loading-dot loading-dot-3"></span>
      </div>
      <p>{text}</p>
    </div>
  );
}

export default LoadingState;
</file>

<file path="client/src/components/DPO/IssuePage/DPOSingleIssueAssignCard.css">
/* ==============================
   DPO Issue Assign Card
============================== */

.dpo-assign-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  background-color: #f9fafb;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  transition: box-shadow 0.2s ease;
}

.dpo-assign-card:hover {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
}

/* ==============================
   Card Header
============================== */

.dpo-assign-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 2px;
}

.dpo-assign-entry-id {
  font-weight: 600;
  color: #111827;
  font-size: 15px;
}

.dpo-assign-allocate-btn {
  background-color: #2563eb;
  color: #fff;
  border: none;
  padding: 8px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom:5px;
}



/* ==============================
   Form Section
============================== */

.dpo-assign-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.dpo-assign-field {
  display: flex;
  flex-direction: column;
}

.dpo-assign-field label {
  color: #374151;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
}

.dpo-assign-field input,
.dpo-assign-field select {
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 14px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.dpo-assign-field textarea {
  resize: none;
  height: 35px;
  min-height: 35px;
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.4;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.dpo-assign-field input:focus,
.dpo-assign-field select:focus,
.dpo-assign-field textarea:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

/* ==============================
   Deadline Field
============================== */

.dpo-assign-deadline {
  position: relative;
  display: flex;
  align-items: center;
}

.dpo-assign-deadline input {
  width: 100%;
  padding-right: 38px;
}

.dpo-assign-calendar {
  position: absolute;
  right: 12px;
  font-size: 18px;
  color: #4b5563;
  cursor: pointer;
  transition: color 0.2s ease;
}

.dpo-assign-calendar:hover {
  color: #2563eb;
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOSingleIssueAssignCard.jsx">
import React, { useRef } from "react";
import "./DPOSingleIssueAssignCard.css";
export default function DPOIssueAssignCard({ issue, onChange, index, onAllocate }) {
  const dateRef = useRef(null);

  const handleChange = (field, value) => onChange(index, field, value);

  const formatDateInput = (text) => {
    const digits = text.replace(/\D/g, "");
    let day = digits.substring(0, 2);
    let month = digits.substring(2, 4);
    let year = digits.substring(4, 8);

    let formatted = day;
    if (month) formatted += "-" + month;
    if (year) formatted += "-" + year;

    return formatted;
  };

  const convertDatePickerValue = (value) => {
    const [y, m, d] = value.split("-");
    return `${d}-${m}-${y}`;
  };

  return (
    <div className="dpo-assign-card">
      <div className="dpo-assign-top">
        <div className="dpo-assign-entry-id">{issue.issue_no}</div>

        <button
          className="dpo-assign-allocate-btn"
          onClick={() => onAllocate(issue)}
        >
          Allocate
        </button>
      </div>

        <div className="dpo-assign-field">
          <label>Issue title:</label>
          <textarea
            rows="2"
            value={issue.issue}
            onChange={(e) => handleChange("issue", e.target.value)}
          />
        </div>

        <div className="dpo-assign-field">
          <label>Description:</label>
          <textarea
            rows="2"
            value={issue.issue_description}
            onChange={(e) =>
              handleChange("issue_description", e.target.value)
            }
          />
        </div>

        <div className="dpo-assign-form">
        <div className="dpo-assign-field">
          <label>Department:</label>
          <input
            type="text"
            value={issue.department}
            onChange={(e) => handleChange("department", e.target.value)}
          />
        </div>
           
        <div className="dpo-assign-field">
          <label>Priority:</label>
          <select
            value={issue.priority}
            onChange={(e) => handleChange("priority", e.target.value)}
          >
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
        </div>

        <div className="dpo-assign-field">
          <label>Location:</label>
          <input
            type="text"
            value={issue.location}
            onChange={(e) => handleChange("location", e.target.value)}
          />
        </div>

        <div className="dpo-assign-field">
          <label>Deadline:</label>
          <div className="dpo-assign-deadline">
            <input
              type="text"
              placeholder="DD-MM-YYYY"
              value={issue.deadline}
              onChange={(e) =>
                handleChange("deadline", formatDateInput(e.target.value))
              }
            />

            <input
              type="date"
              ref={dateRef}
              style={{ display: "none" }}
              onChange={(e) =>
                handleChange(
                  "deadline",
                  convertDatePickerValue(e.target.value)
                )
              }
            />

            <span
              className="dpo-assign-calendar"
              onClick={() => dateRef.current.showPicker()}
            >
              üìÖ
            </span>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="client/src/index.css">
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}
</file>

<file path="client/src/pages/DPOPage/DPODraftsPage.css">
.dpo-drafts-container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.dpo-drafts-content {
   padding: 31px 70px;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* Prevent page scroll, keep list scroll */
}

.dpo-drafts-title {
  font-size: 2rem;
  font-weight: 700;
  line-height: 1.2;
  margin: 0;
  color: #111827;
}

.dpo-drafts-topbar {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 12px;
  margin: 0;
  padding: 0 0 20px;
  width: 100%;
}

.dpo-drafts-upload-btn {
  border: none;
  border-radius: 10px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  background: #2563eb;
  color: #fff;
  margin-top: 0;
  flex-shrink: 0;
}

.dpo-drafts-upload-btn:hover {
  background: #1d4ed8;
}

.dpo-drafts-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  padding-right: 10px;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 transparent;
}

.dpo-drafts-body::-webkit-scrollbar {
  width: 6px;
}

.dpo-drafts-body::-webkit-scrollbar-track {
  background: transparent;
}

.dpo-drafts-body::-webkit-scrollbar-thumb {
  background-color: #cbd5e1;
  border-radius: 20px;
}

.dpo-drafts-body-upload,
.dpo-drafts-body-assign {
  overflow: hidden;
  padding-right: 0;
}

.dpo-drafts-upload-wrapper {
  display: block;
  width: 100%;
  height: 100%;
  min-height: 0;
  overflow: hidden;
}

.dpo-drafts-upload-wrapper .dpo-upload-form {
  width: 100%;
  max-width: 800px;
  margin: 24px auto 0;
}

.dpo-drafts-upload-wrapper .dpo-loading-card {
  width: 100%;
  max-width: 550px;
  margin: 24px auto 0;
}

.dpo-drafts-assign-wrapper {
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

.dpo-drafts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 18px;
}

.dpo-draft-card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.dpo-draft-card-header h3 {
  margin: 0;
  font-size: 1.05rem;
  color: #111827;
}

.dpo-draft-card-header span {
  display: block;
  margin-top: 4px;
  color: #6b7280;
  font-size: 0.9rem;
}

.dpo-draft-meta p {
  margin: 0;
  font-size: 0.9rem;
  color: #374151;
}

.dpo-draft-actions {
  display: flex;
  gap: 10px;
}

.dpo-draft-actions button {
  border: none;
  border-radius: 8px;
  padding: 9px 12px;
  cursor: pointer;
  font-weight: 600;
  background: #2563eb;
  color: #fff;
}

.dpo-draft-actions .dpo-draft-open-btn {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #2563eb;
  font-size: 22px;
  transition: transform 0.2s ease, color 0.2s ease;
}

.dpo-draft-actions .dpo-draft-open-btn:hover {
  color: #1d4ed8;
  transform: scale(1.15);
}

.dpo-draft-actions .dpo-draft-open-btn svg {
  fill: currentColor;
}

.dpo-draft-actions .dpo-draft-delete-btn {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  margin-left: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #dc2626;
  font-size: 22px;
  transition: transform 0.2s ease, color 0.2s ease;
}

.dpo-draft-actions .dpo-draft-delete-btn:hover {
  color: #b91c1c;
  transform: scale(1.15);
}


.dpo-drafts-body > .empty-state-card,
.dpo-drafts-body > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/DPOPage/DPODraftsPage.jsx">
import React, { useEffect, useState } from "react";
import { useSearchParams } from "react-router-dom";
import DPOHeader from "../../components/DPO/DPOHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import DPOUploadForm from "../../components/DPO/UploadPage/DPOUploadForm";
import DPOAssignIssues from "../../components/DPO/UploadPage/DPOAssignIssues";
import DeleteIcon from "@mui/icons-material/Delete";
import FolderOpenIcon from "@mui/icons-material/FolderOpen";
import { getDrafts, removeDraft } from "../../utils/dpoDrafts";
import "./DPODraftsPage.css";

function DPODraftsPage() {
  const [drafts, setDrafts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchParams, setSearchParams] = useSearchParams();
  const mode = searchParams.get("mode");
  const draftId = searchParams.get("draft");

  useEffect(() => {
    setLoading(true);
    setDrafts(getDrafts());
    setLoading(false);
  }, [searchParams]);

  const handleOpenDraft = (selectedDraftId) => {
    setSearchParams({ draft: selectedDraftId });
  };

  const handleDeleteDraft = (selectedDraftId) => {
    removeDraft(selectedDraftId);
    setDrafts(getDrafts());
  };

  const handleStartUpload = () => {
    setSearchParams({ mode: "upload" });
  };

  const handleUploadProcessed = () => {
    setDrafts(getDrafts());
    setSearchParams({});
  };

  const showListView = !mode && !draftId;

  return (
    <div className="dpo-drafts-container">
      <DPOHeader />

      <div className="dpo-drafts-content">
        {showListView && (
          <div className="dpo-drafts-topbar">
            <h1 className="dpo-drafts-title">Drafts</h1>
            <button className="dpo-drafts-upload-btn" onClick={handleStartUpload}>
              Upload Minutes
            </button>
          </div>
        )}

        <div
          className={`dpo-drafts-body ${mode === "upload" ? "dpo-drafts-body-upload" : ""} ${
            draftId ? "dpo-drafts-body-assign" : ""
          }`}
        >
          {mode === "upload" ? (
            <div className="dpo-drafts-upload-wrapper">
              <DPOUploadForm onProcessed={handleUploadProcessed} />
            </div>
          ) : draftId ? (
            <div className="dpo-drafts-assign-wrapper">
              <DPOAssignIssues draftId={draftId} />
            </div>
          ) : loading ? (
            <LoadingState text="Loading drafts..." />
          ) : drafts.length === 0 ? (
            <EmptyStateCard
              title="No drafts available"
              description="Upload and process a minutes file to create a draft."
            />
          ) : (
            <div className="dpo-drafts-grid">
              {drafts.map((draft) => (
                <div key={draft.id} className="dpo-draft-card">
                  <div className="dpo-draft-card-header">
                    <h3>{draft.title || "Untitled Draft"}</h3>
                    <span>{draft.meetingDate || "No meeting date"}</span>
                  </div>

                  <div className="dpo-draft-meta">
                    <p>
                      <strong>Issues:</strong> {Array.isArray(draft.issues) ? draft.issues.length : 0}
                    </p>
                    <p>
                      <strong>Updated:</strong>{" "}
                      {draft.updatedAt ? new Date(draft.updatedAt).toLocaleString() : "Unknown"}
                    </p>
                  </div>

                  <div className="dpo-draft-actions">
                    <button className="dpo-draft-open-btn" onClick={() => handleOpenDraft(draft.id)} title="Open Draft">
                      <FolderOpenIcon fontSize="medium" sx={{ fill: "#2563eb" }} />
                    </button>
                    <button className="dpo-draft-delete-btn" onClick={() => handleDeleteDraft(draft.id)}>
                         <DeleteIcon fontSize="medium" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default DPODraftsPage;
</file>

<file path="client/src/utils/authStorage.js">
const AUTH_KEYS = ["token", "username", "role", "department"];

export function getAuthValue(key) {
  return sessionStorage.getItem(key) || localStorage.getItem(key);
}

export function setAuthValue(key, value) {
  if (value == null) return;
  sessionStorage.setItem(key, value);
}

export function clearAuthValues() {
  AUTH_KEYS.forEach((key) => {
    sessionStorage.removeItem(key);
    localStorage.removeItem(key);
  });
}

export function migrateLocalAuthToSession() {
  AUTH_KEYS.forEach((key) => {
    const v = localStorage.getItem(key);
    if (v && !sessionStorage.getItem(key)) {
      sessionStorage.setItem(key, v);
    }
  });
}
</file>

<file path="client/src/utils/dpoDrafts.js">
const DPO_DRAFTS_KEY = "dpo_issue_drafts";

function readDrafts() {
  try {
    const raw = localStorage.getItem(DPO_DRAFTS_KEY);
    const parsed = raw ? JSON.parse(raw) : [];
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

function writeDrafts(drafts) {
  localStorage.setItem(DPO_DRAFTS_KEY, JSON.stringify(drafts));
}

export function getDrafts() {
  return readDrafts().sort((a, b) => {
    const aTime = new Date(a.updatedAt || a.createdAt || 0).getTime();
    const bTime = new Date(b.updatedAt || b.createdAt || 0).getTime();
    return bTime - aTime;
  });
}

export function getDraftById(draftId) {
  return readDrafts().find((d) => d.id === draftId) || null;
}

export function saveDraft(draft) {
  const drafts = readDrafts();
  const now = new Date().toISOString();
  const idx = drafts.findIndex((d) => d.id === draft.id);

  const normalized = {
    ...draft,
    createdAt: draft.createdAt || now,
    updatedAt: now,
  };

  if (idx >= 0) {
    drafts[idx] = normalized;
  } else {
    drafts.push(normalized);
  }

  writeDrafts(drafts);
  return normalized;
}

export function removeDraft(draftId) {
  const drafts = readDrafts().filter((d) => d.id !== draftId);
  writeDrafts(drafts);
}
</file>

<file path="client/src/utils/liveUpdates.js">
export const LIVE_EVENT_ISSUES_UPDATED = "minutes-tracker:issues-updated";
export const LIVE_EVENT_NOTIFICATIONS_UPDATED = "minutes-tracker:notifications-updated";
const LIVE_EVENT_ISSUES_UPDATED_KEY = "minutes-tracker:issues-updated:key";
const LIVE_EVENT_NOTIFICATIONS_UPDATED_KEY = "minutes-tracker:notifications-updated:key";

const KEY_BY_EVENT = {
  [LIVE_EVENT_ISSUES_UPDATED]: LIVE_EVENT_ISSUES_UPDATED_KEY,
  [LIVE_EVENT_NOTIFICATIONS_UPDATED]: LIVE_EVENT_NOTIFICATIONS_UPDATED_KEY,
};

function emitCrossTab(eventName, payload) {
  const key = KEY_BY_EVENT[eventName];
  if (!key) return;
  try {
    localStorage.setItem(
      key,
      JSON.stringify({ ts: Date.now(), payload: payload || {} })
    );
  } catch {
    // Ignore storage errors; same-tab custom event still works.
  }
}

export function emitIssuesUpdated(payload = {}) {
  window.dispatchEvent(new CustomEvent(LIVE_EVENT_ISSUES_UPDATED, { detail: payload }));
  emitCrossTab(LIVE_EVENT_ISSUES_UPDATED, payload);
}

export function emitNotificationsUpdated(payload = {}) {
  window.dispatchEvent(new CustomEvent(LIVE_EVENT_NOTIFICATIONS_UPDATED, { detail: payload }));
  emitCrossTab(LIVE_EVENT_NOTIFICATIONS_UPDATED, payload);
}

export function addLiveEventListener(eventName, handler) {
  const key = KEY_BY_EVENT[eventName];
  const customHandler = (evt) => handler(evt);
  const storageHandler = (evt) => {
    if (!key || evt.key !== key || !evt.newValue) return;
    try {
      const parsed = JSON.parse(evt.newValue);
      handler({ detail: parsed?.payload || {} });
    } catch {
      handler({ detail: {} });
    }
  };

  window.addEventListener(eventName, customHandler);
  window.addEventListener("storage", storageHandler);

  return () => {
    window.removeEventListener(eventName, customHandler);
    window.removeEventListener("storage", storageHandler);
  };
}
</file>

<file path="ENV_SETUP_GUIDE.md">
# Environment Setup Guide

## Overview
This project uses environment variables to manage sensitive credentials and configuration. All sensitive data is now stored in a `.env` file instead of being hardcoded in the source code.

## Setup Instructions

### 1. Backend Setup

#### Step 1: Copy the example file
```bash
cd backend
cp .env.example .env
```

#### Step 2: Fill in your credentials in `.env`
Edit `backend/.env` and add your actual values:

```env
# Required: Google Gemini API Key
GOOGLE_API_KEY=your_google_gemini_api_key_here

# Database Configuration (Already filled with Supabase credentials)
DB_ENGINE=django.db.backends.postgresql
DB_NAME=postgres
DB_USER=postgres.oiscsacsglwideokczhm
DB_PASSWORD=agnayarjunibrukeerthi
DB_HOST=aws-1-ap-south-1.pooler.supabase.com
DB_PORT=5432
DB_SSL_MODE=require

# Django Configuration
DJANGO_SECRET_KEY=your_secret_key_here  # Change this for production
DEBUG=True  # Set to False in production
ALLOWED_HOSTS=localhost,127.0.0.1  # Add your production domain

# Email Configuration (Optional if using email features)
EMAIL_HOST_USER=a27423001@smtp-brevo.com
EMAIL_HOST_PASSWORD=smtp_key_here
DEFAULT_FROM_EMAIL=me.openbox@gmail.com

# CORS Configuration
CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
```

#### Step 3: Verify python-dotenv is installed
```bash
pip install python-dotenv
```

It should already be in your `requirements.txt`. If upgrading, run:
```bash
pip install -r requirements.txt
```

### 2. What Changed

#### Files Modified:
1. **`backend/api/gemini_utils.py`**
   - Now loads `GOOGLE_API_KEY` from `.env` instead of hardcoded empty string
   - Added `from dotenv import load_dotenv`

2. **`backend/backend/settings.py`**
   - All sensitive settings now use `os.getenv()` to read from `.env`
   - Includes: `DJANGO_SECRET_KEY`, database credentials, email settings, CORS origins
   - Added `from dotenv import load_dotenv` and `load_dotenv()` at the top

#### New Files:
- **`backend/.env`** - Your actual configuration (DO NOT commit)
- **`backend/.env.example`** - Template for team members (safe to commit)

### 3. Security Best Practices

‚úÖ **What you've improved:**
- API keys are no longer in source code
- Database credentials are in `.env` (not tracked by git)
- Email passwords are protected
- Different environments can have different configs

‚ö†Ô∏è **Still TODO for production:**
1. Generate a strong `DJANGO_SECRET_KEY`
2. Set `DEBUG=False` in production
3. Update `ALLOWED_HOSTS` with your production domain
4. Use environment-specific `.env` files for staging/production
5. Never share your `.env` file with anyone
6. Rotate API keys periodically

### 4. Running the Project

```bash
# Backend
cd backend
source venv/Scripts/Activate.ps1  # On Windows PowerShell
python manage.py runserver

# Frontend (in new terminal)
cd client
npm run dev
```

### 5. For Team Members

1. Ask for the production `.env` credentials via secure channel
2. Create your own `.env` file based on `.env.example`
3. Never commit the `.env` file to git

### 6. Environment Variables Reference

| Variable | Purpose | Example |
|----------|---------|---------|
| `GOOGLE_API_KEY` | Gemini AI API Key | `AIzaSyD...` |
| `DB_NAME` | Database name | `postgres` |
| `DB_USER` | Database user | `postgres.abc...` |
| `DB_PASSWORD` | Database password | `yourpassword` |
| `DB_HOST` | Database host | `aws-1-ap-south-1...` |
| `DJANGO_SECRET_KEY` | Django secret key | `your-secret-key` |
| `DEBUG` | Debug mode | `True` or `False` |
| `EMAIL_HOST_USER` | SMTP username | `user@smtp-brevo.com` |
| `EMAIL_HOST_PASSWORD` | SMTP password | `smtp_key...` |

---

**Note:** The `.env` file is listed in `.gitignore` and will NOT be committed to the repository.
</file>

<file path="package.json">
{
  "name": "client",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "@emotion/react": "^11.14.0",
    "@emotion/styled": "^11.14.1",
    "@mui/icons-material": "^7.3.4",
    "@mui/material": "^7.3.4",
    "@testing-library/dom": "^10.4.1",
    "@testing-library/jest-dom": "^6.9.1",
    "@testing-library/react": "^16.3.0",
    "@testing-library/user-event": "^13.5.0",
    "axios": "^1.13.2",
    "react": "^19.2.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.9.5",
    "react-scripts": "5.0.1",
    "web-vitals": "^2.1.4"
  },
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  }
}
</file>

<file path="README.md">
# Getting Started with Create React App

This project was bootstrapped with [Create React App](https://github.com/facebook/create-react-app).

## Available Scripts

In the project directory, you can run:

### `npm start`

Runs the app in the development mode.\
Open [http://localhost:3000](http://localhost:3000) to view it in your browser.

The page will reload when you make changes.\
You may also see any lint errors in the console.

### `npm test`

Launches the test runner in the interactive watch mode.\
See the section about [running tests](https://facebook.github.io/create-react-app/docs/running-tests) for more information.

### `npm run build`

Builds the app for production to the `build` folder.\
It correctly bundles React in production mode and optimizes the build for the best performance.

The build is minified and the filenames include the hashes.\
Your app is ready to be deployed!

See the section about [deployment](https://facebook.github.io/create-react-app/docs/deployment) for more information.

### `npm run eject`

**Note: this is a one-way operation. Once you `eject`, you can't go back!**

If you aren't satisfied with the build tool and configuration choices, you can `eject` at any time. This command will remove the single build dependency from your project.

Instead, it will copy all the configuration files and the transitive dependencies (webpack, Babel, ESLint, etc) right into your project so you have full control over them. All of the commands except `eject` will still work, but they will point to the copied scripts so you can tweak them. At this point you're on your own.

You don't have to ever use `eject`. The curated feature set is suitable for small and middle deployments, and you shouldn't feel obligated to use this feature. However we understand that this tool wouldn't be useful if you couldn't customize it when you are ready for it.

## Learn More

You can learn more in the [Create React App documentation](https://facebook.github.io/create-react-app/docs/getting-started).

To learn React, check out the [React documentation](https://reactjs.org/).

### Code Splitting

This section has moved here: [https://facebook.github.io/create-react-app/docs/code-splitting](https://facebook.github.io/create-react-app/docs/code-splitting)

### Analyzing the Bundle Size

This section has moved here: [https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size](https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size)

### Making a Progressive Web App

This section has moved here: [https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app](https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app)

### Advanced Configuration

This section has moved here: [https://facebook.github.io/create-react-app/docs/advanced-configuration](https://facebook.github.io/create-react-app/docs/advanced-configuration)

### Deployment

This section has moved here: [https://facebook.github.io/create-react-app/docs/deployment](https://facebook.github.io/create-react-app/docs/deployment)

### `npm run build` fails to minify

This section has moved here: [https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify](https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify)
# Minutes_Tracker_System
</file>

<file path="vite.config.js">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    open: true
  }
})
</file>

<file path="backend/api/admin.py">
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import (
    User,
    Department,
    Minutes,
    Issue,
    IssueDepartment,
    Response,
    Notification
)


@admin.register(User)
class CustomUserAdmin(UserAdmin):
    model = User

    list_display = ("username", "role", "department", "is_staff")
    list_filter = ("role", "is_staff")

    fieldsets = UserAdmin.fieldsets + (
        ("Extra Info", {"fields": ("role", "department")}),
    )

    add_fieldsets = UserAdmin.add_fieldsets + (
        ("Extra Info", {"fields": ("role", "department")}),
    )

    search_fields = ("username",)
    ordering = ("username",)


admin.site.register(Department)
admin.site.register(Minutes)
admin.site.register(Issue)
admin.site.register(IssueDepartment)
admin.site.register(Response)
admin.site.register(Notification)
</file>

<file path="backend/api/migrations/0001_initial.py">
# Generated by Django 6.0 on 2026-01-04 15:28

import django.contrib.auth.models
import django.contrib.auth.validators
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        migrations.CreateModel(
            name='Department',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('dept_name', models.CharField(max_length=100, unique=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
        migrations.CreateModel(
            name='Issue',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('issue_title', models.CharField(max_length=200)),
                ('issue_description', models.TextField(default='')),
                ('location', models.CharField(max_length=200)),
                ('priority', models.CharField(choices=[('LOW', 'Low'), ('MEDIUM', 'Medium'), ('HIGH', 'High')], max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
                ('first_name', models.CharField(blank=True, max_length=150, verbose_name='first name')),
                ('last_name', models.CharField(blank=True, max_length=150, verbose_name='last name')),
                ('email', models.EmailField(blank=True, max_length=254, verbose_name='email address')),
                ('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
                ('is_active', models.BooleanField(default=True, help_text='Designates whether this user should be treated as active. Unselect this instead of deleting accounts.', verbose_name='active')),
                ('date_joined', models.DateTimeField(default=django.utils.timezone.now, verbose_name='date joined')),
                ('role', models.CharField(choices=[('DPO', 'DPO'), ('COLLECTOR', 'Collector'), ('DEPT', 'Department')], max_length=20)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
                ('department', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='api.department')),
            ],
            options={
                'verbose_name': 'user',
                'verbose_name_plural': 'users',
                'abstract': False,
            },
            managers=[
                ('objects', django.contrib.auth.models.UserManager()),
            ],
        ),
        migrations.CreateModel(
            name='IssueDepartment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('deadline_date', models.DateField()),
                ('status', models.CharField(choices=[('PENDING', 'Pending'), ('COMPLETED', 'Completed'), ('OVERDUE', 'Overdue')], max_length=20)),
                ('department', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='api.department')),
                ('issue', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='api.issue')),
            ],
        ),
        migrations.CreateModel(
            name='Minutes',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200)),
                ('meeting_date', models.DateField()),
                ('file_path', models.FileField(upload_to='minutes/')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('uploaded_by', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='uploaded_minutes', to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.AddField(
            model_name='issue',
            name='minutes',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='issues', to='api.minutes'),
        ),
        migrations.CreateModel(
            name='Notification',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('message', models.TextField()),
                ('is_read', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('issue_department', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='api.issuedepartment')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='Response',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('response_text', models.TextField()),
                ('attachment_path', models.FileField(blank=True, null=True, upload_to='responses/')),
                ('submitted_at', models.DateTimeField(auto_now_add=True)),
                ('issue_department', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='responses', to='api.issuedepartment')),
            ],
        ),
    ]
</file>

<file path="client/index.html">
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DISTRICT DEVELOPMENT COUNCIL MINUTES MANAGEMENT SYSTEM</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="client/src/api/axios.js">
import axios from "axios";
import { getAuthValue, migrateLocalAuthToSession } from "../utils/authStorage";

const api = axios.create({
  baseURL: "http://127.0.0.1:8000",
});

// Backward compatibility for already logged-in users from older builds.
migrateLocalAuthToSession();

// Automatically attach token to every request
api.interceptors.request.use(
  (config) => {
    const token = getAuthValue("token");
    if (token) {
      config.headers.Authorization = `Token ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

export default api;
</file>

<file path="client/src/components/Collector/IssuePage/CollectorFilterBar.css">
.collector-filter-bar {
  display: flex;
  gap: 15px;
  align-items: center;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  /* margin-bottom: 20px; */
  flex-wrap: wrap;
  position: relative; /* positioning context for floating buttons */
}
.collector-filter-bar {
  transition: all 0.2s ease;
}

.collector-search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  flex: 1;
  min-width: 200px;
  max-width: 400px;
}

.collector-search-wrapper input {
  padding: 10px 35px 10px 35px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 100%;
}

.collector-search-icon {
  position: absolute;
  left: 10px;
  user-select: none;
}

.collector-date-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.collector-date-input-wrapper input {
  padding: 10px 35px 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
}

.collector-calendar-icon {
  position: absolute;
  right: 10px;
  font-size: 1rem;
  color: #666;
  cursor: pointer;
  user-select: none;
}

.collector-filter-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.collector-filter-group label {
  color: #000;
  font-size: 0.9rem;
  min-width: 60px;
}

.collector-filter-select {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
  color: #000;
  background: white;
}

.collector-filter-btn {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
  background: white;
  color: #000;
  cursor: pointer;
  text-align: left;
}

.collector-generate-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
  margin-left: auto;
}

.collector-generate-btn:hover {
  background: #1d4ed8;
}

.collector-upload-btn {
  position: absolute;
  right: 12px;
  top: -18px;
  z-index: 20;
  background: #10b981;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 6px 12px rgba(16, 185, 129, 0.12);
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.collector-upload-btn img {
  width: 14px;
  height: 14px;
}

.collector-upload-btn:hover {
  background: #059669;
}

/* ================= CUSTOM FILTER DROPDOWN ================= */

.collector-custom-filter,
.collector-filter-dropdown {
  position: relative;
}

/* Dropdown Menu */
.collector-filter-menu {
  display: none;
  position: absolute;
  top: 39px;
  left: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
  z-index: 50;
}

.collector-filter-dropdown:hover .collector-filter-menu {
  display: block;
}

/* Dropdown Items */
.collector-filter-item {
  padding: 10px 12px;
  cursor: pointer;
  position: relative;
  white-space: nowrap;
}

.collector-filter-item:hover {
  background: #f3f4f6;
}

/* ================= SUB MENU ================= */

.collector-sub-menu {
  display: none;
  position: absolute;
  top: 0;
  left: 100%;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}

.collector-filter-item:hover .collector-sub-menu {
  display: block;
}

.collector-sub-menu div {
  padding: 10px 12px;
  cursor: pointer;
}

.collector-sub-menu div:hover {
  background: #e5e7eb;
}
</file>

<file path="client/src/components/Collector/IssuePage/CollectorGenerateReportCard.jsx">
import React from "react";

const GenerateReportCard = React.memo(function GenerateReportCard({
  report,
  index,
  handleChange,
  removeCard,
}) {
  return (
    <div className="collector-generate-report-card">
      <div className="collector-report-top">
        <div className="collector-report-id">{report.issue_no}</div>
        <button className="collector-report-delete-btn" onClick={() => removeCard(index)}>
          üóëÔ∏è
        </button>
      </div>

      <div className="collector-report-form">
        <div className="collector-form-field">
          <label>Department:</label>
          <input
            type="text"
            value={report.department}
            onChange={e => handleChange(index, "department", e.target.value)}
          />
        </div>

        <div className="collector-form-field">
          <label>Issue:</label>
          <textarea
            value={report.issue}
            onChange={e => handleChange(index, "issue", e.target.value)}
            rows="3"
          />
        </div>
        <div className="collector-form-field">
          <label>Description:</label>
          <textarea
            rows="2"
            value={report.issue_description}
            onChange={(e) => handleChange(index, "issue_description", e.target.value)}
          />
        </div>

        <div className="collector-form-field">
          <label>Response:</label>
          <textarea
            value={report.response || ""}
            onChange={e => handleChange(index, "response", e.target.value)}
            rows="3"
          />
        </div>

        <div className="collector-form-field">
          <label>Location:</label>
          <input
            type="text"
            value={report.location}
            onChange={e => handleChange(index, "location", e.target.value)}
          />
        </div>
      </div>
    </div>
  );
});

export default GenerateReportCard;
</file>

<file path="client/src/components/Collector/IssuePage/CollectorGenerateReports.css">
/* ==============================
   Main Container
============================== */
.collector-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.collector-generate-reports-container { 
  background: #fff; 
  border-radius: 14px; 
  padding: 30px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06); 
  margin: 0 auto;     /* ‚úÖ CENTERED */
  font-family: "Inter", sans-serif; 
  display: flex; 
  flex-direction: column;
  max-height: 480px;
  width: 800px;
}


/* ==============================
   Header
============================== */
.collector-generate-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 15px; 
}

.collector-close-btn {
  margin-left: auto;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #555;
  transition: color 0.2s ease;
}

.collector-close-btn:hover {
  color: #000;
}

/* ==============================
   Report List
============================== */
.collector-report-list { 
  flex: 1; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 20px; 
  padding-right: 4px; 
}

.collector-report-list::-webkit-scrollbar { 
  width: 8px; 
}

.collector-report-list::-webkit-scrollbar-thumb { 
  background: #cbd5e1; 
  border-radius: 6px; 
}

.collector-report-list::-webkit-scrollbar-thumb:hover { 
  background: #94a3b8; 
}

/* ==============================
   Report Card Layout
============================== */
.collector-generate-report-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  background-color: #f9fafb;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  transition: box-shadow 0.2s ease;
}

.collector-generate-report-card:hover {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
}

/* ==============================
   Report Top Section
============================== */
.collector-report-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 2px;
}

.collector-report-id {
  font-weight: 600;
  color: #111827;
  font-size: 15px;
}

.collector-report-delete-btn {
  background: none;
  border: none;
  color: #b91c1c;
  font-size: 18px;
  cursor: pointer;
  transition: transform 0.2s ease, color 0.2s ease;
}

.collector-report-delete-btn:hover {
  color: #991b1b;
  transform: scale(1.15);
}

/* ==============================
   Report Form
============================== */
.collector-report-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.collector-form-field {
  display: flex;
  flex-direction: column;
}

.collector-form-field label {
  color: #374151;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
}

.collector-form-field input,
.collector-form-field select {
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 14px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.collector-form-field textarea {
  resize: none;
  height: 70px;
  min-height: 70px;
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.4;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.collector-form-field input:focus,
.collector-form-field select:focus,
.collector-form-field textarea:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

/* ==============================
   Format Toggle
============================== */
.collector-format-toggle {
  display: flex;
  gap: 10px;
}

.collector-format-btn {
  padding: 6px 14px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background-color: #f3f4f6;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s ease, color 0.2s ease;
}

.collector-format-btn:hover {
  background-color: #e5e7eb;
}

.collector-format-btn.collector-active {
  background-color: #2563eb;
  color: #fff;
  border-color: #2563eb;
}

/* ==============================
   Download Button Section
============================== */
.collector-download-section {
  display: flex;
  align-items: center; 
  justify-content: flex-end; 
  height: 4px; 
  margin-top: 25px;  
  margin-right: 10px;
}

.collector-generate-download-btn {
  background-color: #2563eb;
  color: white;
  border: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.collector-generate-download-btn:hover {
  background-color: #1d4ed8;
}
.collector-close{
    background: none;
  border: none;
  font-size: 22px;
  color: #6b7280;
  cursor: pointer;
}
</file>

<file path="client/src/components/Collector/IssuePage/CollectorIssueCard.css">
.collector-issue-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
  padding: 20px;
  margin-top: 10px;
  border-left: 5px solid #facc15;
  /* default yellow for pending */
}

.collector-issue-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.collector-issue-id {
  font-weight: 600;
  font-size: 1rem;
}

.collector-status {
  font-size: 0.8rem;
  padding: 5px 10px;
  border-radius: 12px;
  font-weight: 500;
  text-transform: capitalize;
}

/* üî∏ Color Variations */
.collector-status.collector-pending {
  background: #fef9c3;
  /* light yellow */
  color: #854d0e;
  /* dark yellow text */
}

.collector-status.collector-overdue {
  background: #fee2e2;
  /* light red */
  color: #b91c1c;
  /* dark red text */
}

.collector-status.collector-received {
  background: #dcfce7;
  /* light green */
  color: #166534;
  /* dark green text */
}

.collector-issue-body p {
  margin: 4px 0;
  font-size: 0.9rem;
  color: #000000;
}

.collector-issue-row {
  display: flex;
  align-items: flex-start;
  margin: 6px 0;
  font-size: 0.9rem;
  color: #000;
}

.collector-issue-row .collector-label {
  width: 120px;
  /* fixed width for alignment */
  font-weight: 600;
  color: #000;
  text-align: left;
  /* left align text */
  position: relative;
  padding-right: 8px;
}

/* Adds colon after label, spaced properly */
.collector-issue-row .collector-label::after {
  content: ":";
  position: absolute;
  right: 0;
}

/* value text starts right after colon */
.collector-issue-row .collector-value {
  flex: 1;
  padding-left: 12px;
  margin-top: 6px;
}

/* üî¥ Overdue text color */
.collector-overdue-text {
  color: #b91c1c !important;
  /* same red as your border */
  font-weight: 600;
}

.collector-footer-line {
  height: 1px;
  /* background: #16a34a; */
  background: #888;
  margin-top: 30px;
}

.collector-issue-footer {
  margin-top: 12px;
}

.collector-no-response {
  margin: 10px 0 0;
  font-size: 0.9rem;
  color: #4b5563;
}

.collector-response-received {
  position: relative;
  background-color: #dcfce5;
  height: auto;
}

.collector-res {
  margin-left: 5px;
  /* padding-top: 10px; */
}

.collector-res-button {
  position: absolute;
  right: 12px;
  bottom: 12px;
  /* keep the button a little above the bottom */
  background: #19A752;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.collector-issue-card {
  opacity: 0;
  animation: fadeInCard 0.3s ease forwards;
}

@keyframes fadeInCard {
  from {
    opacity: 0;
    transform: translateY(4px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}
/* üîπ Log Button Bottom Right */
.collector-log-btn {
  position: absolute;
  right: 15px;
  bottom: 10px;
  background: #2563eb;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}

.collector-issue-card {
  position: relative; /* important */
}

/* üîπ Modal */
.collector-log-overlay {
  position: fixed;
  inset: 0;
  z-index: 1000;
}

.collector-log-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
}

.collector-log-modal {
  position: relative;
  background: white;
  width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  margin: 80px auto;
  border-radius: 10px;
  padding: 20px;
  z-index: 1001;
}

.collector-log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.collector-log-close {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

.collector-log-entry {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.collector-log-dot {
  width: 10px;
  height: 10px;
  background: #2563eb;
  border-radius: 50%;
  margin-top: 6px;
}

.collector-log-msg {
  font-size: 0.85rem;
  color: #444;
}
</file>

<file path="client/src/components/Collector/IssuePage/CollectorIssueCard.jsx">
import React, { useState } from "react";
import "./CollectorIssueCard.css";
import api from "../../../api/axios";

function IssueCard({ issue }) {
  const [showLog, setShowLog] = useState(false);

  const rawStatus = issue.status || "pending";
  const normalizedStatus =
    rawStatus === "submitted" ? "received" : rawStatus;

  const responses = Array.isArray(issue.response)
    ? issue.response
    : [];

  const getStatusStyle = () => {
    switch (normalizedStatus) {
      case "overdue":
        return { borderColor: "#b91c1c" };
      case "received":
        return { borderColor: "#16a34a" };
      default:
        return { borderColor: "#facc15" };
    }
  };

  // üîπ BUILD TIMELINE
  const buildTimeline = () => {
    let timeline = [];

    // Issue Created
    if (issue.created_at) {
      timeline.push({
        type: "Created",
        text: "Issue Raised",
        date: issue.created_at,
      });
    }

    // Reuploads
    if (issue.reuploads && issue.reuploads.length > 0) {
      issue.reuploads.forEach((item) => {
        timeline.push({
          type: "Reupload",
          text: "Issue Re-uploaded",
          date: item.date,
        });
      });
    }

    // Responses
    if (responses.length > 0) {
      responses.forEach((resObj) => {
        timeline.push({
          type: "Response",
          text: `${resObj.department} responded`,
          date: resObj.date,
          message: resObj.text,
        });
      });
    }

    // Sort by date
    timeline.sort((a, b) => new Date(a.date) - new Date(b.date));

    return timeline;
  };

  const timeline = buildTimeline();

  return (
    <>
      <div
        className="collector-issue-card"
        style={getStatusStyle()}
      >
        <div className="collector-issue-header">
          <span className="collector-issue-id">
            {issue.issue_no}
          </span>
          <span
            className={`collector-status collector-${normalizedStatus}`}
          >
            {normalizedStatus}
          </span>
        </div>

        <div className="collector-issue-row">
          <div className="collector-label">Issue</div>
          <div className="collector-value">
            {issue.issue}
          </div>
        </div>

        <div className="collector-issue-row">
          <div className="collector-label">
            Description
          </div>
          <div className="collector-value">
            {issue.issue_description}
          </div>
        </div>

        <div className="collector-issue-body">
          <div className="collector-issue-row">
            <div className="collector-label">
              Department
            </div>
            <div className="collector-value">
              {issue.department}
            </div>
          </div>

          <div className="collector-issue-row">
            <div className="collector-label">
              Priority
            </div>
            <div className="collector-value">
              {issue.priority}
            </div>
          </div>

          <div className="collector-issue-row">
            <div className="collector-label">
              Location
            </div>
            <div className="collector-value">
              {issue.location}
            </div>
          </div>

          <div className="collector-issue-row">
            <div
              className={`collector-label ${
                normalizedStatus === "overdue"
                  ? "collector-overdue-text"
                  : ""
              }`}
            >
              Deadline
            </div>
            <div
              className={`collector-value ${
                normalizedStatus === "overdue"
                  ? "collector-overdue-text"
                  : ""
              }`}
            >
              {issue.deadline}
            </div>
          </div>
        </div>

        <div className="collector-issue-footer">
          <div className="collector-footer-line"></div>

          {normalizedStatus === "pending" &&
            responses.length === 0 && (
              <p className="collector-no-response">
                No response received yet
              </p>
            )}

          {normalizedStatus === "overdue" && (
            <p className="collector-no-response">
              Response overdue ‚ö†Ô∏è
            </p>
          )}

          {responses.length > 0 && (
            <div
              className="collector-response-container"
              style={{ marginTop: "10px" }}
            >
              {responses.map((resObj, index) => (
                <div
                  key={index}
                  className="collector-response-received"
                >
                  <p className="collector-res">
                    <strong>
                      {resObj.department}:
                    </strong>{" "}
                    {resObj.text}
                  </p>

                  {resObj.attachment && (
                    <button
                      className="collector-res-button"
                      onClick={() => {
                        const baseUrl =
                          api.defaults.baseURL;
                        const fullUrl =
                          resObj.attachment.startsWith(
                            "http"
                          )
                            ? resObj.attachment
                            : `${baseUrl}${resObj.attachment}`;
                        window.open(fullUrl, "_blank");
                      }}
                    >
                      Download Attachment
                    </button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* üîπ LOG BUTTON BOTTOM RIGHT */}
          <button
            className="collector-log-btn"
            onClick={() => setShowLog(true)}
          >
            Log
          </button>
        </div>
      </div>

      {/* üîπ LOG MODAL */}
      {showLog && (
        <div className="collector-log-overlay">
          <div
            className="collector-log-backdrop"
            onClick={() => setShowLog(false)}
          ></div>

          <div className="collector-log-modal">
            <div className="collector-log-header">
              <h3>
                Issue Log - {issue.issue_no}
              </h3>
              <button
                className="collector-log-close"
                onClick={() => setShowLog(false)}
              >
                ‚úï
              </button>
            </div>

            <div className="collector-log-body">
              {timeline.length === 0 ? (
                <p>No log history available</p>
              ) : (
                timeline.map((item, index) => (
                  <div
                    key={index}
                    className="collector-log-entry"
                  >
                    <div className="collector-log-dot"></div>
                    <div>
                      <strong>{item.text}</strong>
                      <p>{item.date}</p>
                      {item.message && (
                        <p className="collector-log-msg">
                          {item.message}
                        </p>
                      )}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      )}
    </>
  );
}

export default IssueCard;
</file>

<file path="client/src/components/Collector/IssuePage/CollectorTabs.css">
.collector-tabs-container {
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.collector-tabs {
  display: flex;
  gap: 15px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}

.collector-tab {
  padding: 10px 20px;
  cursor: pointer;
  font-weight: 500;
  color: #000;
}

.collector-tab.collector-active {
  border-bottom: 3px solid #007bff;
  color: #007bff;
}

.collector-tab-scroll-area {
  flex: 1;
  overflow-y: auto;
  /* max-height removed */
  padding-right: 10px;
  scrollbar-width: thin;
}

.collector-tab {
  transition: background-color 0.2s ease, color 0.2s ease;
}
</file>

<file path="client/src/components/Collector/IssuePage/CollectorTabs.jsx">
import React from "react";
import "./CollectorTabs.css";

function Tabs({ activeTab, setActiveTab }) {
  const tabs = ["Pending", "Overdue", "Received"];

  return (
    <div className="collector-tabs-container">
      <div className="collector-tabs">
        {tabs.map((tab) => (
          <div
            key={tab}
            className={`collector-tab ${activeTab === tab ? "collector-active" : ""}`}
            onClick={() => setActiveTab(tab)}
          >
            {tab}
          </div>
        ))}
      </div>
    </div>
  );
}

export default Tabs;
</file>

<file path="client/src/components/Department/DepartmentFilterBar.css">
.department-filter-bar {
  display: flex;
  gap: 15px;
  align-items: center;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  margin-bottom: 20px;
  flex-wrap: wrap;
  position: relative; /* positioning context for floating buttons */
}

.department-filter-bar {
  transition: all 0.2s ease;
}

.department-search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  flex: 1;
  min-width: 200px;
  max-width: 400px;
}

.department-search-wrapper input {
  padding: 10px 35px 10px 35px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 100%;
}

.department-search-icon {
  position: absolute;
  left: 10px;
  user-select: none;
}

.department-date-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.department-date-input-wrapper input {
  padding: 10px 35px 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
}

.department-calendar-icon {
  position: absolute;
  right: 10px;
  font-size: 1rem;
  color: #666;
  cursor: pointer;
  user-select: none;
}

.department-filter-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.department-filter-group label {
  color: #000;
  font-size: 0.9rem;
  min-width: 60px;
}

.department-filter-select {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
  color: #000;
  background: white;
}

.department-filter-btn {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
  background: white;
  color: #000;
  cursor: pointer;
  text-align: left;
}

.department-generate-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
  margin-left: auto;
}

.department-generate-btn:hover {
  background: #1d4ed8;
}

.department-upload-btn {
  position: absolute;
  right: 12px;
  top: -18px;
  z-index: 20;
  background: #10b981;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 6px 12px rgba(16, 185, 129, 0.12);
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.department-upload-btn img {
  width: 14px;
  height: 14px;
}

.department-upload-btn:hover {
  background: #059669;
}

/* ================= CUSTOM FILTER DROPDOWN ================= */

.department-custom-filter,
.department-filter-dropdown {
  position: relative;
}

/* Dropdown Menu */
.department-filter-menu {
  display: none;
  position: absolute;
  top: 39px;
  left: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
  z-index: 50;
}

.department-filter-dropdown:hover .department-filter-menu {
  display: block;
}

/* Dropdown Items */
.department-filter-item {
  padding: 10px 12px;
  cursor: pointer;
  position: relative;
  white-space: nowrap;
}

.department-filter-item:hover {
  background: #f3f4f6;
}

/* ================= SUB MENU ================= */

.department-sub-menu {
  display: none;
  position: absolute;
  top: 0;
  left: 100%;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}

.department-filter-item:hover .department-sub-menu {
  display: block;
}

.department-sub-menu div {
  padding: 10px 12px;
  cursor: pointer;
}

.department-sub-menu div:hover {
  background: #e5e7eb;
}
</file>

<file path="client/src/components/Department/DepartmentFilterBar.jsx">
import React, { useState, useEffect, useRef } from "react";
import "./DepartmentFilterBar.css";

function DepartmentFilterBar({ activeTab, onFilterChange, issue_date }) {
  const [date, setDate] = useState("");
  const [filterBy, setFilterBy] = useState("all");
  const [sortBy, setSortBy] = useState("newest");
  const [searchQuery, setSearchQuery] = useState("");

  const datePickerRef = useRef(null);

  // Set initial date from parent
  useEffect(() => {
    if (issue_date) setDate(issue_date);
  }, [issue_date]);

  // Format dd-mm-yyyy manually
  const formatDateInput = (raw) => {
    const digits = raw.replace(/\D/g, "").slice(0, 8);
    if (digits.length <= 2) return digits;
    if (digits.length <= 4)
      return `${digits.slice(0, 2)}-${digits.slice(2)}`;
    return `${digits.slice(0, 2)}-${digits.slice(2, 4)}-${digits.slice(4)}`;
  };

  // Helper to notify parent
  const updateFilters = (updated) => {
    onFilterChange({
      date,
      filterBy,
      sortBy,
      searchQuery,
      ...updated,
    });
  };

  const handleDateChange = (e) => {
    const formatted = formatDateInput(e.target.value);
    setDate(formatted);
    updateFilters({ date: formatted });
  };

  const handleDatePick = (e) => {
    const [yyyy, mm, dd] = e.target.value.split("-");
    if (dd && mm && yyyy) {
      const formatted = `${dd}-${mm}-${yyyy}`;
      setDate(formatted);
      updateFilters({ date: formatted });
    }
  };

  return (
    <div className="department-filter-bar">

      {/* Search Box */}
      <div className="department-search-wrapper">
        <span className="department-search-icon">üîç</span>
        <input
          type="text"
          placeholder="Search issues..."
          value={searchQuery}
          onChange={(e) => {
            setSearchQuery(e.target.value);
            updateFilters({ searchQuery: e.target.value });
          }}
        />
      </div>

      {/* Date Input */}
      <div className="department-date-input-wrapper">
        <input
          type="text"
          placeholder="dd-mm-yyyy"
          value={date}
          onChange={handleDateChange}
        />

        <span
          className="department-calendar-icon"
          onClick={() => datePickerRef.current.showPicker()}
        >
          üìÖ
        </span>

        <input
          type="date"
          ref={datePickerRef}
          onChange={handleDatePick}
          style={{ visibility: "hidden", position: "absolute" }}
        />
      </div>

      {/* Filter By */}
      <div className="department-filter-group">
        <label>Filter By:</label>
        <select
          value={filterBy}
          onChange={(e) => {
            setFilterBy(e.target.value);
            updateFilters({ filterBy: e.target.value });
          }}
          className="department-filter-select"
        >
          <option value="all">All Issues</option>
          <option value="high">High Priority</option>
          <option value="medium">Medium Priority</option>
          <option value="low">Low Priority</option>
        </select>
      </div>

      {/* Sort By */}
      <div className="department-filter-group">
        <label>Sort By:</label>
        <select
          value={sortBy}
          onChange={(e) => {
            setSortBy(e.target.value);
            updateFilters({ sortBy: e.target.value });
          }}
          className="department-filter-select"
        >
          <option value="newest">Newest</option>
          <option value="priority">Priority</option>
          <option value="deadline">Deadline</option>
        </select>
      </div>

    </div>
  );
}

export default DepartmentFilterBar;
</file>

<file path="client/src/components/Department/DepartmentHeader.css">
.department-nav-link {
  position: relative;
  display: flex;
  align-items: center;
  text-decoration: none;
}

.department-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
  width: 62px;
}

.department-nav-text {
  font-size: 12px;
  font-weight: 600;
  color: #2563eb;
  line-height: 1.1;
  text-align: center;
  white-space: nowrap;
  transition: transform 0.15s ease;
}

.department-bell-wrap {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.department-notification-dot {
  position: absolute;
  top: -2px;
  right: -1px;
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #ef4444;
  border: 2px solid #fff;
}

.department-nav-link.department-active .department-icon,
.department-nav-link.active .department-icon {
  transform: none;
}

.department-nav-link.department-active .department-nav-item,
.department-nav-link.active .department-nav-item {
  transform: scale(1.1);
}

.department-nav-link.department-active .department-nav-text,
.department-nav-link.active .department-nav-text {
  transform: none;
  font-weight: 700;
}

.department-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  padding: 15px 25px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.department-logo {
  display: flex;
  align-items: center;
  font-weight: 600;
  font-size: 1.1rem;
  color: #1a1a1a;
}

.department-logo-icon {
  width: 28px;
  height: 28px;
  background: #2563eb;
  border-radius: 5px;
  margin-right: 10px;
}

.department-header-icons {
  display: flex;
  align-items: flex-end;
  gap: 35px;
  position: relative;
}

.department-icon.department-home {
  background: white;
  color: #2563eb;
  font-size: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.department-icon.department-bell {
  background: white;
  color: #2563eb;
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
}

.department-icon.department-minutes {
  background: white;
  color: #2563eb;
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.department-icon.department-profile {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #2563eb;
  color: white;
  font-weight: 500;
  cursor: pointer;
  font-size: 16px;
  line-height: 30px;
  text-align: center;
  margin-bottom: 6px;
}

.department-profile-dropdown {
  position: absolute;
  top: 55px;
  right: 0;
  background: #fff;
  border-radius: 10px;
  width: 140px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  animation: departmentDropdownFade 0.2s ease;
  z-index: 1000;
}

.department-profile-dropdown button {
  width: 100%;
  background: none;
  border: none;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111827;
}

.department-profile-dropdown button:hover {
  background: #f3f4f6;
}

@keyframes departmentDropdownFade {
  from {
    opacity: 0;
    transform: translateY(-6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.department-logout-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background: none;
  border: none;
  padding: 10px 16px;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111827;
}

.department-logout-btn:hover {
  background: #f3f4f6;
}

.department-logout-icon {
  font-size: 18px;
  color: #ef4444;
}
</file>

<file path="client/src/components/Department/DepartmentIssueCard.css">
.department-issue-card {
  position: relative;
  /* Needed for absolute positioning */
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
  padding: 20px;
  margin-top: 10px;
  border-left: 5px solid #facc15;
}


.department-issue-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.department-issue-id {
  font-weight: 600;
  font-size: 1rem;
}

.department-status {
  font-size: 0.8rem;
  padding: 5px 10px;
  border-radius: 12px;
  font-weight: 500;
  text-transform: capitalize;
}

/* üî∏ Color Variations */
.department-status.department-pending {
  background: #fef9c3;
  /* light yellow */
  color: #854d0e;
  /* dark yellow text */
}

.department-status.department-overdue {
  background: #fee2e2;
  /* light red */
  color: #b91c1c;
  /* dark red text */
}

.department-status.department-submitted {
  background: #dcfce7;
  /* light green */
  color: #166534;
  /* dark green text */
}

.department-issue-body p {
  margin: 4px 0;
  font-size: 0.9rem;
  color: #333;
}

.department-issue-row {
  display: flex;
  align-items: flex-start;
  margin: 6px 0;
  font-size: 0.9rem;
  color: #333;
}

.department-issue-row .department-label {
  width: 120px;
  /* fixed width for alignment */
  font-weight: 600;
  color: #444;
  text-align: left;
  /* left align text */
  position: relative;
  padding-right: 8px;
}

/* Adds colon after label, spaced properly */
.department-issue-row .department-label::after {
  content: ":";
  position: absolute;
  right: 0;
}

/* value text starts right after colon */
.department-issue-row .department-value {
  flex: 1;
  padding-left: 12px;
  margin-top: 6px;
}

/* üî¥ Overdue text color */
.department-overdue-text {
  color: #b91c1c !important;
  /* same red as your border */
  font-weight: 600;
}

.department-footer-line {
  height: 1px;
  background: #eee;
  margin-top: 30px;
}

.department-issue-footer {
  margin-top: 12px;
}

.department-response-received {
  display: flex;
  flex-direction: column;
  background-color: #F0FDF4;
  padding: 8px;
  border-radius: 8px;
  gap: 4px;
  align-items: flex-start;
}

.department-res {
  margin: 0;
  font-size: 0.9rem;
  line-height: 1.4;
  color: #333;
  text-align: left;
  width: 100%;
}

.department-res strong {
  color: #000;
  margin-right: 4px;
}

.department-res-button {
  align-self: flex-end;
  background: #19A752;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: background 0.2s ease;
}

.department-submit-btn {
  position: absolute;
  right: 12px;
  bottom: 12px;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
  transition: background 0.2s ease, transform 0.2s ease;
}

/* üü° Pending ‚Äì Yellow button */
.department-pending-btn {
  background-color: #d7b838;
  color: white;
}

.department-pending-btn:hover {
  background: #d7b016;
  transform: scale(1.05);
}

/* üî¥ Overdue ‚Äì Red button */
.department-overdue-btn {
  background: #b91c1c;
}

.department-overdue-btn:hover {
  background: #991b1b;
  transform: scale(1.05);
}

.department-issue-card {
  opacity: 0;
  animation: fadeInCard 0.3s ease forwards;
}

@keyframes fadeInCard {
  from {
    opacity: 0;
    transform: translateY(4px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</file>

<file path="client/src/components/Department/DepartmentResponseModal.css">
/* Overlay with blur effect */
.department-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

/* Modal box */
.department-modal-content {
  background: #ffffff;
  padding: 24px 28px;
  border-radius: 16px;
  width: 400px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  animation: popIn 0.25s ease;
  font-family: "Inter", sans-serif;
}

@keyframes popIn {
  from {
    transform: scale(0.95);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

/* Issue title (top heading) */
.department-issue-title {
  font-size: 22px;
  font-weight: 700;
  text-align: center;
  color: #111827;
  margin-bottom: 20px;
}

/* Fields layout */
.department-modal-fields {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.department-modal-row {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.department-modal-row label {
  font-size: 13px;
  color: #4b5563;
  font-weight: 500;
}

.department-modal-row input,
.department-modal-row textarea {
  padding: 8px 10px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.2s ease;
}

.department-modal-row input:focus,
.department-modal-row textarea:focus {
  outline: none;
  border-color: #2563eb;
}

.department-modal-row input[readonly] {
  background: #f9fafb;
  color: #6b7280;
  cursor: not-allowed;
}

.department-modal-row textarea {
  resize: none;
  height: 70px;
}

/* Upload input */
.department-modal-row input[type="file"] {
  border: none;
  font-size: 13px;
  padding: 0;
}

/* Action buttons */
.department-modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.department-cancel-btn {
  background: #f3f4f6;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.department-cancel-btn:hover {
  background: #e5e7eb;
}

.department-submit-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 8px 18px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
  transition: background-color 0.2s ease;
}

.department-submit-btn:hover {
  background: #1e40af;
}

/* No scrollbar */
.department-modal-content::-webkit-scrollbar {
  display: none;
}
/* Close icon (top-right corner) */
.department-close-btn {
  position: absolute;
  top: 14px;
  right: 16px;
  background: none;
  border: none;
  font-size: 22px;
  color: #6b7280;
  cursor: pointer;
  transition: color 0.2s ease;
}

.department-close-btn:hover {
  color: #111827;
}

/* Adjust modal content to make space for the close icon */
.department-modal-content {
  position: relative;
  padding-top: 40px; /* extra space so title not overlaps close btn */
}

/* Single submit button centered */
.department-modal-actions.department-single-btn {
  display: flex;
  justify-content: center;
}
/* Upload area box */
.department-upload-area {
  border: 2px dashed #d1d5db;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  color: #6b7280;
  background: #f9fafb;
  cursor: pointer;
  transition: all 0.25s ease;
}
/* Add space below the upload area */


.department-upload-area:hover {
  border-color: #2563eb;
  background: #eff6ff;
  color: #1e3a8a;
}

/* File name display */
.department-file-name {
  font-size: 14px;
  color: #111827;
  font-weight: 500;
  word-break: break-all;
}
.department-su{
    background: #2563eb;
  color: white;
  border: none;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  box-shadow: 0 3px 8px rgba(37, 99, 235, 0.25);
  transition: background-color 0.2s ease;
  margin-left: 320px;
}
</file>

<file path="client/src/components/Department/DepartmentResponseModal.jsx">
import React, { useRef, useState } from "react";
import "./DepartmentResponseModal.css";
import api from "../../api/axios";
import { emitIssuesUpdated, emitNotificationsUpdated } from "../../utils/liveUpdates";

function ResponseModal({ isOpen, onClose, issue }) {
  const fileInputRef = useRef(null);
  const [fileName, setFileName] = useState("");
  const [file, setFile] = useState(null);
  const [responseText, setResponseText] = useState("");

  if (!isOpen) return null;

  const handleFileChange = (e) => {
    const selected = e.target.files[0];
    if (selected) {
      setFile(selected);
      setFileName(selected.name);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    const selected = e.dataTransfer.files[0];
    if (selected) {
      setFile(selected);
      setFileName(selected.name);
    }
  };

  const handleDragOver = (e) => e.preventDefault();

  const handleSubmit = async () => {
    const idToSend = issue.id || issue.issue_dept_id;

    if (!idToSend) {
      alert("Error: Issue ID is missing. Please refresh the page.");
      return;
    }

    try {
      const formData = new FormData();
      formData.append("issue_id", idToSend);
      formData.append("response", responseText);
      if (file) {
        formData.append("attachment", file);
      }

      const res = await api.post("/submit-response", formData, {
        headers: {
          "Content-Type": "multipart/form-data",
        },
      });

      if (res.data.success) {
        alert("Submitted successfully!");
        onClose();
        emitIssuesUpdated({ source: "department-response", department: issue.department });
        emitNotificationsUpdated({ source: "department-response" });
      }
    } catch (error) {
      console.error("Submission error:", error.response?.data || error.message);
      alert("Submission failed!");
    }
  };

  return (
    <div className="department-modal-overlay" >
      <div className="department-modal-content" onClick={(e) => e.stopPropagation()}>
        <button className="department-close-btn" onClick={onClose}>
          &times;
        </button>

        <h2 className="department-issue-title">Issue #{issue.issue_no}</h2>

        <div className="department-modal-fields">
          <div className="department-modal-row">
            <label>Issue</label>
            <input type="text" value={issue.issue} readOnly />
          </div>

          <div className="department-modal-row">
            <label>Priority</label>
            <input type="text" value={issue.priority} readOnly />
          </div>

          <div className="department-modal-row">
            <label>Location</label>
            <input type="text" value={issue.location} readOnly />
          </div>

          <div className="department-modal-row">
            <label>Deadline</label>
            <input type="text" value={issue.deadline} readOnly />
          </div>

          <div className="department-modal-row">
            <label>Your Response</label>
            <textarea
              placeholder="Type your response here..."
              value={responseText}
              onChange={(e) => setResponseText(e.target.value)}
            />
          </div>

          <div className="department-modal-row">
            <label>Upload File</label>

            <div
              className="department-upload-area"
              onClick={() => fileInputRef.current.click()}
              onDrop={handleDrop}
              onDragOver={handleDragOver}
            >
              {fileName ? (
                <p className="department-file-name">{fileName}</p>
              ) : (
                <p>
                  <strong>Click to upload</strong> or drag and drop file here
                </p>
              )}

              <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileChange}
                hidden
              />
            </div>
          </div>
        </div>

        <button className="department-submit-btn" onClick={handleSubmit}>
          Submit
        </button>
      </div>
    </div>
  );
}

export default ResponseModal;
</file>

<file path="client/src/components/Department/DepartmentTabs.css">
.department-tabs-container {
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.department-tabs {
  display: flex;
  gap: 15px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}

.department-tab {
  padding: 10px 20px;
  cursor: pointer;
  font-weight: 500;
  color: #555;
}

.department-tab.department-active {
  border-bottom: 3px solid #007bff;
  color: #007bff;
}

.department-tab-scroll-area {
  flex: 1;
  overflow-y: auto;
  /* max-height removed */
  padding-right: 10px;
  scrollbar-width: thin;
}

.department-tab {
  transition: background-color 0.2s ease, color 0.2s ease;
}
</file>

<file path="client/src/components/Department/DepartmentTabs.jsx">
import React from "react";
import "./DepartmentTabs.css";

function DepartmentTabs({ activeTab, setActiveTab }) {
  const tabs = ["Pending", "Overdue", "Submitted"];

  return (
    <div className="department-tabs-container">
      <div className="department-tabs">
        {tabs.map((tab) => (
          <div
            key={tab}
            className={`department-tab ${activeTab === tab ? "department-active" : ""}`}
            onClick={() => setActiveTab(tab)}
          >
            {tab}
          </div>
        ))}
      </div>
    </div>
  );
}

export default DepartmentTabs;
</file>

<file path="client/src/components/DPO/IssuePage/DPOGenerateReportCard.jsx">
import React from "react";

const GenerateReportCard = React.memo(function GenerateReportCard({
  report,
  index,
  handleChange,
  removeCard,
}) {
  return (
    <div className="dpo-generate-report-card">
      <div className="dpo-report-top">
        <div className="dpo-report-id">{report.issue_no}</div>
        <button className="dpo-report-delete-btn" onClick={() => removeCard(index)}>
          üóëÔ∏è
        </button>
      </div>

      <div className="dpo-report-form">
        <div className="dpo-form-field">
          <label>Department:</label>
          <input
            type="text"
            value={report.department}
            onChange={e => handleChange(index, "department", e.target.value)}
          />
        </div>

        <div className="dpo-form-field">
          <label>Issue:</label>
          <textarea
            value={report.issue}
            onChange={e => handleChange(index, "issue", e.target.value)}
            rows="3"
          />
        </div>

        <div className="dpo-form-field">
          <label>Response:</label>
          <textarea
            value={report.response || ""}
            onChange={e => handleChange(index, "response", e.target.value)}
            rows="3"
          />
        </div>

        <div className="dpo-form-field">
          <label>Location:</label>
          <input
            type="text"
            value={report.location}
            onChange={e => handleChange(index, "location", e.target.value)}
          />
        </div>
      </div>
    </div>
  );
});

export default GenerateReportCard;
</file>

<file path="client/src/components/DPO/IssuePage/DPOGenerateReports.css">
/* ==============================
   Main Container
============================== */
.dpo-generate-reports-container { 
  background: #fff; 
  border-radius: 14px; 
  padding: 30px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06); 
  margin: 0 auto;     /* ‚úÖ CENTERED */
  font-family: "Inter", sans-serif; 
  display: flex; 
  flex-direction: column;
  max-height: 480px;
  width: 800px;
}


/* ==============================
   Header
============================== */
.dpo-generate-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-bottom: 15px; 
}

.dpo-close-btn {
  margin-left: auto;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #555;
  transition: color 0.2s ease;
}

.dpo-close-btn:hover {
  color: #000;
}

/* ==============================
   Report List
============================== */
.dpo-report-list { 
  flex: 1; 
  overflow-y: auto; 
  display: flex; 
  flex-direction: column; 
  gap: 20px; 
  padding-right: 4px; 
}

.dpo-report-list::-webkit-scrollbar { 
  width: 8px; 
}

.dpo-report-list::-webkit-scrollbar-thumb { 
  background: #cbd5e1; 
  border-radius: 6px; 
}

.dpo-report-list::-webkit-scrollbar-thumb:hover { 
  background: #94a3b8; 
}

/* ==============================
   Report Card Layout
============================== */
.dpo-generate-report-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  background-color: #f9fafb;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  transition: box-shadow 0.2s ease;
}

.dpo-generate-report-card:hover {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
}

/* ==============================
   Report Top Section
============================== */
.dpo-report-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 2px;
}

.dpo-report-id {
  font-weight: 600;
  color: #111827;
  font-size: 15px;
}

.dpo-report-delete-btn {
  background: none;
  border: none;
  color: #b91c1c;
  font-size: 18px;
  cursor: pointer;
  transition: transform 0.2s ease, color 0.2s ease;
}

.dpo-report-delete-btn:hover {
  color: #991b1b;
  transform: scale(1.15);
}

/* ==============================
   Report Form
============================== */
.dpo-report-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.dpo-form-field {
  display: flex;
  flex-direction: column;
}

.dpo-form-field label {
  color: #374151;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
}

.dpo-form-field input,
.dpo-form-field select {
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 14px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.dpo-form-field textarea {
  resize: none;
  height: 70px;
  min-height: 70px;
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.4;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.dpo-form-field input:focus,
.dpo-form-field select:focus,
.dpo-form-field textarea:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

/* ==============================
   Format Toggle
============================== */
.dpo-format-toggle {
  display: flex;
  gap: 10px;
}

.dpo-format-btn {
  padding: 6px 14px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background-color: #f3f4f6;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s ease, color 0.2s ease;
}

.dpo-format-btn:hover {
  background-color: #e5e7eb;
}

.dpo-format-btn.dpo-active {
  background-color: #2563eb;
  color: #fff;
  border-color: #2563eb;
}

/* ==============================
   Download Button Section
============================== */
.dpo-download-section {
  display: flex;
  align-items: center; 
  justify-content: flex-end; 
  height: 4px; 
  margin-top: 25px;  
  margin-right: 10px;
}

.dpo-generate-download-btn {
  background-color: #2563eb;
  color: white;
  border: none;
  padding: 10px 24px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.dpo-generate-download-btn:hover {
  background-color: #1d4ed8;
}
.dpo-close{
    background: none;
  border: none;
  font-size: 22px;
  color: #6b7280;
  cursor: pointer;
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOIssueCard.css">
/* =========================
   ISSUE CARD
========================= */

.dpo-issue-card {
  position: relative; /* Needed for bottom-right log button */
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
  padding: 20px;
  margin-top: 10px;
  border-left: 5px solid #facc15;
  opacity: 0;
  animation: fadeInCard 0.3s ease forwards;
}

.dpo-issue-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.dpo-issue-id {
  font-weight: 600;
  font-size: 1rem;
}

.dpo-status {
  font-size: 0.8rem;
  padding: 5px 10px;
  border-radius: 12px;
  font-weight: 500;
  text-transform: capitalize;
}

/* Status Colors */

.dpo-status.dpo-pending {
  background: #fef9c3;
  color: #854d0e;
}

.dpo-status.dpo-overdue {
  background: #fee2e2;
  color: #b91c1c;
}

.dpo-status.dpo-received {
  background: #dcfce7;
  color: #166534;
}

/* =========================
   BODY ROWS
========================= */

.dpo-issue-row {
  display: flex;
  align-items: flex-start;
  margin: 6px 0;
  font-size: 0.9rem;
  color: #333;
}

.dpo-issue-row .dpo-label {
  width: 120px;
  font-weight: 600;
  color: #444;
  position: relative;
  padding-right: 8px;
}

.dpo-issue-row .dpo-label::after {
  content: ":";
  position: absolute;
  right: 0;
}

.dpo-issue-row .dpo-value {
  flex: 1;
  padding-left: 12px;
  margin-top: 6px;
}

.dpo-overdue-text {
  color: #b91c1c !important;
  font-weight: 600;
}

/* =========================
   FOOTER
========================= */

.dpo-footer-line {
  height: 1px;
  background: #000;
  margin: 20px 0px 10px;
}

.dpo-issue-footer {
  padding-bottom: 40px; /* Space for bottom-right log button */
}

/* =========================
   RESPONSES
========================= */

.dpo-response-received {
  display: flex;
  flex-direction: column;
  background-color: #c9ffd9;
  padding: 8px;
  border-radius: 8px;
  margin: 0px 0px 8px 0px;
  gap: 4px;
  align-items: flex-start;
}

.dpo-res {
  margin: 0;
  font-size: 0.9rem;
  line-height: 1.4;
  color: #333;
  width: 100%;
}

.dpo-res strong {
  color: #000;
  margin-right: 4px;
}

.dpo-res-button {
  align-self: flex-end;
  background: #19A752;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: background 0.2s ease;
}

/* =========================
   LOG BUTTON (Bottom Right)
========================= */

.dpo-log-btn {
  position: absolute;
  bottom: 12px;
  right: 15px;
  background: #2563eb;
  color: white;
  border: none;
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  transition: background 0.2s ease;
}

.dpo-log-btn:hover {
  background: #1d4ed8;
}

/* =========================
   MODAL
========================= */

.dpo-log-overlay {
  position: fixed;
  inset: 0;
  z-index: 3000;
}

.dpo-log-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
}

.dpo-log-modal {
  position: relative;
  background: white;
  width: 550px;
  max-height: 80vh;
  overflow-y: auto;
  margin: 70px auto;
  padding: 20px;
  border-radius: 10px;
  z-index: 3001;
  animation: fadeInCard 0.2s ease forwards;
}

.dpo-log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dpo-log-close {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
}

.dpo-log-entry {
  display: flex;
  gap: 12px;
  margin-bottom: 15px;
}

.dpo-log-dot {
  width: 10px;
  height: 10px;
  background: #2563eb;
  border-radius: 50%;
  margin-top: 6px;
}

.dpo-log-msg {
  background: #f3f4f6;
  padding: 6px 10px;
  border-radius: 6px;
}

.dpo-log-date {
  font-size: 0.75rem;
  color: #6b7280;
  margin-top: 4px;
}

/* =========================
   ANIMATION
========================= */

@keyframes fadeInCard {
  from {
    opacity: 0;
    transform: translateY(4px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOTabs.css">
.dpo-tabs-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.dpo-tabs {
  display: flex;
  gap: 15px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 10px;
}

.dpo-tab {
  padding: 10px 20px;
  cursor: pointer;
  font-weight: 500;
  color: #555;
}

.dpo-tab.dpo-active {
  border-bottom: 3px solid #007bff;
  color: #007bff;
}

.dpo-tab-scroll-area {
  flex: 1;
  overflow-y: auto;
  padding-right: 10px;
  scrollbar-width: thin;
}

.dpo-tab {
  transition: background-color 0.2s ease, color 0.2s ease;
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOTabs.jsx">
import React from "react";
import "./DPOTabs.css";

function Tabs({ activeTab, setActiveTab }) {
  const tabs = ["Pending", "Overdue", "Received"];

  return (
    <div className="dpo-tabs-container">
      <div className="dpo-tabs">
        {tabs.map((tab) => (
          <div
            key={tab}
            className={`dpo-tab ${activeTab === tab ? "dpo-active" : ""}`}
            onClick={() => setActiveTab(tab)}
          >
            {tab}
          </div>
        ))}
      </div>
    </div>
  );
}

export default Tabs;
</file>

<file path="client/src/components/DPO/UploadPage/DPOAssignIssues.css">
/* ==============================
   Main Container
============================== */
.dpo-assign-issues-container {
  height: 100%;
  min-height: 0;
  background: #fff;
  border-radius: 14px;
  padding: 28px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  max-width: 100%;
  width: 100%;
  box-sizing: border-box;
  margin: 0;
  font-family: "Inter", sans-serif;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ==============================
   Header
============================== */
.dpo-assign-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.dpo-assign-header h2 {
  font-size: 20px;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.dpo-allocate-btn {
  background-color: #16a34a;
  color: #fff;
  border: none;
  padding: 8px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background-color 0.2s ease;
  box-shadow: 0 3px 8px rgba(22, 163, 74, 0.2);
}

.dpo-allocate-btn:hover {
  background-color: #15803d;
}

/* ==============================
   Issue Cards List
============================== */
.dpo-issue-cards {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding-right: 4px;
}

.dpo-issue-cards::-webkit-scrollbar {
  width: 8px;
}

.dpo-issue-cards::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 6px;
}

.dpo-issue-cards::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* ==============================
   Card Layout
============================== */
.dpo-assign-issues-container .dpo-issue-assign-card {
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  background-color: #f9fafb;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
  transition: box-shadow 0.2s ease;
}

.dpo-assign-issues-container .dpo-issue-assign-card:hover {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
}

/* ==============================
   Card Header (Top Row)
============================== */
.dpo-assign-issues-container .dpo-issue-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 6px;
}

.dpo-assign-issues-container .dpo-entry-id {
  font-weight: 600;
  color: #111827;
  font-size: 15px;
}

.dpo-assign-issues-container .dpo-delete-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: #dc2626;
  font-size: 22px;
  cursor: pointer;
  transition: transform 0.2s ease, color 0.2s ease;
}

.dpo-assign-issues-container .dpo-delete-btn:hover {
  color: #b91c1c;
  transform: scale(1.15);
}

.dpo-assign-issues-container .dpo-flag-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  background: #fff;
  color: #475569;
  cursor: pointer;
}

.dpo-assign-issues-container .dpo-flag-btn-mapped {
  border-color: #2563eb;
  color: #2563eb;
  background: #eff6ff;
}

.dpo-assign-issues-container .dpo-unresolved-panel {
  border: 1px solid #dbeafe;
  background: #f8fbff;
  border-radius: 10px;
  padding: 10px;
}

.dpo-assign-issues-container .dpo-unresolved-title {
  margin: 0 0 8px 0;
  font-size: 13px;
  font-weight: 600;
  color: #1e3a8a;
}

.dpo-assign-issues-container .dpo-unresolved-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.dpo-assign-issues-container .dpo-unresolved-item {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 13px;
  color: #1f2937;
}

/* ==============================
   Form Section
============================== */
.dpo-assign-issues-container .dpo-issue-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.dpo-assign-issues-container .dpo-form-field {
  display: flex;
  flex-direction: column;
}

.dpo-assign-issues-container .dpo-form-field label {
  color: #374151;
  font-size: 14px;
  font-weight: 500;
  margin-bottom: 4px;
}

.dpo-assign-issues-container .dpo-form-field input,
.dpo-assign-issues-container .dpo-form-field select {
  border: 1px solid #d1d5db;
  border-radius: 8px;
  padding: 8px 10px;
  font-size: 14px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.dpo-assign-issues-container .dpo-form-field textarea {
  resize: none;
  height: 35px;
  min-height: 35px;
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.4;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background-color: #fff;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.dpo-assign-issues-container .dpo-form-field .dpo-description-textarea {
  height: 86px;
  min-height: 86px;
}

.dpo-assign-issues-container .dpo-form-field input:focus,
.dpo-assign-issues-container .dpo-form-field select:focus,
.dpo-assign-issues-container .dpo-form-field textarea:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

/* ==============================
   Deadline Field
============================== */
.dpo-assign-issues-container .dpo-deadline-input {
  position: relative;
  display: flex;
  align-items: center;
}

.dpo-assign-issues-container .dpo-deadline-input input {
  width: 100%;
  padding-right: 38px;
}

.dpo-assign-issues-container .dpo-calendar-icon {
  position: absolute;
  right: 12px;
  font-size: 18px;
  color: #4b5563;
  cursor: pointer;
  transition: color 0.2s ease;
}

.dpo-assign-issues-container .dpo-calendar-icon:hover {
  color: #2563eb;
}

.dpo-assign-issues-container .dpo-assign-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.dpo-assign-issues-container .dpo-card-bottom-actions {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  border-top: 1px solid #e5e7eb;
  padding-top: 10px;
}

.dpo-assign-issues-container .dpo-inline-allocate-btn {
  background-color: #2563eb;
  color: #fff;
  border: none;
  padding: 4px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.dpo-assign-issues-container .dpo-inline-allocate-btn:hover {
  background-color: #1d4ed8;
}
</file>

<file path="client/src/components/DPO/UploadPage/DPOUploadForm.css">
/* src/components/Upload/UploadForm.dpo-css */

.dpo-upload-form {
  background: #fff;
  border-radius: 14px;
  padding: 28px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  max-width: 800px;
  margin: 0 auto;
  font-family: "Inter", sans-serif;
  margin-top: 24px;
}

.dpo-upload-title {
  font-size: 1.4rem;
  font-weight: 700;
  color: #111;
  margin-bottom: 10px;
}

.dpo-field-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #111827;
  margin-top: 20px;
  margin-bottom: 6px;
}

.dpo-date-input-wrapper input[type="text"] {
  width: 100%;
  padding: 10px 40px 10px 12px;
  border: 1.5px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  color: #111827;
  outline: none;
}

.dpo-calendar-icon {
  position: absolute;
  right: 12px;
  cursor: pointer;
  font-size: 18px;
  color: #374151;
}

.dpo-file-drop {
  border: 2px dashed #d1d5db;
  border-radius: 10px;
  height: 140px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 10px;
  transition: 0.2s;
  position: relative;
  background: #fafafa;
}

.dpo-file-drop.dpo-drag-over {
  border-color: #3b82f6;
  background-color: #eff6ff;
}

.dpo-file-drop-inner {
  text-align: center;
  cursor: pointer;
}

.dpo-file-icon {
  font-size: 32px;
  margin-bottom: 8px;
}

.dpo-file-text {
  font-size: 14px;
  color: #6b7280;
}

.dpo-file-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

.dpo-up {
  display: block;
  width: 100%;
  margin-top: 25px;
  background-color: #2563eb;
  color: #fff;
  border: none;
  padding: 12px 0;
  font-size: 15px;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
  transition: background-color 0.25s ease, transform 0.1s ease;
}

.dpo-form-content {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.dpo-loading-card {
  background: #fff;
  border-radius: 14px;
  padding: 28px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  max-width: 550px;
  margin: 0 auto;
  font-family: "Inter", sans-serif;
  margin-top: 24px;
}

/* ================= EXTRACTION ANIMATION ================= */
.dpo-extract-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  font-family: system-ui, sans-serif;
}

.dpo-extract-wrapper h4 {
  color: #2563eb;
  margin: 0;
  text-align: center;
}

.dpo-document {
  position: relative;
  width: 220px;
  height: 240px;
  background: #f9fbff;
  border: 2px solid #2979ff;
  border-radius: 10px;
  padding: 20px;
  overflow: hidden;
}

.dpo-document::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  height: 0%;
  width: 100%;
  background: rgba(41, 121, 255, 0.08);
  animation: fillDoc 4s ease-in-out infinite;
  z-index: 0;
}

.dpo-scan-line {
  position: absolute;
  top: 0;
  left: 0;
  height: 3px;
  width: 100%;
  background: linear-gradient(90deg, transparent, #2979ff, transparent);
  animation: scan 2s ease-in-out infinite;
  z-index: 2;
}

.dpo-field {
  height: 14px;
  background: #cfe0ff;
  border-radius: 4px;
  margin-bottom: 14px;
  animation: highlight 2s ease-in-out infinite;
  position: relative;
  z-index: 1;
}

.dpo-field.dpo-short {
  width: 60%;
}

.dpo-field.dpo-medium {
  width: 80%;
}

.dpo-status {
  font-size: 14px;
  color: #2979ff;
  letter-spacing: 0.3px;
  text-align: center;
}

@keyframes scan {
  0% {
    top: 0;
    opacity: 0;
  }
  10% {
    opacity: 1;
  }
  50% {
    opacity: 1;
  }
  100% {
    top: 100%;
    opacity: 0;
  }
}

@keyframes fillDoc {
  0% {
    height: 0%;
  }
  100% {
    height: 100%;
  }
}

@keyframes highlight {
  0%,
  100% {
    opacity: 0.5;
  }
  50% {
    opacity: 1;
  }
}
</file>

<file path="client/src/components/DPO/UploadPage/DPOUploadForm.jsx">
// src/components/Upload/UploadForm.jsx
import React, { useRef, useState, useEffect } from "react";
import "./DPOUploadForm.css";
import api from "../../../api/axios";
import { saveDraft } from "../../../utils/dpoDrafts";

export default function UploadForm({ onProcessed }) {
  /* ================= REFS ================= */
  const datePickerRef = useRef(null);

  /* ================= STATE ================= */
  const [selectedFile, setSelectedFile] = useState(null);
  const [fileName, setFileName] = useState("");
  const [date, setDate] = useState("");
  const [dragOver, setDragOver] = useState(false);
  const [uploading, setUploading] = useState(false);

  /* ================= STATUS TEXT ================= */
  const statusMessages = [
    "This may take a few moments‚Ä¶",
    "Scanning document‚Ä¶",
    "Extracting fields‚Ä¶",
    "Validating extracted data‚Ä¶",
  ];

  const [statusIndex, setStatusIndex] = useState(0);

  /* ================= EFFECTS ================= */
  useEffect(() => {
    if (!uploading) return;

    const interval = setInterval(() => {
      setStatusIndex((prev) => (prev + 1) % statusMessages.length);
    }, 5000);

    return () => clearInterval(interval);
  }, [uploading, statusMessages.length]);

  /* ================= HELPERS ================= */
  const formatDateInput = (raw) => {
    const digits = raw.replace(/\D/g, "").slice(0, 8);
    if (digits.length <= 2) return digits;
    if (digits.length <= 4) return `${digits.slice(0, 2)}-${digits.slice(2)}`;
    return `${digits.slice(0, 2)}-${digits.slice(2, 4)}-${digits.slice(4)}`;
  };

  /* ================= HANDLERS ================= */
  const handleDateChange = (e) => {
    setDate(formatDateInput(e.target.value));
  };

  const handleHiddenDatePick = (e) => {
    const [year, month, day] = e.target.value.split("-");
    if (day) setDate(`${day}-${month}-${year}`);
  };

  const handleFileSelect = (file) => {
    if (!file) return;
    setSelectedFile(file);
    setFileName(file.name);
  };

  const handleUploadAndProcess = async () => {
    if (!date || !selectedFile) {
      alert("Please select a date and upload a file.");
      return;
    }

    try {
      setUploading(true);

      const formData = new FormData();
      formData.append("meeting_date", date);
      formData.append("file", selectedFile);

      const res = await api.post("/upload-minutes", formData, {
        headers: { "Content-Type": "multipart/form-data" },
      });

      const extractedIssues = Array.isArray(res?.data?.data) ? res.data.data : [];
      const minutesId = res?.data?.minutes_id || null;
      const draftId = `draft_${Date.now()}`;

      saveDraft({
        id: draftId,
        title: fileName || "Untitled Draft",
        meetingDate: date,
        minutesId,
        issues: extractedIssues,
      });

      onProcessed(draftId);
    } catch (err) {
      console.error("Upload error:", err);
      alert("Failed to upload file.");
      setUploading(false);
    }
  };

  /* ================= LOADING UI ================= */
  if (uploading) {
    return (
      <div className="dpo-upload-form dpo-loading-card">
        <h4>Extracting fields from document‚Ä¶</h4>

        <div className="dpo-extract-wrapper">
          <div className="dpo-document">
            <div className="dpo-scan-line"></div>

            <div className="dpo-field"></div>
            <div className="dpo-field dpo-short"></div>
            <div className="dpo-field"></div>
            <div className="dpo-field dpo-medium"></div>
          </div>

          <p className="dpo-status">{statusMessages[statusIndex]}</p>
        </div>
      </div>
    );
  }

  /* ================= FORM UI ================= */
  return (
    <div className="dpo-upload-form">
      <h2 className="dpo-upload-title">Upload Meeting Minutes</h2>

      <div className="dpo-form-content">
        {/* DATE */}
        <label className="dpo-field-label">Date</label>
        <div className="dpo-date-input-wrapper">
          <input
            type="text"
            placeholder="dd-mm-yyyy"
            value={date}
            onChange={handleDateChange}
            maxLength={10}
          />

          <span
            className="dpo-calendar-icon"
            onClick={() => datePickerRef.current?.showPicker()}
          >
            üìÖ
          </span>

          <input
            type="date"
            ref={datePickerRef}
            onChange={handleHiddenDatePick}
            style={{ visibility: "hidden", position: "absolute" }}
          />
        </div>

        {/* FILE */}
        <label className="dpo-field-label">Minutes File</label>
        <div
          className={`dpo-file-drop ${dragOver ? "dpo-drag-over" : ""}`}
          onDragOver={(e) => {
            e.preventDefault();
            setDragOver(true);
          }}
          onDragLeave={() => setDragOver(false)}
          onDrop={(e) => {
            e.preventDefault();
            setDragOver(false);
            handleFileSelect(e.dataTransfer.files?.[0]);
          }}
        >
          <div className="dpo-file-drop-inner">
            <div className="dpo-file-icon">üìÑ</div>
            <div className="dpo-file-text">
              {fileName || "Click to upload or drag and drop"}
            </div>

            <input
              type="file"
              className="dpo-file-input"
              accept=".pdf,.doc,.docx"
              onChange={(e) => handleFileSelect(e.target.files?.[0])}
            />
          </div>
        </div>

        {/* SUBMIT */}
        <button className="dpo-up" onClick={handleUploadAndProcess}>
          Upload & Continue
        </button>
      </div>
    </div>
  );
}
</file>

<file path="client/src/main.jsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import './index.css';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <App />,
);
</file>

<file path="client/src/pages/CollectorPage/CollectorMinutesPage.jsx">
import React, { useEffect, useState } from "react";
import PictureAsPdfIcon from "@mui/icons-material/PictureAsPdf";
import GetAppIcon from "@mui/icons-material/GetApp";
import OpenInNewIcon from "@mui/icons-material/OpenInNew";

import CollectorHeader from "../../components/Collector/CollectorHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import api from "../../api/axios";

import "./CollectorMinutesPage.css";

function CollectorMinutesPage() {
  const [minutes, setMinutes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchMinutes();
  }, []);

  const fetchMinutes = async () => {
    setLoading(true);
    setError(null);
    try {
      const res = await api.get("/minutes");
      setMinutes(res.data);
    } catch (err) {
      console.error("Error fetching minutes:", err);
      setError("Failed to load minutes. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateString) => {
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-GB", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    } catch {
      return "Unknown date";
    }
  };

  const handleView = (fileUrl) => {
    if (fileUrl) {
      const link = document.createElement("a");
      link.href = fileUrl;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  const handleDownload = async (fileUrl, fileName) => {
    if (!fileUrl) return;

    try {
      const response = await fetch(fileUrl);
      if (!response.ok) throw new Error("Failed to download file");

      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = blobUrl;
      link.download = fileName || "minutes.pdf";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(blobUrl);
    } catch (downloadError) {
      console.error("Download error:", downloadError);
      alert("Failed to download file. Please try again.");
    }
  };

  return (
    <div className="collector-minutespage-container">
      <CollectorHeader />

      <div className="collector-minutespage-content">
        <h1 className="collector-page-title">Meeting Minutes</h1>

        {error && <div className="collector-error-message">{error}</div>}

        <div className="collector-minutes-body">
          {loading ? (
            <LoadingState text="Loading minutes..." />
          ) : minutes.length === 0 ? (
            <EmptyStateCard
              title="No minutes uploaded"
              description="There are no meeting minutes to display yet."
            />
          ) : (
            <div className="collector-minutes-grid">
              {minutes.map((m) => (
                <div key={m.id} className="collector-minutes-card">
                  <div className="collector-card-header">
                    <PictureAsPdfIcon className="collector-pdf-icon" />
                    <h3 className="collector-file-name">{m.originalFileName || m.title}</h3>
                  </div>

                  <div className="collector-card-body">
                    <div className="collector-info-item">
                      <span className="collector-label">Uploaded:</span>
                      <span className="collector-value">{formatDate(m.uploadedDate)}</span>
                    </div>

                    {m.meetingDate && (
                      <div className="collector-info-item">
                        <span className="collector-label">Meeting Date:</span>
                        <span className="collector-value">{formatDate(m.meetingDate)}</span>
                      </div>
                    )}

                    <div className="collector-info-item">
                      <span className="collector-label">Uploaded By:</span>
                      <span className="collector-value">{m.uploadedBy}</span>
                    </div>
                  </div>

                  <div className="collector-card-actions">
                    <button
                      className="collector-action-btn collector-view-btn"
                      onClick={() => handleView(m.fileUrl)}
                      title="View document"
                    >
                      <OpenInNewIcon className="collector-btn-icon" />
                      View
                    </button>

                    <button
                      className="collector-action-btn collector-download-btn"
                      onClick={() => handleDownload(m.fileUrl, m.originalFileName)}
                      title="Download document"
                    >
                      <GetAppIcon className="collector-btn-icon" />
                      Download
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default CollectorMinutesPage;
</file>

<file path="client/src/pages/DepartmentPage/DepartmentMinutesPage.jsx">
import React, { useEffect, useState } from "react";
import PictureAsPdfIcon from "@mui/icons-material/PictureAsPdf";
import GetAppIcon from "@mui/icons-material/GetApp";
import OpenInNewIcon from "@mui/icons-material/OpenInNew";

import DepartmentHeader from "../../components/Department/DepartmentHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import api from "../../api/axios";

import "./DepartmentMinutesPage.css";

function DepartmentMinutesPage() {
  const [minutes, setMinutes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    fetchMinutes();
  }, []);

  const fetchMinutes = async () => {
    setLoading(true);
    setError(null);
    try {
      const res = await api.get("/minutes");
      setMinutes(res.data);
    } catch (err) {
      console.error("Error fetching minutes:", err);
      setError("Failed to load minutes. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateString) => {
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-GB", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    } catch {
      return "Unknown date";
    }
  };

  const handleView = (fileUrl) => {
    if (fileUrl) {
      const link = document.createElement("a");
      link.href = fileUrl;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  const handleDownload = async (fileUrl, fileName) => {
    if (!fileUrl) return;

    try {
      const response = await fetch(fileUrl);
      if (!response.ok) throw new Error("Failed to download file");

      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = blobUrl;
      link.download = fileName || "minutes.pdf";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(blobUrl);
    } catch (downloadError) {
      console.error("Download error:", downloadError);
      alert("Failed to download file. Please try again.");
    }
  };

  return (
    <div className="department-container">
      <DepartmentHeader />

      <div className="department-minutes-page-content">
        <h1 className="department-page-title">Meeting Minutes</h1>

        {error && <div className="department-error-message">{error}</div>}

        <div className="department-minutes-body">
          {loading ? (
            <LoadingState text="Loading minutes..." />
          ) : minutes.length === 0 ? (
            <EmptyStateCard
              title="No minutes uploaded"
              description="There are no meeting minutes to display yet."
            />
          ) : (
            <div className="department-minutes-grid">
              {minutes.map((m) => (
                <div key={m.id} className="department-minutes-card">
                  <div className="department-card-header">
                    <PictureAsPdfIcon className="department-pdf-icon" />
                    <h3 className="department-file-name">{m.originalFileName || m.title}</h3>
                  </div>

                  <div className="department-card-body">
                    <div className="department-info-item">
                      <span className="department-label">Uploaded:</span>
                      <span className="department-value">{formatDate(m.uploadedDate)}</span>
                    </div>

                    {m.meetingDate && (
                      <div className="department-info-item">
                        <span className="department-label">Meeting Date:</span>
                        <span className="department-value">{formatDate(m.meetingDate)}</span>
                      </div>
                    )}

                    <div className="department-info-item">
                      <span className="department-label">Uploaded By:</span>
                      <span className="department-value">{m.uploadedBy}</span>
                    </div>
                  </div>

                  <div className="department-card-actions">
                    <button
                      className="department-action-btn department-view-btn"
                      onClick={() => handleView(m.fileUrl)}
                      title="View document"
                    >
                      <OpenInNewIcon className="department-btn-icon" />
                      View
                    </button>

                    <button
                      className="department-action-btn department-download-btn"
                      onClick={() => handleDownload(m.fileUrl, m.originalFileName)}
                      title="Download document"
                    >
                      <GetAppIcon className="department-btn-icon" />
                      Download
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default DepartmentMinutesPage;
</file>

<file path="client/src/pages/DepartmentPage/DepartmentNotificationPage.css">
.department-notificationpage-container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.department-notificationpage-content {
  padding: 10px 70px;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* Prevent page scroll, keep list scroll */
}

.department-notification-header h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 20px;
  color: #111;
}

.department-notification-list {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  display: flex;
  flex-direction: column;
  
  /* CRITICAL FIX FOR SCROLLING */
  overflow-y: auto;
  flex: 1; /* Fill remaining space */
  max-height: none; /* Leave room for header */
  padding-bottom: 40px; /* Extra space at bottom so last item isn't hidden */
}

/* Scrollbar styling */
.department-notification-list::-webkit-scrollbar {
  width: 8px;
}
.department-notification-list::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 6px;
}

.department-notification-card {
  display: flex;
  align-items: center;
  gap: 5px;
  border-left: 5px solid transparent;
  background: #f9fafb;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  transition: all 0.2s ease;
  min-height: 80px; /* Ensure consistency */
}

.department-notification-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
}

.department-notification-card.department-assign { border-left-color: #22c55e; }
.department-notification-card.department-response { border-left-color: #3b82f6; }
.department-notification-card.department-deadline { border-left-color: #ef4444; }

.department-notification-icon span {
  font-size: 1.8rem;
}

.department-notification-content {
  flex: 1;
}

.department-notification-content h3 {
  font-size: 0.9rem;
  font-weight: 700;
  color: #111827;
  margin: 0 0 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.department-notification-content p {
  font-size: 0.95rem;
  color: #4b5563;
  margin: 0;
  line-height: 1.4;
}

.department-notification-content .department-time {
  display: block;
  font-size: 0.8rem;
  color: #9ca3af;
  margin-top: 6px;
  font-style: italic;
}

.department-no-notifications {
  text-align: center;
  padding: 50px 0;
  color: #6b7280;
  font-size: 1.1rem;
}
.department-notification-list > .empty-state-card,
.department-notification-list > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/DepartmentPage/DepartmentNotificationPage.jsx">
import React, { useEffect, useState } from "react";
// import axios from "axios";
import DepartmentHeader from "../../components/Department/DepartmentHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import "./DepartmentNotificationPage.css";
import api from "../../api/axios";
import { getAuthValue } from "../../utils/authStorage";
import { LIVE_EVENT_NOTIFICATIONS_UPDATED, addLiveEventListener } from "../../utils/liveUpdates";

function DepartmentNotificationPage() {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchNotifications = async () => {
      const username = getAuthValue("username");
      try {
        const res = await api.get("/notifications", {
          params: { username }
        });
        setNotifications(res.data);
      } catch (err) {
        console.error("Error fetching notifications:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchNotifications();
    const onNotificationsUpdated = () => fetchNotifications();
    const unsubscribe = addLiveEventListener(
      LIVE_EVENT_NOTIFICATIONS_UPDATED,
      onNotificationsUpdated
    );
    return unsubscribe;
  }, []);

  return (
    <div className="department-notificationpage-container">
      <DepartmentHeader activeTab="notifications" />

      <div className="department-notificationpage-content">
        <div className="department-notification-header">
          <h1>Notifications</h1>
        </div>

        <div className="department-notification-list">
          {loading ? (
            <LoadingState text="Loading notifications..." />
          ) : notifications.length === 0 ? (
            <EmptyStateCard
              compact
              title="No notifications"
              description="You are all caught up."
            />
          ) : (
            notifications.map((note) => {
              const safeType = note.type || "general";
              return (
                <div key={note.id} className={`department-notification-card department-${safeType}`}>
                  <div className="department-notification-icon">
                    {safeType === "assign" && <span>üìù</span>}
                    {safeType === "deadline" && <span>‚è∞</span>}
                    {safeType === "response" && <span>üì©</span>}
                    {safeType === "general" && <span>üîî</span>}
                  </div>

                  <div className="department-notification-content">
                    <h3>{safeType.toUpperCase()}</h3>
                    <p>{note.message}</p>
                    <span className="department-time">{note.time_ago}</span>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

export default DepartmentNotificationPage;
</file>

<file path="client/src/pages/DPOPage/DPONotificationPage.css">
.dpo-notificationpage-container {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.dpo-notificationpage-content {
  padding: 10px 70px;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* Prevent page scroll, keep list scroll */
}

.dpo-notification-header h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 20px;
  color: #111;
}

.dpo-notification-list {
  border-radius: 12px;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  
  /* CRITICAL FIX FOR SCROLLING */
  overflow-y: auto;
  flex: 1; /* Fill remaining space */
  max-height: none; /* Leave room for header */
  padding-bottom: 40px; /* Extra space at bottom so last item isn't hidden */
}

/* Scrollbar styling */
.dpo-notification-list::-webkit-scrollbar {
  width: 8px;
}
.dpo-notification-list::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 6px;
}

.dpo-notification-card {
  display: flex;
  align-items: center;
  gap: 5px;
  border-left: 5px solid transparent;
  background: #f9fafb;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  transition: all 0.2s ease;
  min-height: 80px; /* Ensure consistency */
}


.dpo-notification-card.dpo-assign { border-left-color: #22c55e; }
.dpo-notification-card.dpo-response { border-left-color: #3b82f6; }
.dpo-notification-card.dpo-deadline { border-left-color: #ef4444; }

.dpo-notification-icon span {
  font-size: 1.8rem;
}

.dpo-notification-content {
  
}

.dpo-notification-content h3 {
  font-size: 0.95rem;
  font-weight: 700;
  color: #111827;
  margin: 0 0 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.dpo-notification-content p {
  font-size: 0.9rem;
  color: #4b5563;
  margin: 0;
  line-height: 1.4;
}

.dpo-notification-content .dpo-time {
  display: block;
  font-size: 0.8rem;
  color: #9ca3af;
  margin-top: 6px;
  font-style: italic;
}

.dpo-no-notifications {
  text-align: center;
  padding: 50px 0;
  color: #6b7280;
  font-size: 1.1rem;
}
.dpo-notification-list > .empty-state-card,
.dpo-notification-list > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/DPOPage/DPONotificationPage.jsx">
import React, { useEffect, useState } from "react";
// import axios from "axios";
import DPOHeader from "../../components/DPO/DPOHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import "./DPONotificationPage.css";
import api from "../../api/axios";
import { getAuthValue } from "../../utils/authStorage";
import { LIVE_EVENT_NOTIFICATIONS_UPDATED, addLiveEventListener } from "../../utils/liveUpdates";

function DPONotificationPage() {
  const [notifications, setNotifications] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchNotifications = async () => {
      const username = getAuthValue("username");
      try {
        const res = await api.get("/notifications", {
          params: { username }
        });
        setNotifications(res.data);
      } catch (err) {
        console.error("Error fetching notifications:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchNotifications();
    const onNotificationsUpdated = () => fetchNotifications();
    const unsubscribe = addLiveEventListener(
      LIVE_EVENT_NOTIFICATIONS_UPDATED,
      onNotificationsUpdated
    );
    return unsubscribe;
  }, []);

  return (
    <div className="dpo-notificationpage-container">
      <DPOHeader activeTab="notifications" />

      <div className="dpo-notificationpage-content">
        <div className="dpo-notification-header">
          <h1>Notifications</h1>
        </div>

        <div className="dpo-notification-list">
          {loading ? (
            <LoadingState text="Loading notifications..." />
          ) : notifications.length === 0 ? (
            <EmptyStateCard
              compact
              title="No notifications"
              description="You are all caught up."
            />
          ) : (
            notifications.map((note) => {
              const safeType = note.type || "general";
              return (
                <div key={note.id} className={`dpo-notification-card dpo-${safeType}`}>
                  <div className="dpo-notification-icon">
                    {safeType === "response" && <span>üì©</span>}
                    {safeType === "assign" && <span>üìù</span>}
                    {safeType === "deadline" && <span>‚è∞</span>}
                    {safeType === "general" && <span>üîî</span>}
                  </div>

                  <div className="dpo-notification-content">
                    <h3>{safeType.toUpperCase()}</h3>
                    <p>{note.message}</p>
                    <span className="dpo-time">{note.time_ago}</span>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}

export default DPONotificationPage;
</file>

<file path="client/src/pages/LoginPage.css">
.login-container {
  height: 100vh;
  display: flex;
  background: #eceff1;
  font-family: Arial, sans-serif;
}

/* left side gets 2 parts of space, right side 1 part; add gap between panels */
.login-container {
  height: 100vh;
  display: flex;
  background: #eceff1;
  font-family: Arial, sans-serif;
         /* space between left and right areas */
}

.login-left {
  flex: 2;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #1565c0;
  color: white;
  padding: 40px;
  
  max-width: 65vw;        /* prevent it from growing too huge */
}

.login-right {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  /* ensure it fills full viewport height so card stays centered vertically */
  height: 100vh;
}

.login-card {
  background: white;
  padding: 30px;
  border-radius: 12px;
  width: 350px;
  box-shadow: 0 6px 25px rgba(0,0,0,0.15);
  margin: auto; /* center within login-right */
}

.login-title {
  text-align: center;
  margin-bottom: 20px;
}

.input-field {
  display: flex;
  flex-direction: column;
  margin-bottom: 15px;
}

.input-field label {
  margin-bottom: 5px;
  font-weight: 600;
}

.input-field input {
  padding: 10px;
  border: 1px solid #bbb;
  border-radius: 8px;
  font-size: 14px;
}

.login-btn {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  background: #1565c0;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

.login-btn:hover {
  background: #0d47a1;
}

.error-box {
  background: #ffebee;
  color: #c62828;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 6px;
  text-align: center;
  font-size: 14px;
}
</file>

<file path="backend/api/services.py">
from django.utils import timezone
from django.template.loader import render_to_string
from django.core.mail import EmailMultiAlternatives
from django.conf import settings

from .models import IssueDepartment, User


def check_and_send_overdue_emails():
    today = timezone.now().date()
    sent_count = 0

    # Get only PENDING items that are now overdue
    overdue_entries = IssueDepartment.objects.filter(
        deadline_date__lt=today
    )

    for entry in overdue_entries:

        # 1Ô∏è‚É£ Change status to OVERDUE
        entry.status = "overdue"
        entry.save()

        # 2Ô∏è‚É£ Get department users
        users = User.objects.filter(
            department=entry.department,
            role="department"
        )

        # 3Ô∏è‚É£ Send one email per user for THIS IssueDepartment
        for user in users:

            subject = f"Overdue Issue: {entry.issue.issue_title}"

            context = {
                "user": user,
                "department": entry.department,
                "issue": entry,
            }

            text_content = render_to_string(
                "emails/overdue_issue.txt",
                context
            )

            html_content = render_to_string(
                "emails/overdue_issue.html",
                context
            )

            email = EmailMultiAlternatives(
                subject,
                text_content,
                settings.DEFAULT_FROM_EMAIL,
                [user.email],
            )

            email.attach_alternative(html_content, "text/html")
            email.send()
            sent_count += 1
    
    return sent_count
</file>

<file path="client/src/components/Collector/IssuePage/CollectorFilterBar.jsx">
import React, { useEffect, useState, useRef } from "react";
import "./CollectorFilterBar.css";
import CollectorGenerateReports from "./CollectorGenerateReports";


function CollectorFilterBar({ activeTab, onFilterChange, issue_date }) {
  const [showReportModal, setShowReportModal] = useState(false);
  const [fromDate, setFromDate] = useState("");
  const [toDate, setToDate] = useState("");
  const [filterBy, setFilterBy] = useState("all"); // ‚úÖ default All Issues
  const [sortBy, setSortBy] = useState("newest");
  const [searchQuery, setSearchQuery] = useState("");
  const [activeDateField, setActiveDateField] = useState(null);

  const fromDatePickerRef = useRef(null);
  const toDatePickerRef = useRef(null);

  const handleGenerate = () => {
    setShowReportModal(true);
  };

  // Sync dates from parent
  useEffect(() => {
    if (issue_date?.fromDate) setFromDate(issue_date.fromDate);
    if (issue_date?.toDate) setToDate(issue_date.toDate);
  }, [issue_date]);

  const formatDateInput = (raw) => {
    const digits = raw.replace(/\D/g, "").slice(0, 8);
    if (digits.length <= 2) return digits;
    if (digits.length <= 4) return `${digits.slice(0, 2)}-${digits.slice(2)}`;
    return `${digits.slice(0, 2)}-${digits.slice(2, 4)}-${digits.slice(4)}`;
  };

  const dateKey = (value) => {
    if (!value || typeof value !== "string") return null;
    const [dd, mm, yyyy] = value.split("-");
    if (!dd || !mm || !yyyy || dd.length < 2 || mm.length < 2 || yyyy.length < 4) return null;
    return Number(`${yyyy}${mm}${dd}`);
  };

  const handleFilterChange = (type, value) => {
    let updatedFilters = {
      fromDate,
      toDate,
      filterBy,
      sortBy,
      searchQuery
    };

    if (type === "fromDate") {
      const v = formatDateInput(value);
      setFromDate(v);
      updatedFilters.fromDate = v;
      const fromK = dateKey(v);
      const toK = dateKey(updatedFilters.toDate);
      if (fromK && toK && fromK > toK) {
        setToDate(v);
        updatedFilters.toDate = v;
      }
    } else if (type === "toDate") {
      const v = formatDateInput(value);
      setToDate(v);
      updatedFilters.toDate = v;
      const fromK = dateKey(updatedFilters.fromDate);
      const toK = dateKey(v);
      if (fromK && toK && toK < fromK) {
        setFromDate(v);
        updatedFilters.fromDate = v;
      }
    } else if (type === "filterBy") {
      setFilterBy(value);
      updatedFilters.filterBy = value;
    } else if (type === "sortBy") {
      setSortBy(value);
      updatedFilters.sortBy = value;
    } else if (type === "search") {
      setSearchQuery(value);
      updatedFilters.searchQuery = value;
    }

    onFilterChange(updatedFilters);
  };

  const handleDatePick = (e) => {
    const parts = e.target.value.split("-");
    if (parts.length === 3) {
      const formatted = `${parts[2]}-${parts[1]}-${parts[0]}`;

      if (activeDateField === "from") {
        setFromDate(formatted);
        handleFilterChange("fromDate", formatted);
      } else if (activeDateField === "to") {
        setToDate(formatted);
        handleFilterChange("toDate", formatted);
      }
    }
  };

  const filterLabel = {
    all: "All Issues",
    high: "High Priority",
    medium: "Medium Priority",
    low: "Low Priority",
    health: "Health Dept",
    education: "Education Dept",
    works: "Public Works"
  };

  return (
    <div className="collector-filter-bar">
      {/* Search */}
      <div className="collector-search-wrapper">
        <span className="collector-search-icon">üîç</span>
        <input
          type="text"
          placeholder="Search issues..."
          value={searchQuery}
          onChange={(e) => handleFilterChange("search", e.target.value)}
        />
      </div>

      {/* From Date */}
      <div className="collector-date-input-wrapper">
        <input
          type="text"
          placeholder="From: (dd-mm-yyyy)"
          value={fromDate}
          onChange={(e) => handleFilterChange("fromDate", e.target.value)}
        />
        <span
          className="collector-calendar-icon"
          onClick={() => {
            setActiveDateField("from");
            fromDatePickerRef.current.showPicker();
          }}
        >
          üìÖ
        </span>
        <input
          type="date"
          ref={fromDatePickerRef}
          onChange={handleDatePick}
          style={{ visibility: "hidden", position: "absolute" }}
        />
      </div>

      {/* To Date */}
      <div className="collector-date-input-wrapper">
        <input
          type="text"
          placeholder="To: (dd-mm-yyyy)"
          value={toDate}
          onChange={(e) => handleFilterChange("toDate", e.target.value)}
        />
        <span
          className="collector-calendar-icon"
          onClick={() => {
            setActiveDateField("to");
            toDatePickerRef.current.showPicker();
          }}
        >
          üìÖ
        </span>
        <input
          type="date"
          ref={toDatePickerRef}
          onChange={handleDatePick}
          style={{ visibility: "hidden", position: "absolute" }}
        />
      </div>

      {/* Filter (Nested) */}
      <div className="collector-filter-group collector-custom-filter">
        <label>Filter:</label>
        <div className="collector-filter-dropdown">
          <button className="collector-filter-btn">
            {filterLabel[filterBy]} ‚ñæ
          </button>

          <div className="collector-filter-menu">
            <div className="collector-filter-item">
              Priority ‚ñ∏
              <div className="collector-sub-menu">
                <div onClick={() => handleFilterChange("filterBy", "high")}>High</div>
                <div onClick={() => handleFilterChange("filterBy", "medium")}>Medium</div>
                <div onClick={() => handleFilterChange("filterBy", "low")}>Low</div>
              </div>
            </div>

            <div className="collector-filter-item">
              Department ‚ñ∏
              <div className="collector-sub-menu">
                <div onClick={() => handleFilterChange("filterBy", "health")}>Health</div>
                <div onClick={() => handleFilterChange("filterBy", "education")}>Education</div>
                <div onClick={() => handleFilterChange("filterBy", "works")}>Public Works</div>
              </div>
            </div>

            <div
              className="collector-filter-item"
              onClick={() => handleFilterChange("filterBy", "all")}
            >
              All Issues
            </div>
          </div>
        </div>
      </div>

      {/* Sort */}
<div className="collector-filter-group collector-custom-filter">
  <label>Sort:</label>
  <div className="collector-filter-dropdown">
    <button className="collector-filter-btn">
      {sortBy === "priority"
        ? "Priority"
        : sortBy === "department"
        ? "Department"
        : "Deadline"} ‚ñæ
    </button>

    <div className="collector-filter-menu">
      <div
        className="collector-filter-item"
        onClick={() => handleFilterChange("sortBy", "priority")}
      >
        Priority
      </div>

      <div
        className="collector-filter-item"
        onClick={() => handleFilterChange("sortBy", "department")}
      >
        Department
      </div>

      <div
        className="collector-filter-item"
        onClick={() => handleFilterChange("sortBy", "deadline")}
      >
        Deadline
      </div>
    </div>
  </div>
</div>


      {/* Generate */}
      {activeTab === "Received" && (
        <button className="collector-generate-btn" onClick={handleGenerate}>
          Generate Report
        </button>
      )}

      <CollectorGenerateReports
        isOpen={showReportModal}
        onClose={() => setShowReportModal(false)}
      />
    </div>
  );
}

export default CollectorFilterBar;
</file>

<file path="client/src/components/Collector/IssuePage/CollectorGenerateReports.jsx">
import React, { useState, useEffect, useCallback } from "react";
import "./CollectorGenerateReports.css";
import CollectorGenerateReportCard from "./CollectorGenerateReportCard";
import EmptyStateCard from "../../common/EmptyStateCard";
import LoadingState from "../../common/LoadingState";
import api from "../../../api/axios";
import { getAuthValue } from "../../../utils/authStorage";

export default function GenerateReports({ isOpen, onClose }) {
  const [format, setFormat] = useState("pdf");
  const [reports, setReports] = useState([]);
  const [loadingReports, setLoadingReports] = useState(false);

  const handleDownload = async () => {
    try {
      const res = await fetch(`${api.defaults.baseURL}/generate-report`, {
        method: "POST",
        headers: {
          Authorization: `Token ${getAuthValue("token")}`,
        },
      });

      if (!res.ok) {
        alert("Failed to generate file");
        return;
      }

      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Follow_Up_Report.xlsx";
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      onClose();
    } catch (err) {
      console.error("Download error:", err);
    }
  };

  useEffect(() => {
    if (!isOpen) return;
    setLoadingReports(true);
    setReports([]);

    api
      .get("/issues")
      .then((res) => {
        const receivedLike = (res.data || []).filter((issue) => {
          const status = String(issue.status || "").toLowerCase();
          return ["received", "submitted", "completed"].includes(status);
        });

        const normalized = receivedLike.map((issue) => ({
          id: issue.id,
          issue_no: issue.issue_no,
          department: issue.department || "",
          issue: issue.issue || "",
          issue_description: issue.issue_description || "",
          location: issue.location || "",
          response: Array.isArray(issue.response)
            ? issue.response
                .map((r) => `[${r.department || "Department"}] ${r.text || ""}`.trim())
                .join("\n")
            : issue.response || "",
        }));

        setReports(normalized);
      })
      .catch((err) => console.error("Error fetching reports:", err))
      .finally(() => setLoadingReports(false));
  }, [isOpen]);

  const handleChange = useCallback((index, field, value) => {
    setReports((prev) => {
      const updated = [...prev];
      updated[index] = { ...updated[index], [field]: value };
      return updated;
    });
  }, []);

  const removeCard = useCallback((index) => {
    setReports((prev) => prev.filter((_, i) => i !== index));
  }, []);

  if (!isOpen) return null;

  return (
    <div className="collector-modal-overlay">
      <div
        className="collector-generate-reports-container"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="collector-generate-header">
          <div className="collector-format-toggle">
            <button
              className={`collector-format-btn ${format === "pdf" ? "collector-active" : ""}`}
              onClick={() => setFormat("pdf")}
            >
              PDF
            </button>
            <button
              className={`collector-format-btn ${format === "excel" ? "collector-active" : ""}`}
              onClick={() => setFormat("excel")}
            >
              Excel
            </button>
          </div>

          <button className="collector-close" onClick={onClose}>
            &times;
          </button>
        </div>

        <div className="collector-report-list">
          {loadingReports ? (
            <LoadingState compact text="Loading received issues..." />
          ) : reports.length === 0 ? (
            <EmptyStateCard
              compact
              title="No received issues"
              description="Received issues will appear here for report generation."
            />
          ) : (
            reports.map((report, index) => (
              <CollectorGenerateReportCard
                key={report.id || index}
                report={report}
                index={index}
                handleChange={handleChange}
                removeCard={removeCard}
              />
            ))
          )}
        </div>

        <div className="collector-download-section">
          <button className="collector-generate-download-btn" onClick={handleDownload}>
            Download Report
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOFilterBar.css">
.dpo-filter-bar {
  display: flex;
  gap: 15px;
  align-items: center;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  /* margin-bottom: 20px; */

  position: relative;
  transition: all 0.2s ease;
}

/* ================= SEARCH ================= */

.dpo-search-wrapper {
  position: relative;
  display: flex;
  align-items: center;
  flex: 1;
  min-width: 200px;
  max-width: 400px;
}

.dpo-search-wrapper input {
  padding: 10px 35px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 100%;
}

.dpo-search-icon {
  position: absolute;
  left: 10px;
  user-select: none;
}

/* ================= DATE INPUT ================= */

.dpo-date-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.dpo-date-input-wrapper input {
  padding: 10px 35px 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
}

.dpo-calendar-icon {
  position: absolute;
  right: 10px;
  font-size: 1rem;
  color: #666;
  cursor: pointer;
  user-select: none;
}

/* ================= FILTER / SORT GROUP ================= */

.dpo-filter-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

.dpo-filter-group label {
  color: #f00;
  font-size: 0.9rem;
  min-width: 60px;
}

/* ===== COMMON CONTROL STYLE (Filter & Sort SAME) ===== */

.dpo-filter-select,
.dpo-filter-btn {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
  width: 160px;
  background: white;
  color: #000;
  cursor: pointer;
  text-align: left;
}

/* ================= GENERATE BUTTON ================= */

.dpo-generate-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s ease;
  margin-left: auto;
}

.dpo-generate-btn:hover {
  background: #1d4ed8;
}

/* ---------- Send Email Button ---------- */
.dpo-send-email-btn {
  background: #af381a;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-left: auto;
  font-weight: 600;
}

.dpo-send-email-btn:hover:not(:disabled) {
  background: #992d13;
  transform: scale(1.02);
}

.dpo-send-email-btn:disabled {
  background: #9ca3af;
  cursor: not-allowed;
  opacity: 0.7;
}

.dpo-send-email-btn.dpo-loading {
  opacity: 0.7;
  cursor: not-allowed;
}



.dpo-email-status-popup {
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 10px;
  background: #1f2937;
  color: white;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 0.85rem;
  animation: fadeIn 0.3s ease;
  z-index: 100;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  white-space: nowrap;
}

/* ================= UPLOAD BUTTON ================= */

.dpo-upload-btn {
  position: absolute;
  right: 12px;
  top: -18px;
  z-index: 20;
  background: #10b981;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  box-shadow: 0 6px 12px rgba(16, 185, 129, 0.12);
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.dpo-upload-btn img {
  width: 14px;
  height: 14px;
}

.dpo-upload-btn:hover {
  background: #059669;
}

/* ================= CUSTOM FILTER DROPDOWN ================= */

.dpo-custom-filter,
.dpo-filter-dropdown {
  position: relative;

}

/* Dropdown Menu */
.dpo-filter-menu {
  display: none;
  position: absolute;
  top: 39px;
  left: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
  z-index: 50;
}

.dpo-filter-dropdown:hover .dpo-filter-menu {
  display: block;
}

/* Dropdown Items */
.dpo-filter-item {
  padding: 10px 12px;
  cursor: pointer;
  position: relative;
  white-space: nowrap;
}

.dpo-filter-item:hover {
  background: #f3f4f6;
}

/* ================= SUB MENU ================= */

.dpo-sub-menu {
  display: none;
  position: absolute;
  top: 0;
  left: 100%;
  background: white;
  border: 1px solid #ddd;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
}

.dpo-filter-item:hover .dpo-sub-menu {
  display: block;
}

.dpo-sub-menu div {
  padding: 10px 12px;
}

.dpo-sub-menu div:hover {
  background: #e5e7eb;
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOGenerateReports.jsx">
import React, { useState, useEffect, useCallback } from "react";
import html2pdf from "html2pdf.js";
import "./DPOGenerateReports.css";
import DPOGenerateReportCard from "./DPOGenerateReportCard";
import EmptyStateCard from "../../common/EmptyStateCard";
import LoadingState from "../../common/LoadingState";
import api from "../../../api/axios";
import { getAuthValue } from "../../../utils/authStorage";

export default function GenerateReports({ isOpen, onClose }) {
  const [format, setFormat] = useState("pdf");
  const [reports, setReports] = useState([]);
  const [loadingReports, setLoadingReports] = useState(false);

  const handleDownload = async () => {
    // ==========================================
    // FRONTEND PDF GENERATION (Perfect Malayalam)
    // ==========================================
    if (format === "pdf") {
      const element = document.getElementById("pdf-presentation-content");
      
      const opt = {
        margin: 0,
        filename: "DDC_Presentation.pdf",
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "in", format: "a4", orientation: "landscape" },
        pagebreak: { mode: 'legacy' } // <--- THIS FIXES THE BLANK PAGE ISSUE
      };

      html2pdf().set(opt).from(element).save();
      onClose();
      return;
    }
    // ==========================================
    // BACKEND EXCEL GENERATION
    // ==========================================
    try {
      const payload = {
        format: "excel",
        reports: reports, 
      };

      const response = await fetch(`${api.defaults.baseURL}/generate-report`, {
        method: "POST",
        headers: {
          Authorization: `Token ${getAuthValue("token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        alert("Failed to generate report");
        return;
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Follow_Up_Report.xlsx";
      document.body.appendChild(a);
      a.click();

      a.remove();
      window.URL.revokeObjectURL(url);
      onClose();
    } catch (err) {
      console.error("Download error:", err);
      alert("Error downloading file.");
    }
  };

  useEffect(() => {
    if (!isOpen) return;
    setLoadingReports(true);
    setReports([]);

    api
      .get("/issues")
      .then((res) => {
        const receivedLike = (res.data || []).filter((issue) => {
          const status = String(issue.status || "").toLowerCase();
          return ["received", "submitted", "completed"].includes(status);
        });

        const normalized = receivedLike.map((issue) => ({
          id: issue.id,
          issue_no: issue.issue_no,
          department: issue.department || "",
          issue: issue.issue || "",
          location: issue.location || "",
          response: Array.isArray(issue.response)
            ? issue.response
                .map((r) => `[${r.department || "Department"}] ${r.text || ""}`.trim())
                .join("\n")
            : issue.response || "",
        }));

        setReports(normalized);
      })
      .catch((err) => console.error("Error fetching reports:", err))
      .finally(() => setLoadingReports(false));
  }, [isOpen]);

  const handleChange = useCallback((index, field, value) => {
    setReports((prev) => {
      const updated = [...prev];
      updated[index] = { ...updated[index], [field]: value };
      return updated;
    });
  }, []);

  const removeCard = useCallback((index) => {
    setReports((prev) => prev.filter((_, i) => i !== index));
  }, []);

  if (!isOpen) return null;

  return (
    <>
      <div className="dpo-modal-overlay">
        <div className="dpo-generate-reports-container" onClick={(e) => e.stopPropagation()}>
          <div className="dpo-generate-header">
            <div className="dpo-format-toggle">
              <button
                className={`dpo-format-btn ${format === "pdf" ? "dpo-active" : ""}`}
                onClick={() => setFormat("pdf")}
              >
                PDF
              </button>
              <button
                className={`dpo-format-btn ${format === "excel" ? "dpo-active" : ""}`}
                onClick={() => setFormat("excel")}
              >
                Excel
              </button>
            </div>
            <button className="dpo-close" onClick={onClose}>&times;</button>
          </div>

          <div className="dpo-report-list">
            {loadingReports ? (
              <LoadingState compact text="Loading received issues..." />
            ) : reports.length === 0 ? (
              <EmptyStateCard compact title="No received issues" description="Received issues will appear here for report generation." />
            ) : (
              reports.map((report, index) => (
                <DPOGenerateReportCard
                  key={report.id || index}
                  report={report}
                  index={index}
                  handleChange={handleChange}
                  removeCard={removeCard}
                />
              ))
            )}
          </div>

          <div className="dpo-download-section">
            <button className="dpo-generate-download-btn" onClick={handleDownload}>
              Download Report
            </button>
          </div>
        </div>
      </div>

      {/* ===============================================================
          HIDDEN PDF TEMPLATE (This renders off-screen for html2pdf)
          =============================================================== */}
      <div style={{ position: "absolute", left: "-9999px", top: "-9999px" }}>
        <div id="pdf-presentation-content" style={{ width: "1122px", fontFamily: "sans-serif" }}>
          {reports.map((report, index) => (
            <React.Fragment key={index}>
              {/* SLIDE 1: THE ISSUE */}
              <div style={{ width: "100%", height: "785px", padding: "60px", backgroundColor: "white", position: "relative", boxSizing: "border-box" }}>
                <div style={{ backgroundColor: "#1e3a8a", color: "white", padding: "12px 24px", fontSize: "28px", fontWeight: "bold", marginBottom: "40px", display: "inline-block" }}>
                  Issue: {report.issue_no}
                </div>
                <div style={{ fontSize: "32px", lineHeight: "1.6", color: "#000" }}>
                  {report.issue}
                </div>
                {/* Department tag at bottom right */}
                <div style={{ position: "absolute", bottom: "60px", right: "60px", color: "#dc2626", fontSize: "28px", fontWeight: "bold" }}>
                  {report.department}
                </div>
              </div>

              {/* Force Page Break Between Issue and Response using html2pdf class */}
              <div className="html2pdf__page-break"></div>

              {/* SLIDE 2: THE RESPONSE */}
              <div style={{ width: "100%", height: "785px", padding: "60px", backgroundColor: "white", position: "relative", boxSizing: "border-box" }}>
                <div style={{ backgroundColor: "#0284c7", color: "white", padding: "12px 24px", fontSize: "28px", fontWeight: "bold", marginBottom: "40px", display: "inline-block" }}>
                  ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥Ö‡¥µ‡¥∏‡µç‡¥• / Action Taken
                </div>
                <div style={{ fontSize: "30px", lineHeight: "1.6", color: "#000", whiteSpace: "pre-wrap" }}>
                  {report.response || "No response yet."}
                </div>
              </div>

              {/* Force Page Break Before Next Issue (Except for the very last slide) */}
              {index !== reports.length - 1 && (
                <div className="html2pdf__page-break"></div>
              )}
            </React.Fragment>
          ))}
        </div>
      </div>
    </>
  );
}
</file>

<file path="client/src/components/DPO/IssuePage/DPOIssueCard.jsx">
import React, { useState } from "react";
import "./DPOIssueCard.css";
import api from "../../../api/axios";

function IssueCard({ issue }) {
  const [showLog, setShowLog] = useState(false);
  const status = issue.status || "pending";

  const getStatusStyle = () => {
    switch (status) {
      case "overdue":
        return { borderColor: "#b91c1c" };
      case "submitted":
      case "received":
        return { borderColor: "#16a34a" };
      default:
        return { borderColor: "#facc15" };
    }
  };

  // ‚úÖ Now backend provides structured logs
  const timeline = issue.logs || [];

  return (
    <>
      <div className="dpo-issue-card" style={getStatusStyle()}>
        <div className="dpo-issue-header">
          <span className="dpo-issue-id">{issue.issue_no}</span>

          <span
            className={`dpo-status ${
              status === "submitted"
                ? "dpo-received"
                : "dpo-" + status
            }`}
          >
            {status === "submitted" ? "Received" : status}
          </span>
        </div>

        <div className="dpo-issue-row">
          <div className="dpo-label">Issue</div>
          <div className="dpo-value">{issue.issue}</div>
        </div>

        <div className="dpo-issue-row">
          <div className="dpo-label">Description</div>
          <div className="dpo-value">{issue.issue_description}</div>
        </div>

        <div className="dpo-issue-body">
          <div className="dpo-issue-row">
            <div className="dpo-label">Department</div>
            <div className="dpo-value">{issue.department}</div>
          </div>

          <div className="dpo-issue-row">
            <div className="dpo-label">Priority</div>
            <div className="dpo-value">{issue.priority}</div>
          </div>

          <div className="dpo-issue-row">
            <div className="dpo-label">Location</div>
            <div className="dpo-value">{issue.location}</div>
          </div>

          <div className="dpo-issue-row">
            <div
              className={`dpo-label ${
                status === "overdue" ? "dpo-overdue-text" : ""
              }`}
            >
              Deadline
            </div>
            <div
              className={`dpo-value ${
                status === "overdue" ? "dpo-overdue-text" : ""
              }`}
            >
              {issue.deadline}
            </div>
          </div>
        </div>

        <div className="dpo-issue-footer">
          <div className="dpo-footer-line"></div>

          {/* RESPONSE DISPLAY */}
          {(!issue.response || issue.response.length === 0) &&
            status === "pending" && (
              <p className="dpo-no-response">
                No response received yet
              </p>
            )}

          {status === "overdue" && (
            <p className="dpo-no-response">
              Response overdue ‚ö†Ô∏è
            </p>
          )}

          {issue.response && issue.response.length > 0 && (
            <div
              className="dpo-response-container"
              style={{ marginTop: "10px" }}
            >
              {issue.response.map((resObj, index) => (
                <div
                  key={index}
                  className="dpo-response-received"
                >
                  <p className="dpo-res">
                    <strong>{resObj.department}:</strong>{" "}
                    {resObj.text}
                  </p>

                  {resObj.attachment && (
                    <button
                      className="dpo-res-button"
                      style={{
                        position: "static",
                        marginTop: "10px",
                      }}
                      onClick={() => {
                        const baseUrl =
                          api.defaults.baseURL;
                        const fullUrl =
                          resObj.attachment.startsWith(
                            "http"
                          )
                            ? resObj.attachment
                            : `${baseUrl}${resObj.attachment}`;
                        window.open(fullUrl, "_blank");
                      }}
                    >
                      Download Attachment
                    </button>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* LOG BUTTON */}
          <button
            className="dpo-log-btn"
            onClick={() => setShowLog(true)}
          >
            Log
          </button>
        </div>
      </div>

      {/* LOG MODAL */}
      {showLog && (
        <div className="dpo-log-overlay">
          <div
            className="dpo-log-backdrop"
            onClick={() => setShowLog(false)}
          ></div>

          <div className="dpo-log-modal">
            <div className="dpo-log-header">
              <h3>Issue Log - {issue.issue_no}</h3>
              <button
                className="dpo-log-close"
                onClick={() => setShowLog(false)}
              >
                ‚úï
              </button>
            </div>

            <div className="dpo-log-body">
              {timeline.length === 0 ? (
                <p>No log history available</p>
              ) : (
                timeline.map((log, index) => (
                  <div
                    key={log.id || index}
                    className="dpo-log-entry"
                  >
                    <div className="dpo-log-dot"></div>

                    <div>
                      <strong>{log.title}</strong>

                      {log.department && (
                        <p>
                          <strong>Department:</strong>{" "}
                          {log.department}
                        </p>
                      )}

                      {log.description && (
                        <p className="dpo-log-msg">
                          {log.description}
                        </p>
                      )}

                      <p className="dpo-log-date">
                        {new Date(
                          log.created_at
                        ).toLocaleString()}
                      </p>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      )}
    </>
  );
}

export default IssueCard;
</file>

<file path="client/src/components/DPO/UploadPage/DPOAssignIssues.jsx">
import React, { useState, useEffect,useRef } from "react";
import "./DPOAssignIssues.css";
import { Link } from "react-router-dom";
import DPOIssueAssignCard from "./DPOIssueAssignCard";
import EmptyStateCard from "../../common/EmptyStateCard";
import api from "../../../api/axios";
import { getDraftById, removeDraft, saveDraft } from "../../../utils/dpoDrafts";
import { emitIssuesUpdated, emitNotificationsUpdated } from "../../../utils/liveUpdates";

const DUMMY_UNRESOLVED_ISSUES = [
  { id: "unr-101", title: "Road widening pending near market junction" },
  { id: "unr-102", title: "Drainage blockage in ward 7 unresolved" },
  { id: "unr-103", title: "Streetlight maintenance issue not completed" },
  { id: "unr-104", title: "Water supply complaint still open" },
];

export default function AssignIssues({ draftId = null }) {
  const [issues, setIssues] = useState([]);
  const [minutesId, setMinutesId] = useState(null);
  const [openFlagForIssue, setOpenFlagForIssue] = useState(null);
  const [mappedIssues, setMappedIssues] = useState({});
  const [showLogModal, setShowLogModal] = useState(false);

  const applyDefaultDeadlines = (sourceIssues) => {
    return (sourceIssues || []).map((issue) => {
      if (!issue.deadline || issue.deadline.trim() === "") {
        const today = new Date();
        const deadline = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
        const day = String(deadline.getDate()).padStart(2, "0");
        const month = String(deadline.getMonth() + 1).padStart(2, "0");
        const year = deadline.getFullYear();
        return { ...issue, deadline: `${day}-${month}-${year}` };
      }
      return issue;
    });
  };

  useEffect(() => {
    const fetchIssuesFromServer = async () => {
      try {
        const res = await api.get("/assign-issues");
        const normalized = applyDefaultDeadlines(Array.isArray(res.data) ? res.data : []);
        setIssues(normalized);
        return normalized;
      } catch (err) {
        console.error("Failed to load issues:", err);
        setIssues([]);
        return [];
      }
    };

    if (draftId) {
      const draft = getDraftById(draftId);
      const draftIssues = Array.isArray(draft?.issues) ? draft.issues : [];

      if (draftIssues.length > 0) {
        setIssues(applyDefaultDeadlines(draftIssues));
        setMinutesId(draft.minutesId || null);
      } else {
        setMinutesId(draft?.minutesId || null);
        fetchIssuesFromServer().then((serverIssues) => {
          if (draft) {
            saveDraft({
              ...draft,
              issues: serverIssues,
              minutesId: draft.minutesId || null,
            });
          }
        });
      }
      return;
    }

    fetchIssuesFromServer();
    setMinutesId(null);
  }, [draftId]);

  const handleChange = (index, field, value) => {
    setIssues((prev) => {
      const updated = [...prev];
      updated[index] = { ...updated[index], [field]: value };
      return updated;
    });
  };

  useEffect(() => {
    if (!draftId) return;
    const draft = getDraftById(draftId);
    if (!draft) return;

    saveDraft({
      ...draft,
      issues,
      minutesId: draft.minutesId || minutesId || null,
    });
  }, [draftId, issues, minutesId]);

  const handleAllocateAll = () => {
    api
      .post("/assign-issues/allocate-all", { issues, minutes_id: minutesId })
      .then(() => {
        if (draftId) removeDraft(draftId);
        alert("All issues allocated!");
        emitIssuesUpdated({ source: "dpo-allocate-all" });
        emitNotificationsUpdated({ source: "dpo-allocate-all" });
      })
      .catch((err) => console.error(err));
  };

  const handleAllocateIssue = (issue, index) => {
    api
      .post("/assign-issues/allocate-single", { issue, minutes_id: minutesId })
      .then(() => {
        setIssues((prev) => prev.filter((_, i) => i !== index));
        emitIssuesUpdated({ source: "dpo-allocate-single" });
        emitNotificationsUpdated({ source: "dpo-allocate-single" });
      })
      .catch((err) => console.error(err));
  };

  const handleDeleteIssue = (index) => {
    setIssues((prev) => prev.filter((_, i) => i !== index));
  };

  const getIssueKey = (issue, index) => `${issue.issue_no || "issue"}-${index}`;

  const handleToggleFlagPanel = (issueKey) => {
    setOpenFlagForIssue((prev) => (prev === issueKey ? null : issueKey));
  };

  const handleMapIssue = (issueKey, unresolvedId) => {
    setMappedIssues((prev) => ({ ...prev, [issueKey]: unresolvedId }));
    setOpenFlagForIssue(null);
  };

  return (
    <div className="dpo-assign-issues-container">
      <div className="dpo-assign-header">
        <h2>Assign Issues</h2>
        <Link to="/dpo/home">
          <button className="dpo-allocate-btn" onClick={handleAllocateAll}>
            Allocate All
          </button>
        </Link>
      </div>

      {issues.length === 0 && (
        <EmptyStateCard
          compact
          title="No pending issues"
          description="No pending issues found."
        />
      )}

      <div className="dpo-issue-cards">
        {issues.map((issue, index) => {
          const issueKey = getIssueKey(issue, index);
          return (
          <DPOIssueAssignCard
            key={issueKey}
            issue={issue}
            index={index}
            onChange={handleChange}
            onAllocate={handleAllocateIssue}
            onDelete={handleDeleteIssue}
            unresolvedIssues={DUMMY_UNRESOLVED_ISSUES}
            isFlagPanelOpen={openFlagForIssue === issueKey}
            mappedUnresolvedId={mappedIssues[issueKey] || null}
            onToggleFlagPanel={() => handleToggleFlagPanel(issueKey)}
            onMapIssue={(unresolvedId) => handleMapIssue(issueKey, unresolvedId)}
          />
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="client/src/components/DPO/UploadPage/DPOIssueAssignCard.jsx">
import React, { useRef } from "react";
import DeleteIcon from "@mui/icons-material/Delete";
import OutlinedFlagIcon from "@mui/icons-material/OutlinedFlag";
import FlagIcon from "@mui/icons-material/Flag";

export default function IssueAssignCard({
  issue,
  onChange,
  index,
  onAllocate,
  onDelete,
  unresolvedIssues = [],
  isFlagPanelOpen = false,
  mappedUnresolvedId = null,
  onToggleFlagPanel,
  onMapIssue,
}) {
  const dateRef = useRef(null);

  const handleChange = (field, value) => onChange(index, field, value);

  const formatDateInput = (text) => {
    const digits = text.replace(/\D/g, "");
    const day = digits.substring(0, 2);
    const month = digits.substring(2, 4);
    const year = digits.substring(4, 8);

    let formatted = day;
    if (month) formatted += `-${month}`;
    if (year) formatted += `-${year}`;
    return formatted;
  };

  const convertDatePickerValue = (value) => {
    const [y, m, d] = value.split("-");
    return `${d}-${m}-${y}`;
  };

  return (
    <div className="dpo-issue-assign-card">
      <div className="dpo-issue-top">
        <div className="dpo-entry-id">{issue.issue_no}</div>
        <button
          className={`dpo-flag-btn ${mappedUnresolvedId ? "dpo-flag-btn-mapped" : ""}`}
          onClick={onToggleFlagPanel}
          title="Map with unresolved issue"
        >
          {mappedUnresolvedId ? <FlagIcon fontSize="small" /> : <OutlinedFlagIcon fontSize="small" />}
        </button>
      </div>

      {isFlagPanelOpen && (
        <div className="dpo-unresolved-panel">
          <p className="dpo-unresolved-title">Map to unresolved issue</p>
          <div className="dpo-unresolved-list">
            {unresolvedIssues.map((item) => (
              <label key={item.id} className="dpo-unresolved-item">
                <input
                  type="radio"
                  name={`unresolved-map-${index}`}
                  checked={mappedUnresolvedId === item.id}
                  onChange={() => onMapIssue?.(item.id)}
                />
                <span>{item.title}</span>
              </label>
            ))}
          </div>
        </div>
      )}

      <div className="dpo-issue-form">
        <div className="dpo-form-field">
          <label>Department:</label>
          <input
            type="text"
            value={issue.department}
            onChange={(e) => handleChange("department", e.target.value)}
          />
        </div>

        <div className="dpo-form-field">
          <label>Issue title:</label>
          <textarea rows="2" value={issue.issue} onChange={(e) => handleChange("issue", e.target.value)} />
        </div>

        <div className="dpo-form-field">
          <label>Description:</label>
          <textarea
            className="dpo-description-textarea"
            rows="4"
            value={issue.issue_description}
            onChange={(e) => handleChange("issue_description", e.target.value)}
          />
        </div>

        <div className="dpo-form-field">
          <label>Priority:</label>
          <select value={issue.priority} onChange={(e) => handleChange("priority", e.target.value)}>
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
        </div>

        <div className="dpo-form-field">
          <label>Location:</label>
          <input
            type="text"
            value={issue.location}
            onChange={(e) => handleChange("location", e.target.value)}
          />
        </div>

        <div className="dpo-form-field">
          <label>Deadline:</label>
          <div className="dpo-deadline-input">
            <input
              type="text"
              placeholder="DD-MM-YYYY"
              value={issue.deadline}
              onChange={(e) => handleChange("deadline", formatDateInput(e.target.value))}
            />

            <input
              type="date"
              ref={dateRef}
              style={{ display: "none" }}
              onChange={(e) => handleChange("deadline", convertDatePickerValue(e.target.value))}
            />

            <span className="dpo-calendar-icon" onClick={() => dateRef.current?.showPicker?.()}>
              üìÖ
            </span>
          </div>
        </div>
      </div>

      <div className="dpo-card-bottom-actions">
        {typeof onDelete === "function" && (
          <button className="dpo-delete-btn" onClick={() => onDelete(index)} title="Delete issue">
            <DeleteIcon fontSize="medium" />
          </button>
        )}
        {typeof onAllocate === "function" && (
          <button className="dpo-inline-allocate-btn" onClick={() => onAllocate(issue, index)}>
            Allocate
          </button>
        )}
      </div>
    </div>
  );
}
</file>

<file path="client/src/pages/CollectorPage/CollectorIssuePage.css">
.collector-issuepage-container {
  width: 100%;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.collector-issuepage-container .collector-issuepage-content {
  padding: 10px 70px;
  position: relative;
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ---------- Title ---------- */
.collector-issuepage-container .collector-page-title {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-shrink: 0;
  margin-bottom: 20px;
}

.collector-issuepage-container .collector-page-title h1 {
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

.collector-tab-scroll-area {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  padding-right: 10px;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 transparent;
}

/* Custom scrollbar for Webkit browsers */
.collector-tab-scroll-area::-webkit-scrollbar {
  width: 6px;
}

.collector-tab-scroll-area::-webkit-scrollbar-track {
  background: transparent;
}

.collector-tab-scroll-area::-webkit-scrollbar-thumb {
  background-color: #cbd5e1;
  border-radius: 20px;
}

@keyframes fadeIn {
  from {
    opacity: 0.3;
    transform: translateY(3px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.collector-no-issues {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  background: #f3f4f6;
  border-radius: 12px;
}

.collector-loading-text {
  opacity: 0.7;
}

.collector-tab-scroll-area > .empty-state-card,
.collector-tab-scroll-area > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/CollectorPage/CollectorMinutesPage.css">
.collector-minutespage-container {
  width: 100%;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.collector-minutespage-container .collector-minutespage-content {
  padding: 10px 70px;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.collector-minutespage-container .collector-minutes-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

.collector-minutespage-container .collector-page-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 20px;
  color: #1f2937;
}

.collector-minutespage-container .collector-loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  gap: 20px;
}

.collector-minutespage-container .collector-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #e5e7eb;
  border-top-color: #2563eb;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.collector-minutespage-container .collector-loading-text {
  color: #6b7280;
  font-size: 1rem;
}

.collector-minutespage-container .collector-error-message {
  background: #fee;
  color: #dc2626;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #dc2626;
}

.collector-minutespage-container .collector-no-minutes {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  gap: 16px;
  color: #9ca3af;
}

.collector-minutespage-container .collector-empty-icon {
  font-size: 64px;
  opacity: 0.5;
}

.collector-minutespage-container .collector-no-minutes p {
  font-size: 1.2rem;
  margin: 0;
}

.collector-minutespage-container .collector-minutes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
}

.collector-minutespage-container .collector-minutes-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid #e5e7eb;
}

.collector-minutespage-container .collector-minutes-card:hover {
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
  transform: translateY(-2px);
}

.collector-minutespage-container .collector-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.collector-minutespage-container .collector-pdf-icon {
  font-size: 32px;
  color: #dc2626;
  flex-shrink: 0;
}

.collector-minutespage-container .collector-file-name {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: #1f2937;
  word-break: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

.collector-minutespage-container .collector-card-body {
  padding: 16px;
}

.collector-minutespage-container .collector-info-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 8px;
  font-size: 0.9rem;
}

.collector-minutespage-container .collector-info-item:last-child {
  margin-bottom: 0;
}

.collector-minutespage-container .collector-info-item .collector-label {
  font-weight: 600;
  color: #6b7280;
  min-width: 120px;
}

.collector-minutespage-container .collector-info-item .collector-value {
  color: #1f2937;
  text-align: right;
  flex: 1;
  word-break: break-word;
}

.collector-minutespage-container .collector-card-actions {
  display: flex;
  gap: 10px;
  padding: 12px 16px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.collector-minutespage-container .collector-action-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  color: white;
}

.collector-minutespage-container .collector-view-btn {
  background: #2563eb;
}

.collector-minutespage-container .collector-view-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.collector-minutespage-container .collector-download-btn {
  background: #10b981;
}

.collector-minutespage-container .collector-download-btn:hover {
  background: #059669;
  transform: translateY(-1px);
}

.collector-minutespage-container .collector-btn-icon {
  font-size: 18px;
}

@media (max-width: 768px) {
  .collector-minutespage-container .collector-minutespage-content {
    padding: 20px;
  }

  .collector-minutespage-container .collector-minutes-grid {
    grid-template-columns: 1fr;
  }

  .collector-minutespage-container .collector-page-title {
    font-size: 1.5rem;
  }

  .collector-minutespage-container .collector-info-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .collector-minutespage-container .collector-info-item .collector-label {
    min-width: unset;
  }

  .collector-minutespage-container .collector-info-item .collector-value {
    text-align: left;
  }
}

.collector-minutespage-container .collector-minutes-body > .empty-state-card,
.collector-minutespage-container .collector-minutes-body > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/CollectorPage/NotificationPage.css">
/* Base layout */
.collector-container {
  width: 100%;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.collector-container .collector-content {
  padding: 10px 70px;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.collector-container h1 {
  font-size: 2rem;
  font-weight: 700;
  margin: 0 0 20px;
  color: #111;
}

/* Notification List */
.collector-container .collector-notification-list {
  background: #ffffff;
  border-radius: 12px;
  padding: 15px;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}

/* Notification Card */
.collector-container .collector-notification-card {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  border-left: 5px solid transparent;
  background: #f9fafb;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  transition: all 0.2s ease;
}

.collector-container .collector-notification-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
}

.collector-container .collector-notification-card.collector-response {
  border-left-color: #3b82f6;
}

.collector-container .collector-notification-card.collector-deadline {
  border-left-color: #ef4444;
}

.collector-container .collector-notification-card.collector-assign {
  border-left-color: #22c55e;
}

/* Icon */
.collector-container .collector-notification-icon span {
  font-size: 1.6rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Text */
.collector-container .collector-notification-content h3 {
  font-size: 1rem;
  font-weight: 600;
  color: #111827;
  margin: 0 0 4px;
}

.collector-container .collector-notification-content p {
  font-size: 0.9rem;
  color: #4b5563;
  margin: 0;
}

.collector-container .collector-notification-content .collector-time {
  display: block;
  font-size: 0.8rem;
  color: #9ca3af;
  margin-top: 4px;
}

/* Empty state */
.collector-container .collector-no-notifications {
  text-align: center;
  padding: 50px 0;
  color: #6b7280;
  font-size: 0.95rem;
}

.collector-container .collector-notification-list > .empty-state-card,
.collector-container .collector-notification-list > .loading-state {
  margin-top: 0;
  min-height: 100%;
}

/* Responsive */
@media (max-width: 768px) {
  .collector-container .collector-content {
    padding: 15px 25px;
  }

  .collector-container .collector-notification-list {
    padding: 12px;
  }
}
</file>

<file path="client/src/pages/DepartmentPage/DepartmentMinutesPage.css">
.department-container .department-page-title {
  font-size: 2rem;
  font-weight: 700;
  margin-top:22px;
  color: #1f2937;
}

.department-container .department-minutes-page-content {
 padding: 10px 70px;
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.department-container .department-minutes-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

/* Loading State */
.department-container .department-loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  gap: 20px;
}

.department-container .department-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #e5e7eb;
  border-top-color: #2563eb;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.department-container .department-loading-text {
  color: #6b7280;
  font-size: 1rem;
}

/* Error State */
.department-container .department-error-message {
  background: #fee;
  color: #dc2626;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #dc2626;
}

/* Empty State */
.department-container .department-no-minutes {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  gap: 16px;
  color: #9ca3af;
}

.department-container .department-empty-icon {
  font-size: 64px;
  opacity: 0.5;
}

.department-container .department-no-minutes p {
  font-size: 1.2rem;
  margin: 0;
}

.department-container .department-minutes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
}
/* Card Styling */
.department-container .department-minutes-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid #e5e7eb;
}


/* Card Header */
.department-container .department-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.department-container .department-pdf-icon {
  font-size: 32px;
  color: #dc2626;
  flex-shrink: 0;
}

.department-container .department-file-name {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: #1f2937;
  word-break: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* Card Body */
.department-container .department-card-body {
  padding: 16px;
}

.department-container .department-info-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 8px;
  font-size: 0.9rem;
}

.department-container .department-info-item:last-child {
  margin-bottom: 0;
}

.department-container .department-info-item .department-label {
  font-weight: 600;
  color: #6b7280;
  min-width: 120px;
}

.department-container .department-info-item .department-value {
  color: #1f2937;
  text-align: right;
  flex: 1;
  word-break: break-word;
}

/* Card Actions */
.department-container .department-card-actions {
  display: flex;
  gap: 10px;
  padding: 12px 16px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.department-container .department-action-btn {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 12px;
  border: none;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  color: white;
}

.department-container .department-view-btn {
  background: #2563eb;
  color: white;
}

.department-container .department-view-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.department-container .department-download-btn {
  background: #10b981;
  color: white;
}

.department-container .department-download-btn:hover {
  background: #059669;
  transform: translateY(-1px);
}

.department-container .department-btn-icon {
  font-size: 18px;
}

/* Responsive */
@media (max-width: 768px) {
  .department-container .department-minutes-grid {
    grid-template-columns: 1fr;
  }

  .department-container .department-page-title {
    font-size: 1.5rem;
  }

  .department-container .department-info-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .department-container .department-info-item .department-label {
    min-width: unset;
  }

  .department-container .department-info-item .department-value {
    text-align: left;
  }
}

.department-container .department-minutes-body > .empty-state-card,
.department-container .department-minutes-body > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/DepartmentPage/DepartmentResponsePage.css">
.department-container {
  width: 100%;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.department-container .department-content {
  padding: 10px 70px;
  flex: 1;
  min-height: 0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.department-container h1 {
  font-size: 2rem;
  font-weight: 700;
    margin-bottom: 20px;
  color: #111;
}

.department-filters {
  display: flex;
  gap: 15px;
  align-items: center;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  margin-bottom: 20px;
}

.department-filters input,
.department-filters select {
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.9rem;
}

.department-generate-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
}

.department-generate-btn:hover {
  background: #1d4ed8;
}

.department-page-title {
  display: flex;
  justify-content: space-between;

}

.department-upload-icon {
  color: black;
  border-radius: 8px;
  /* keep it slightly rounded, not circular */
  padding: 2px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
  background: transparent;
  margin-top: 40px;
  margin-right: 5px;
}

.department-upload-icon:hover {
  color: #1d4ed8;
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
}

.department-upload-icon {
  font-size: 35px !important;
  width: 35px !important;
  height: 35px !important;
}

.department-tab-scroll-area {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  padding-right: 10px;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 transparent;
}

.department-tab-scroll-area::-webkit-scrollbar {
  width: 6px;
}

.department-tab-scroll-area::-webkit-scrollbar-track {
  background: transparent;
}

.department-tab-scroll-area::-webkit-scrollbar-thumb {
  background-color: #cbd5e1;
  border-radius: 20px;
}

.department-no-issues {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  background: #f3f4f6;
  border-radius: 12px;
  color: #4b5563;
}

@keyframes fadeIn {
  from {
    opacity: 0.3;
    transform: translateY(3px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.department-tab-scroll-area > .empty-state-card,
.department-tab-scroll-area > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
node_modules
/.pnp
.pnp.js
venv

# testing
/coverage

# production
/build

# misc
.DS_Store
.env.local
.env.development.local
.env.test.local
.env.production.local

npm-debug.log*
yarn-debug.log*
yarn-error.log*


repomix-output.xml
# Python
__pycache__/
*.pyc
</file>

<file path="backend/requirements.txt">
annotated-types==0.7.0
anyio==4.12.1
asgiref==3.11.0
cachetools==6.2.4
certifi==2025.11.12
charset-normalizer==3.4.4
colorama==0.4.6
Django==6.0
django-cors-headers==4.9.0
djangorestframework==3.16.1
et_xmlfile==2.0.0
google-ai-generativelanguage==0.6.15
google-api-core==2.25.2
google-api-python-client==2.187.0
google-auth==2.45.0
google-auth-httplib2==0.3.0
google-generativeai==0.8.6
googleapis-common-protos==1.72.0
grpcio==1.76.0
grpcio-status==1.71.2
h11==0.16.0
httpcore==1.0.9
httplib2==0.31.0
httpx==0.28.1
idna==3.11
openpyxl==3.1.5
proto-plus==1.27.0
protobuf==5.29.5
psycopg2-binary==2.9.11
pyasn1==0.6.1
pyasn1_modules==0.4.2
pydantic==2.12.5
pydantic_core==2.41.5
pyparsing==3.2.5
python-dotenv==1.2.1
requests==2.32.5
rsa==4.9.1
sqlparse==0.5.5
tqdm==4.67.1
typing-inspection==0.4.2
typing_extensions==4.15.0
tzdata==2025.3
uritemplate==4.2.0
urllib3==2.6.2
reportlab
</file>

<file path="client/src/components/Collector/CollectorHeader.css">
.collector-nav-link {
  position: relative;
  display: flex;
  align-items: center;
  text-decoration: none;
}

.collector-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
  width: 62px;
}

.collector-nav-text {
  font-size: 12px;
  font-weight: 600;
  color: #2563eb;
  line-height: 1.1;
  text-align: center;
  white-space: nowrap;
  transition: transform 0.15s ease;
}

.collector-bell-wrap {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.collector-notification-dot {
  position: absolute;
  top: -2px;
  right: -1px;
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #ef4444;
  border: 2px solid #fff;
}

.collector-nav-link.collector-active .collector-icon,
.collector-nav-link.active .collector-icon {
  transform: none;
}

.collector-nav-link.collector-active .collector-nav-item,
.collector-nav-link.active .collector-nav-item {
  transform: scale(1.1);
}

.collector-nav-link.collector-active .collector-nav-text,
.collector-nav-link.active .collector-nav-text {
  transform: none;
  font-weight: 700;
}

.collector-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  padding: 15px 25px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.collector-logo {
  display: flex;
  align-items: center;
  font-weight: 600;
  font-size: 1.1rem;
  color: #1a1a1a;
}

.collector-logo-icon {
  width: 28px;
  height: 28px;
  background: #2563eb;
  border-radius: 5px;
  margin-right: 10px;
}

.collector-header-icons {
  display: flex;
  align-items: flex-end;
  gap: 35px;
  position: relative;
}

.collector-icon.collector-home {
  background: white;
  color: #2563eb;
  font-size: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.collector-icon.collector-bell {
  background: white;
  color: #2563eb;
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
}

.collector-icon.collector-minutes {
  background: white;
  color: #2563eb;
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}

.collector-icon.collector-profile {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #2563eb;
  color: white;
  font-weight: 500;
  cursor: pointer;
  font-size: 16px;
  line-height: 30px;
  text-align: center;
  margin-bottom: 6px;
}

.collector-profile-dropdown {
  position: absolute;
  top: 55px;
  right: 0;
  background: #fff;
  border-radius: 10px;
  width: 140px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  animation: collectorDropdownFade 0.2s ease;
  z-index: 1000;
}

.collector-profile-dropdown button {
  width: 100%;
  background: none;
  border: none;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111827;
}

.collector-profile-dropdown button:hover {
  background: #f3f4f6;
}

@keyframes collectorDropdownFade {
  from {
    opacity: 0;
    transform: translateY(-6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.collector-logout-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background: none;
  border: none;
  padding: 10px 16px;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111827;
}

.collector-logout-btn:hover {
  background: #f3f4f6;
}

.collector-logout-icon {
  font-size: 18px;
  color: #ef4444;
}
</file>

<file path="client/src/components/Department/DepartmentHeader.jsx">
import React, { useState, useRef, useEffect } from "react";
import "./DepartmentHeader.css";
import HomeRoundedIcon from "@mui/icons-material/HomeRounded";
import DescriptionIcon from "@mui/icons-material/Description";
import NotificationsIcon from "@mui/icons-material/Notifications";
import LogoutIcon from "@mui/icons-material/Logout";
import { NavLink, useLocation, useNavigate } from "react-router-dom";
import api from "../../api/axios";
import { clearAuthValues, getAuthValue } from "../../utils/authStorage";
import {
  LIVE_EVENT_NOTIFICATIONS_UPDATED,
  addLiveEventListener,
} from "../../utils/liveUpdates";

function Header() {
  const [open, setOpen] = useState(false);
  const [hasNewNotifications, setHasNewNotifications] = useState(false);
  const dropdownRef = useRef(null);
  const navigate = useNavigate();
  const location = useLocation();
  const dept = getAuthValue("department");

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  useEffect(() => {
    const LAST_SEEN_KEY = "department_notifications_last_seen_at";

    const markSeen = () => {
      localStorage.setItem(LAST_SEEN_KEY, new Date().toISOString());
      setHasNewNotifications(false);
    };

    const checkNotifications = async () => {
      if (location.pathname === "/department/notifications") {
        markSeen();
        return;
      }
      try {
        const username = getAuthValue("username");
        const res = await api.get("/notifications", { params: { username } });
        const notifications = Array.isArray(res.data) ? res.data : [];
        if (notifications.length === 0) {
          setHasNewNotifications(false);
          return;
        }

        const latest = notifications[0];
        const latestTs = latest?.created_at ? new Date(latest.created_at).getTime() : 0;
        const seenTs = new Date(localStorage.getItem(LAST_SEEN_KEY) || 0).getTime();
        setHasNewNotifications(latestTs > seenTs);
      } catch (err) {
        console.error("Notification check error:", err);
      }
    };

    checkNotifications();
    const unsubscribe = addLiveEventListener(
      LIVE_EVENT_NOTIFICATIONS_UPDATED,
      checkNotifications
    );
    return unsubscribe;
  }, [location.pathname]);

  const handleLogout = async () => {
    try {
      await api.post("/logout");
    } catch (err) {
      console.error("Logout error:", err);
    } finally {
      clearAuthValues();
      navigate("/login");
    }
  };

  return (
    <header className="department-header">
      <div className="department-logo">
        <div className="department-logo-icon"></div>
        <span>Minutes Tracker System</span>
      </div>

      <div className="department-header-icons" ref={dropdownRef}>
        <NavLink
          end
          to={`/department/${dept}`}
          className={({ isActive }) =>
            `department-nav-link ${isActive ? "department-active" : ""}`
          }
        >
          <span className="department-nav-item">
            <HomeRoundedIcon className="department-icon department-home" />
            <span className="department-nav-text">Home</span>
          </span>
        </NavLink>

        <NavLink
          to={`/department/${dept}/minutes`}
          className={({ isActive }) =>
            `department-nav-link ${isActive ? "department-active" : ""}`
          }
        >
          <span className="department-nav-item">
            <DescriptionIcon className="department-icon department-minutes" />
            <span className="department-nav-text">Minutes</span>
          </span>
        </NavLink>

        <NavLink
          to="/department/notifications"
          className={({ isActive }) =>
            `department-nav-link ${isActive ? "department-active" : ""}`
          }
        >
          <span className="department-nav-item">
            <span className="department-bell-wrap">
              <NotificationsIcon className="department-icon department-bell" />
              {hasNewNotifications && <span className="department-notification-dot" />}
            </span>
            <span className="department-nav-text">Notifications</span>
          </span>
        </NavLink>

        <div
          className="department-icon department-profile"
          onClick={() => setOpen((prev) => !prev)}
        >
          D
        </div>

        {open && (
          <div className="department-profile-dropdown">
            <button onClick={handleLogout} className="department-logout-btn">
              <LogoutIcon className="department-logout-icon" />
              Logout
            </button>
          </div>
        )}
      </div>
    </header>
  );
}

export default Header;
</file>

<file path="client/src/components/Department/DepartmentIssueCard.jsx">
import React, { useState } from "react";
import DepartmentResponseModal from "./DepartmentResponseModal";
import "./DepartmentIssueCard.css";
import api from "../../api/axios";

function DepartmentIssueCard({ issue }) {
  // Normalize backend status variants for stable rendering.
  const rawStatus = String(issue?.status || "pending").toLowerCase().trim();
  const status =
    rawStatus === "received" || rawStatus === "completed" ? "submitted" : rawStatus;

  const [isModalOpen, setIsModalOpen] = useState(false);

  const handleSubmit = () => {
    setIsModalOpen(false);
    alert("Response submitted successfully!");
  };

  const getStatusStyle = () => {
    switch (status) {
      case "overdue":
        return { borderColor: "#b91c1c" };
      case "submitted":
        return { borderColor: "#16a34a" };
      default:
        return { borderColor: "#facc15" };
    }
  };

  return (
    <>
      <div className="department-issue-card" style={getStatusStyle()}>
        <div className="department-issue-header">
          <span className="department-issue-id">{issue.issue_no}</span>
          <span className={`department-status department-${status}`}>
            {status === "pending"
              ? "Response Required"
              : status === "overdue"
                ? "Overdue"
                : "Response Submitted"}
          </span>
        </div>

        <div className="department-issue-body">
          <div className="department-issue-row">
            <div className="department-label">Issue</div>
            <div className="department-value">{issue.issue}</div>
          </div>
          <div className="department-issue-row">
            <div className="department-label">Description</div>
            <div className="department-value">{issue.issue_description}</div>
          </div>
          <div className="department-issue-row">
            <div className="department-label">Priority</div>
            <div className="department-value">{issue.priority}</div>
          </div>

          <div className="department-issue-row">
            <div className="department-label">Location</div>
            <div className="department-value">{issue.location}</div>
          </div>

          <div className="department-issue-row">
            <div className={`department-label ${status === "overdue" ? "department-overdue-text" : ""}`}>
              Deadline
            </div>
            <div className={`department-value ${status === "overdue" ? "department-overdue-text" : ""}`}>
              <span>{issue.deadline}</span>
            </div>
          </div>
        </div>

        <div className="department-issue-footer">
          {status === "submitted" && (
            <>
              <div className="department-footer-line"></div>
              <div className="department-response-received">
                <p className="department-res">
                  <strong>Your Response:</strong> {issue.response?.text}
                </p>
                {issue.response?.attachment && (
                  <button
                    className="department-res-button"
                    onClick={() => {
                      const baseUrl = api.defaults.baseURL;
                      const fullUrl = issue.response.attachment.startsWith("http")
                        ? issue.response.attachment
                        : `${baseUrl}${issue.response.attachment}`;
                      window.open(fullUrl, "_blank");
                    }}
                  >
                    View Attachment
                  </button>
                )}
              </div>
            </>
          )}

          {(status === "pending" || status === "overdue") && (
            <button
              className={`department-submit-btn ${status === "pending" ? "department-pending-btn" : "department-overdue-btn"
                }`}
              onClick={() => setIsModalOpen(true)}
            >
              Submit Response
            </button>
          )}
        </div>
      </div>

      <DepartmentResponseModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        issue={issue}
        onSubmit={handleSubmit}
      />
    </>
  );
}

export default DepartmentIssueCard;
</file>

<file path="client/src/components/DPO/IssuePage/DPOFilterBar.jsx">
import React, { useEffect, useState, useRef } from "react";
import "./DPOFilterBar.css";
import DPOGenerateReports from "./DPOGenerateReports";

function DPOFilterBar({
  activeTab,
  onFilterChange,
  issue_date,
  handleSendOverdueEmails,
  emailLoading,
  emailStatus
}) {
  const [showReportModal, setShowReportModal] = useState(false);
  const [fromDate, setFromDate] = useState("");
  const [toDate, setToDate] = useState("");
  const [filterBy, setFilterBy] = useState("all"); // ‚úÖ default All Issues
  const [sortBy, setSortBy] = useState("newest");
  const [searchQuery, setSearchQuery] = useState("");
  const [activeDateField, setActiveDateField] = useState(null);

  const fromDatePickerRef = useRef(null);
  const toDatePickerRef = useRef(null);

  const handleGenerate = () => {
    setShowReportModal(true);
  };

  // Sync dates from parent
  useEffect(() => {
    if (issue_date?.fromDate) setFromDate(issue_date.fromDate);
    if (issue_date?.toDate) setToDate(issue_date.toDate);
  }, [issue_date]);

  const formatDateInput = (raw) => {
    const digits = raw.replace(/\D/g, "").slice(0, 8);
    if (digits.length <= 2) return digits;
    if (digits.length <= 4) return `${digits.slice(0, 2)}-${digits.slice(2)}`;
    return `${digits.slice(0, 2)}-${digits.slice(2, 4)}-${digits.slice(4)}`;
  };

  const dateKey = (value) => {
    if (!value || typeof value !== "string") return null;
    const [dd, mm, yyyy] = value.split("-");
    if (!dd || !mm || !yyyy || dd.length < 2 || mm.length < 2 || yyyy.length < 4) return null;
    return Number(`${yyyy}${mm}${dd}`);
  };

  const handleFilterChange = (type, value) => {
    let updatedFilters = {
      fromDate,
      toDate,
      filterBy,
      sortBy,
      searchQuery
    };

    if (type === "fromDate") {
      const v = formatDateInput(value);
      setFromDate(v);
      updatedFilters.fromDate = v;
      const fromK = dateKey(v);
      const toK = dateKey(updatedFilters.toDate);
      if (fromK && toK && fromK > toK) {
        setToDate(v);
        updatedFilters.toDate = v;
      }
    } else if (type === "toDate") {
      const v = formatDateInput(value);
      setToDate(v);
      updatedFilters.toDate = v;
      const fromK = dateKey(updatedFilters.fromDate);
      const toK = dateKey(v);
      if (fromK && toK && toK < fromK) {
        setFromDate(v);
        updatedFilters.fromDate = v;
      }
    } else if (type === "filterBy") {
      setFilterBy(value);
      updatedFilters.filterBy = value;
    } else if (type === "sortBy") {
      setSortBy(value);
      updatedFilters.sortBy = value;
    } else if (type === "search") {
      setSearchQuery(value);
      updatedFilters.searchQuery = value;
    }

    onFilterChange(updatedFilters);
  };

  const handleDatePick = (e) => {
    const parts = e.target.value.split("-");
    if (parts.length === 3) {
      const formatted = `${parts[2]}-${parts[1]}-${parts[0]}`;

      if (activeDateField === "from") {
        setFromDate(formatted);
        handleFilterChange("fromDate", formatted);
      } else if (activeDateField === "to") {
        setToDate(formatted);
        handleFilterChange("toDate", formatted);
      }
    }
  };

  const filterLabel = {
    all: "All Issues",
    high: "High Priority",
    medium: "Medium Priority",
    low: "Low Priority",
    health: "Health Dept",
    education: "Education Dept",
    works: "Public Works"
  };

  return (
    <div className="dpo-filter-bar">
      {/* Search */}
      <div className="dpo-search-wrapper">
        <span className="dpo-search-icon">üîç</span>
        <input
          type="text"
          placeholder="Search issues..."
          value={searchQuery}
          onChange={(e) => handleFilterChange("search", e.target.value)}
        />
      </div>

      {/* From Date */}
      <div className="dpo-date-input-wrapper">
        <input
          type="text"
          placeholder="From: (dd-mm-yyyy)"
          value={fromDate}
          onChange={(e) => handleFilterChange("fromDate", e.target.value)}
        />
        <span
          className="dpo-calendar-icon"
          onClick={() => {
            setActiveDateField("from");
            fromDatePickerRef.current.showPicker();
          }}
        >
          üìÖ
        </span>
        <input
          type="date"
          ref={fromDatePickerRef}
          onChange={handleDatePick}
          style={{ visibility: "hidden", position: "absolute" }}
        />
      </div>

      {/* To Date */}
      <div className="dpo-date-input-wrapper">
        <input
          type="text"
          placeholder="To: (dd-mm-yyyy)"
          value={toDate}
          onChange={(e) => handleFilterChange("toDate", e.target.value)}
        />
        <span
          className="dpo-calendar-icon"
          onClick={() => {
            setActiveDateField("to");
            toDatePickerRef.current.showPicker();
          }}
        >
          üìÖ
        </span>
        <input
          type="date"
          ref={toDatePickerRef}
          onChange={handleDatePick}
          style={{ visibility: "hidden", position: "absolute" }}
        />
      </div>

      {/* Filter (Nested) */}
      <div className="dpo-filter-group dpo-custom-filter">
        <label>Filter:</label>
        <div className="dpo-filter-dropdown">
          <button className="dpo-filter-btn">
            {filterLabel[filterBy]} ‚ñæ
          </button>

          <div className="dpo-filter-menu">
            <div className="dpo-filter-item">
              Priority ‚ñ∏
              <div className="dpo-sub-menu">
                <div onClick={() => handleFilterChange("filterBy", "high")}>High</div>
                <div onClick={() => handleFilterChange("filterBy", "medium")}>Medium</div>
                <div onClick={() => handleFilterChange("filterBy", "low")}>Low</div>
              </div>
            </div>

            <div className="dpo-filter-item">
              Department ‚ñ∏
              <div className="dpo-sub-menu">
                <div onClick={() => handleFilterChange("filterBy", "health")}>Health</div>
                <div onClick={() => handleFilterChange("filterBy", "education")}>Education</div>
                <div onClick={() => handleFilterChange("filterBy", "works")}>Public Works</div>
              </div>
            </div>

            <div
              className="dpo-filter-item"
              onClick={() => handleFilterChange("filterBy", "all")}
            >
              All Issues
            </div>
          </div>
        </div>
      </div>

      {/* Sort */}
      <div className="dpo-filter-group dpo-custom-filter">
        <label>Sort:</label>
        <div className="dpo-filter-dropdown">
          <button className="dpo-filter-btn">
            {sortBy === "priority"
              ? "Priority"
              : sortBy === "department"
                ? "Department"
                : "Deadline"} ‚ñæ
          </button>

          <div className="dpo-filter-menu">
            <div
              className="dpo-filter-item"
              onClick={() => handleFilterChange("sortBy", "priority")}
            >
              Priority
            </div>

            <div
              className="dpo-filter-item"
              onClick={() => handleFilterChange("sortBy", "department")}
            >
              Department
            </div>

            <div
              className="dpo-filter-item"
              onClick={() => handleFilterChange("sortBy", "deadline")}
            >
              Deadline
            </div>
          </div>
        </div>
      </div>


      {/* Generate */}
      {activeTab === "Received" && (
        <button className="dpo-generate-btn" onClick={handleGenerate}>
          Generate Report
        </button>
      )}
      {activeTab === "Overdue" && (
        <div style={{ position: 'relative', display: 'flex', alignItems: 'center', marginLeft: 'auto' }}>
          <button
            className={`dpo-send-email-btn ${emailLoading ? 'dpo-loading' : ''}`}
            onClick={handleSendOverdueEmails}
            disabled={emailLoading}
          >
            {emailLoading ? "Sending..." : "Send Overdue Emails"}
          </button>

          {emailStatus && (
            <div className="dpo-email-status-popup">
              {emailStatus}
            </div>
          )}
        </div>
      )}


      <DPOGenerateReports
        isOpen={showReportModal}
        onClose={() => setShowReportModal(false)}
      />
    </div>
  );
}

export default DPOFilterBar;
</file>

<file path="client/src/pages/CollectorPage/NotificationPage.jsx">
import React from "react";
import CollectorHeader from "../../components/Collector/CollectorHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import "./NotificationPage.css";

function CollectorNotificationPage() {
  const notifications = [
    {
      id: 1,
      title: "Response Received",
      message: "A response has been submitted for Issue #1023.",
      time: "10 minutes ago",
      type: "response",
    },
    {
      id: 2,
      title: "Deadline Exceeded",
      message: "Issue #1009 has exceeded its deadline. Immediate attention required.",
      time: "1 hour ago",
      type: "deadline",
    },
  ];

  return (
    <div className="collector-container">
      <CollectorHeader />

      <div className="collector-content">
        <div className="collector-notification-header">
          <h1>Notifications</h1>
        </div>

        <div className="collector-notification-list">
          {notifications.map((note) => (
                <div key={note.id} className={`collector-notification-card collector-${note.type}`}>
              <div className="collector-notification-icon">
                {note.type === "response" && <span>üì©</span>}
                {note.type === "deadline" && <span>‚è∞</span>}
              </div>

              <div className="collector-notification-content">
                <h3>{note.title}</h3>
                <p>{note.message}</p>
                <span className="collector-time">{note.time}</span>
              </div>
            </div>
          ))}

          {notifications.length === 0 && (
            <EmptyStateCard
              compact
              title="No notifications"
              description="You are all caught up."
            />
          )}
        </div>
      </div>
    </div>
  );
}

export default CollectorNotificationPage;
</file>

<file path="client/src/pages/DPOPage/DPOMinutesPage.jsx">
import React, { useEffect, useState } from "react";
import PictureAsPdfIcon from "@mui/icons-material/PictureAsPdf";
import CloudDownloadIcon from "@mui/icons-material/CloudDownload";
import FileOpenIcon from "@mui/icons-material/FileOpen";
import DeleteIcon from "@mui/icons-material/Delete";

import DPOHeader from "../../components/DPO/DPOHeader";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import api from "../../api/axios";

import "./DPOMinutesPage.css";

function DPOMinutesPage() {
  const [minutes, setMinutes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [deleting, setDeleting] = useState(null);

  useEffect(() => {
    fetchMinutes();
  }, []);

  const fetchMinutes = async () => {
    setLoading(true);
    setError(null);
    try {
      const res = await api.get("/minutes");
      setMinutes(res.data);
    } catch (err) {
      console.error("Error fetching minutes:", err);
      setError("Failed to load minutes. Please try again.");
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateString) => {
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString("en-GB", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });
    } catch {
      return "Unknown date";
    }
  };

  const handleView = (fileUrl) => {
    if (fileUrl) {
      const link = document.createElement("a");
      link.href = fileUrl;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  const handleDownload = async (fileUrl, fileName) => {
    if (!fileUrl) return;

    try {
      const response = await fetch(fileUrl);
      if (!response.ok) throw new Error("Failed to download file");

      const blob = await response.blob();
      const blobUrl = window.URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = blobUrl;
      link.download = fileName || "minutes.pdf";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(blobUrl);
    } catch (downloadError) {
      console.error("Download error:", downloadError);
      alert("Failed to download file. Please try again.");
    }
  };

  const handleDelete = async (minutesId, fileName) => {
    if (
      !window.confirm(
        `Are you sure you want to delete "${fileName}"? This action cannot be undone.`
      )
    ) {
      return;
    }

    setDeleting(minutesId);
    try {
      await api.delete(`/minutes/${minutesId}`);
      setMinutes(minutes.filter((m) => m.id !== minutesId));
      alert(`Deleted: ${fileName}`);
    } catch (err) {
      console.error("Error deleting minutes:", err);
      alert("Failed to delete minutes. Please try again.");
    } finally {
      setDeleting(null);
    }
  };

  return (
    <div className="dpo-container">
      <DPOHeader />

      <div className="dpo-minutes-page-content">
        <h1 className="dpo-page-title">Meeting Minutes</h1>

        {error && <div className="dpo-error-message">{error}</div>}

        <div className="dpo-minutes-body">
          {loading ? (
            <LoadingState text="Loading minutes..." />
          ) : minutes.length === 0 ? (
            <EmptyStateCard
              title="No minutes uploaded"
              description="There are no meeting minutes to display yet."
            />
          ) : (
            <div className="dpo-minutes-grid">
              {minutes.map((m) => (
                <div key={m.id} className="dpo-minutes-card">
                  <div className="dpo-card-header">
                    <PictureAsPdfIcon className="dpo-pdf-icon" />
                    <h3 className="dpo-file-name">{m.originalFileName || m.title}</h3>
                  </div>

                  <div className="dpo-card-body">
                    <div className="dpo-info-item">
                      <span className="dpo-label">Uploaded:</span>
                      <span className="dpo-value">{formatDate(m.uploadedDate)}</span>
                    </div>

                    {m.meetingDate && (
                      <div className="dpo-info-item">
                        <span className="dpo-label">Meeting Date:</span>
                        <span className="dpo-value">{formatDate(m.meetingDate)}</span>
                      </div>
                    )}

                    <div className="dpo-info-item">
                      <span className="dpo-label">Uploaded By:</span>
                      <span className="dpo-value">{m.uploadedBy}</span>
                    </div>

                    <div className="dpo-info-item">
                      <span className="dpo-label">Issues Allocated:</span>
                      <span className="dpo-value">{m.issueCount ?? 0}</span>
                    </div>

                  </div>

                  <div className="dpo-card-actions">
                    <button
                      className="dpo-minutes-view-btn"
                      onClick={() => handleView(m.fileUrl)}
                      title="View document"
                    >
                      <FileOpenIcon fontSize="medium" />
                    </button>

                    <button
                      className="dpo-minutes-download-btn"
                      onClick={() => handleDownload(m.fileUrl, m.originalFileName)}
                      title="Download document"
                    >
                      <CloudDownloadIcon fontSize="medium" />
                    </button>

                    <button
                      className="dpo-minutes-delete-btn"
                      onClick={() => handleDelete(m.id, m.originalFileName || m.title)}
                      disabled={deleting === m.id}
                      title="Delete minutes"
                    >
                      <DeleteIcon fontSize="medium" />
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default DPOMinutesPage;
</file>

<file path="client/src/App.jsx">
import React from "react";
import { BrowserRouter as Router, Routes, Route, Navigate, useLocation } from "react-router-dom";
import DPOIssuePage from "./pages/DPOPage/DPOIssuePage.jsx";
import DepartmentResponsePage from "./pages/DepartmentPage/DepartmentResponsePage.jsx";
import CollectorIssuePage from "./pages/CollectorPage/CollectorIssuePage.jsx";
import DPONotificationsPage from "./pages/DPOPage/DPONotificationPage.jsx";
import DPOMinutesPage from "./pages/DPOPage/DPOMinutesPage.jsx"
import DPODraftsPage from "./pages/DPOPage/DPODraftsPage.jsx";
import DepartmentMinutesPage from "./pages/DepartmentPage/DepartmentMinutesPage.jsx"
import DepartmentNotificationPage from "./pages/DepartmentPage/DepartmentNotificationPage.jsx";
import CollectorNotificationPage from "./pages/CollectorPage/NotificationPage.jsx";
import CollectorMinutesPage from "./pages/CollectorPage/CollectorMinutesPage.jsx"
import Login from "./pages/LoginPage.jsx";
import "./App.css";

function UploadRedirect() {
  const location = useLocation();
  return <Navigate to={`/dpo/drafts${location.search || ""}`} replace />;
}

function App() {
  return (
    <Router>
      <Routes>
        {/* Default route -> DPO Page */}
        <Route path="/" element={<Navigate to="/login" />} />
        {/* DPO Page */}
        <Route path="/login" element={<Login />} />
        <Route path="/dpo/home" element={<DPOIssuePage />} />
        {/* Upload Page */}
        <Route path="/dpo/upload" element={<UploadRedirect />} />
        <Route path="/dpo/drafts" element={<DPODraftsPage />} />
        <Route path="/dpo/notifications" element={<DPONotificationsPage />} />
        <Route path="/dpo/minutes" element={<DPOMinutesPage />} />
        <Route path="/department/:dept" element={<DepartmentResponsePage />} />
        <Route path="/department/:dept/minutes" element={<DepartmentMinutesPage />} />
        <Route path="/department/notifications" element={<DepartmentNotificationPage />} />
        <Route path="/collector" element={<CollectorIssuePage />} />
        <Route path="/collector/notifications" element={<CollectorNotificationPage />} />
        <Route path="/collector/minutes" element={<CollectorMinutesPage />} />
      </Routes>
    </Router>
  );
}

export default App;
</file>

<file path="client/src/pages/CollectorPage/CollectorIssuePage.jsx">
import React, { useEffect, useState, useMemo } from "react";
import CollectorHeader from "../../components/Collector/CollectorHeader";
import CollectorTabs from "../../components/Collector/IssuePage/CollectorTabs";
import CollectorFilterBar from "../../components/Collector/IssuePage/CollectorFilterBar";
import CollectorIssueCard from "../../components/Collector/IssuePage/CollectorIssueCard";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import "./CollectorIssuePage.css";
import api from "../../api/axios"; // Uses your configured axios with Token

function CollectorIssuePage() {
  const [activeTab, setActiveTab] = useState("Pending");
  const [filters, setFilters] = useState({});
  const [defaultDateRange, setDefaultDateRange] = useState(null);
  const [didInitDateRange, setDidInitDateRange] = useState(false);
  const [allIssues, setAllIssues] = useState([]);
  const [loading, setLoading] = useState(true);

  const dateKeyFromRaw = (raw) => {
    if (!raw || typeof raw !== "string") return null;

    const ymdMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (ymdMatch) {
      return Number(`${ymdMatch[1]}${ymdMatch[2]}${ymdMatch[3]}`);
    }

    const dt = new Date(raw);
    if (Number.isNaN(dt.getTime())) return null;
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, "0");
    const d = String(dt.getDate()).padStart(2, "0");
    return Number(`${y}${m}${d}`);
  };

  const getIssueDateKeys = (issue) => {
    const keys = [dateKeyFromRaw(issue?.meeting_date || "")].filter(Boolean);
    return [...new Set(keys)];
  };

  const getIssueDateKey = (issue) => {
    const keys = getIssueDateKeys(issue);
    return keys.length > 0 ? Math.max(...keys) : null;
  };

  const toDDMMYYYY = (dt) => {
    const day = String(dt.getDate()).padStart(2, "0");
    const month = String(dt.getMonth() + 1).padStart(2, "0");
    const year = dt.getFullYear();
    return `${day}-${month}-${year}`;
  };

  const parseDDMMYYYYToKey = (value) => {
    if (!value || typeof value !== "string") return null;
    const [dd, mm, yyyy] = value.split("-");
    if (!dd || !mm || !yyyy) return null;
    return Number(`${yyyy}${mm.padStart(2, "0")}${dd.padStart(2, "0")}`);
  };

  // 1. Fetch Logic: Get ALL issues once (or when Date filter changes)
  useEffect(() => {
    setLoading(true);

    // Use the specific date param if it exists, otherwise fetch all
    const params = filters.date ? { date: filters.date } : {};

    api.get("/issues", { params })
      .then((res) => {
        setAllIssues(res.data);
      })
      .catch((err) => console.error("Error fetching issues:", err))
      .finally(() => setLoading(false));

  }, [filters.date]); // Only re-fetch from server if the DATE filter changes

  useEffect(() => {
    if (didInitDateRange || allIssues.length === 0) return;
    const dated = allIssues
      .map((issue) => {
        const k = getIssueDateKey(issue);
        if (!k) return null;
        const s = String(k);
        return new Date(Number(s.slice(0, 4)), Number(s.slice(4, 6)) - 1, Number(s.slice(6, 8)));
      })
      .filter(Boolean)
      .sort((a, b) => b.getTime() - a.getTime());
    if (dated.length === 0) return;

    const latest = toDDMMYYYY(dated[0]);
    setDefaultDateRange({ fromDate: latest, toDate: latest });
    setFilters((prev) => ({ ...prev, fromDate: latest, toDate: latest }));
    setDidInitDateRange(true);
  }, [allIssues, didInitDateRange]);

  // 2. Instant Client-Side Filtering (Same logic as DPO page)
  const displayedIssues = useMemo(() => {
    return allIssues.filter((issue) => {

      // A. Filter by Tab
      const status = issue.status ? issue.status.toLowerCase() : "pending";
      const tab = activeTab.toLowerCase();

      let statusMatch = false;
      if (tab === "received") {
        // "Received" tab shows 'submitted' or 'completed' status
        statusMatch = (status === "submitted" || status === "completed");
      } else {
        statusMatch = (status === tab);
      }

      if (!statusMatch) return false;

      // B. Filter by Search Query
      if (filters.searchQuery) {
        const query = filters.searchQuery.toLowerCase();
        const matchesSearch =
          (issue.issue && issue.issue.toLowerCase().includes(query)) ||
          (issue.issue_no && issue.issue_no.toString().includes(query)) ||
          (issue.department && issue.department.toLowerCase().includes(query));

        if (!matchesSearch) return false;
      }

      // C. Filter by Dropdown (Priority/Dept)
      if (filters.filterBy && filters.filterBy !== "all") {
        const filterVal = filters.filterBy.toLowerCase();

        // Check Priority
        if (['high', 'medium', 'low'].includes(filterVal)) {
          if (issue.priority.toLowerCase() !== filterVal) return false;
        }
        // Check Department
        else {
          if (!issue.department.toLowerCase().includes(filterVal)) return false;
        }
      }

      const issueDateKeys = getIssueDateKeys(issue);
      const fromDateKeyRaw = parseDDMMYYYYToKey(filters.fromDate);
      const toDateKeyRaw = parseDDMMYYYYToKey(filters.toDate);
      const lowerBound =
        fromDateKeyRaw && toDateKeyRaw ? Math.min(fromDateKeyRaw, toDateKeyRaw) : fromDateKeyRaw;
      const upperBound =
        fromDateKeyRaw && toDateKeyRaw ? Math.max(fromDateKeyRaw, toDateKeyRaw) : toDateKeyRaw;
      if ((lowerBound || upperBound) && issueDateKeys.length === 0) return false;
      if (lowerBound || upperBound) {
        const inRange = issueDateKeys.some((key) => {
          if (lowerBound && key < lowerBound) return false;
          if (upperBound && key > upperBound) return false;
          return true;
        });
        if (!inRange) return false;
      }

      // D. Sort Logic (Optional client-side sorting)
      // You can add sort logic here if needed, currently implied by order of array

      return true;
    });
  }, [allIssues, activeTab, filters]);

  return (
    <div className="collector-issuepage-container">
      <CollectorHeader />

      <div className="collector-issuepage-content">
        <div className="collector-page-title">
          <h1>District Monitor</h1>
        </div>

        <CollectorFilterBar
          activeTab={activeTab}
          onFilterChange={(newFilters) => setFilters(prev => ({ ...prev, ...newFilters }))}
          issue_date={defaultDateRange}
        />

        <CollectorTabs
          activeTab={activeTab}
          setActiveTab={setActiveTab}
        />

        <div className="collector-tab-scroll-area">
          {loading ? (
            <LoadingState text="Loading issues..." />
          ) : displayedIssues.length === 0 ? (
            <EmptyStateCard
              title="No issues found"
              description={`There are no ${activeTab.toLowerCase()} issues to display.`}
            />
          ) : (
            displayedIssues.map((issue) => (
              <CollectorIssueCard key={issue.id} issue={issue} />
            ))
          )}
        </div>
      </div>
    </div>
  );
}

export default CollectorIssuePage;
</file>

<file path="client/src/pages/DepartmentPage/DepartmentResponsePage.jsx">
// import axios from "axios";
import React, { useEffect, useState, useMemo } from "react";
import { useParams } from "react-router-dom";
import DepartmentHeader from "../../components/Department/DepartmentHeader";
import DepartmentTabs from "../../components/Department/DepartmentTabs";
import DepartmentIssueCard from "../../components/Department/DepartmentIssueCard";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import { LIVE_EVENT_ISSUES_UPDATED, addLiveEventListener } from "../../utils/liveUpdates";
import "./DepartmentResponsePage.css";
import api from "../../api/axios";

function DepartmentResponsePage() {
  const { dept } = useParams();
  const [activeTab, setActiveTab] = useState("Pending");
  const [allIssues, setAllIssues] = useState([]); // Renamed for clarity
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  const fetchDeptIssues = async () => {
    if (!dept) return;

    if (allIssues.length === 0) setLoading(true);
    setError("");
    try {
      const res = await api.get(`/issues/${dept}`);
      setAllIssues(Array.isArray(res.data) ? res.data : []);
    } catch (err) {
      console.error("Error fetching department issues:", err);
      setError("Failed to refresh issues. Retrying automatically...");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchDeptIssues();
  }, [dept]);

  useEffect(() => {
    const onIssuesUpdated = (evt) => {
      const eventDept = String(evt?.detail?.department || "").toUpperCase();
      if (!eventDept || eventDept.includes(String(dept || "").toUpperCase())) {
        fetchDeptIssues();
      }
    };
    const unsubscribe = addLiveEventListener(LIVE_EVENT_ISSUES_UPDATED, onIssuesUpdated);
    return unsubscribe;
  }, [dept, allIssues.length]);

  // 2. OPTIMIZATION: Filter instantly in memory using useMemo
  const displayedIssues = useMemo(() => {
    const tabLower = activeTab.toLowerCase().trim();

    return allIssues.filter((i) => {
      const status = String(i?.status || "pending").toLowerCase().trim();

      // Handle the 'Submitted' vs 'Received' logic if needed
      if (tabLower === 'submitted') {
        return status === 'submitted' || status === 'completed' || status === 'received';
      }
      return status === tabLower;
    });
  }, [allIssues, activeTab]); // Re-runs instantly when tab changes

  return (
    <div className="department-container">
      <DepartmentHeader departmentName={dept} />
      <div className="department-content">
        <h1>{dept?.toUpperCase()} Department Portal</h1>

        <DepartmentTabs activeTab={activeTab} setActiveTab={setActiveTab} />

        <div className="department-tab-scroll-area">
          {loading && allIssues.length === 0 ? (
            <LoadingState text="Loading issues..." />
          ) : error && allIssues.length === 0 ? (
            <EmptyStateCard
              title="Unable to load issues"
              description={error}
            />
          ) : (
            <>
              {displayedIssues.length > 0 ? (
                displayedIssues.map((issue) => (
                  <DepartmentIssueCard
                    // We fixed the serializer to return 'id', so use that
                    key={issue.id}
                    issue={issue}
                  />
                ))
              ) : (
                <EmptyStateCard
                  title="No issues found"
                  description={`There are no ${activeTab.toLowerCase()} issues right now.`}
                />
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

export default DepartmentResponsePage;
</file>

<file path="client/src/pages/DPOPage/DPOMinutesPage.css">
.dpo-container .dpo-page-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 20px;
  color: #1f2937;
}

.dpo-container .dpo-minutes-page-content {
  padding: 10px 70px;
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.dpo-container .dpo-minutes-body {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

/* Loading State */
.dpo-container .dpo-loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  gap: 20px;
}

.dpo-container .dpo-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid #e5e7eb;
  border-top-color: #2563eb;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.dpo-container .dpo-loading-text {
  color: #6b7280;
  font-size: 1rem;
}

/* Error State */
.dpo-container .dpo-error-message {
  background: #fee;
  color: #dc2626;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #dc2626;
}

/* Empty State */
.dpo-container .dpo-no-minutes {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  gap: 16px;
  color: #9ca3af;
}

.dpo-container .dpo-empty-icon {
  font-size: 64px;
  opacity: 0.5;
}

.dpo-container .dpo-no-minutes p {
  font-size: 1.2rem;
  margin: 0;
}

/* Grid Layout */
.dpo-container .dpo-minutes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
}

/* Card Styling */
.dpo-container .dpo-minutes-card {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid #e5e7eb;
}



/* Card Header */
.dpo-container .dpo-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.dpo-container .dpo-pdf-icon {
  font-size: 32px;
  color: #dc2626;
  flex-shrink: 0;
}

.dpo-container .dpo-file-name {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
  color: #1f2937;
  word-break: break-word;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* Card Body */
.dpo-container .dpo-card-body {
  padding: 16px;
}

.dpo-container .dpo-info-item {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
  gap: 8px;
  font-size: 0.9rem;
}

.dpo-container .dpo-info-item:last-child {
  margin-bottom: 0;
}

.dpo-container .dpo-info-item .dpo-label {
  font-weight: 600;
  color: #6b7280;
  min-width: 120px;
}

.dpo-container .dpo-info-item .dpo-value {
  color: #1f2937;
  text-align: right;
  flex: 1;
  word-break: break-word;
}

/* Card Actions */
.dpo-container .dpo-card-actions {
  display: flex;
  gap: 16px;
  padding: 12px 16px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
}

.dpo-container .dpo-minutes-view-btn,
.dpo-container .dpo-minutes-download-btn,
.dpo-container .dpo-minutes-delete-btn {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  transition: transform 0.2s ease, color 0.2s ease;
  flex-shrink: 0;
}

.dpo-container .dpo-minutes-view-btn {
  color: #2563eb;
}

.dpo-container .dpo-minutes-view-btn:hover {
  color: #1d4ed8;
  transform: scale(1.15);
}

.dpo-container .dpo-minutes-download-btn {
  color: #10b981;
}

.dpo-container .dpo-minutes-download-btn:hover {
  color: #059669;
  transform: scale(1.15);
}

.dpo-container .dpo-minutes-delete-btn {
  color: #dc2626;
}

.dpo-container .dpo-minutes-delete-btn:hover:not(:disabled) {
  color: #b91c1c;
  transform: scale(1.15);
}

.dpo-container .dpo-minutes-delete-btn:disabled {
  color: #9ca3af;
  cursor: not-allowed;
  opacity: 0.7;
}

/* Responsive */
@media (max-width: 768px) {
  .dpo-container .dpo-minutes-grid {
    grid-template-columns: 1fr;
  }

  .dpo-container .dpo-page-title {
    font-size: 1.5rem;
  }

  .dpo-container .dpo-info-item {
    flex-direction: column;
    align-items: flex-start;
  }

  .dpo-container .dpo-info-item .dpo-label {
    min-width: unset;
  }

  .dpo-container .dpo-info-item .dpo-value {
    text-align: left;
  }
}

.dpo-container .dpo-minutes-body > .empty-state-card,
.dpo-container .dpo-minutes-body > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="backend/api/models.py">
from django.contrib.auth.models import AbstractUser
from django.db import models

class User(AbstractUser):
    ROLE_CHOICES = [
        ('dpo', 'dpo'),
        ('collector', 'collector'),
        ('department', 'department'),
    ]

    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    department = models.ForeignKey(
        'Department',
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
class Department(models.Model):
    dept_name = models.CharField(max_length=100, unique=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.dept_name
class Minutes(models.Model):
    title = models.CharField(max_length=200)
    meeting_date = models.DateField()
    uploaded_by = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='uploaded_minutes'
    )
    file_path = models.FileField(upload_to='minutes/', max_length=500)
    created_at = models.DateTimeField(auto_now_add=True)
class Issue(models.Model):
    PRIORITY_CHOICES = [
        ('LOW', 'Low'),
        ('MEDIUM', 'Medium'),
        ('HIGH', 'High'),
    ]

    minutes = models.ForeignKey(
        Minutes,
        on_delete=models.CASCADE,
        related_name='issues'
    )
    issue_title = models.CharField(max_length=300)
    issue_description = models.TextField(default="")
    location = models.CharField(max_length=200)
    priority = models.CharField(max_length=10, choices=PRIORITY_CHOICES)
    created_at = models.DateTimeField(auto_now_add=True)
class IssueDepartment(models.Model):
    STATUS_CHOICES = [
        ('PENDING', 'Pending'),
        ('COMPLETED', 'Completed'),
        ('OVERDUE', 'Overdue'),
    ]

    issue = models.ForeignKey(Issue, on_delete=models.CASCADE)
    department = models.ForeignKey(Department, on_delete=models.CASCADE)
    deadline_date = models.DateField()
    status = models.CharField(max_length=20, choices=STATUS_CHOICES)
class Response(models.Model):
    issue_department = models.ForeignKey(
        IssueDepartment,
        on_delete=models.CASCADE,
        related_name='responses'
    )
    response_text = models.TextField()
    attachment_path = models.FileField(upload_to='responses/', null=True, blank=True)
    submitted_at = models.DateTimeField(auto_now_add=True)
class Notification(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    issue_department = models.ForeignKey(IssueDepartment, on_delete=models.CASCADE, null=True, blank=True)
    message = models.TextField()
    is_read = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
</file>

<file path="client/src/components/Collector/CollectorHeader.jsx">
import React, { useState, useRef, useEffect } from "react";
import "./CollectorHeader.css";
import HomeRoundedIcon from "@mui/icons-material/HomeRounded";
import DescriptionIcon from "@mui/icons-material/Description";
import NotificationsIcon from "@mui/icons-material/Notifications";
import LogoutIcon from "@mui/icons-material/Logout";
import { NavLink, useLocation, useNavigate } from "react-router-dom";
import api from "../../api/axios";
import { clearAuthValues, getAuthValue } from "../../utils/authStorage";
import {
  LIVE_EVENT_NOTIFICATIONS_UPDATED,
  addLiveEventListener,
} from "../../utils/liveUpdates";

function Header() {
  const [open, setOpen] = useState(false);
  const [hasNewNotifications, setHasNewNotifications] = useState(false);
  const dropdownRef = useRef(null);
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  useEffect(() => {
    const LAST_SEEN_KEY = "collector_notifications_last_seen_at";

    const markSeen = () => {
      localStorage.setItem(LAST_SEEN_KEY, new Date().toISOString());
      setHasNewNotifications(false);
    };

    const checkNotifications = async () => {
      if (location.pathname === "/collector/notifications") {
        markSeen();
        return;
      }
      try {
        const username = getAuthValue("username");
        const res = await api.get("/notifications", { params: { username } });
        const notifications = Array.isArray(res.data) ? res.data : [];
        if (notifications.length === 0) {
          setHasNewNotifications(false);
          return;
        }

        const latest = notifications[0];
        const latestTs = latest?.created_at ? new Date(latest.created_at).getTime() : 0;
        const seenTs = new Date(localStorage.getItem(LAST_SEEN_KEY) || 0).getTime();
        setHasNewNotifications(latestTs > seenTs);
      } catch (err) {
        console.error("Notification check error:", err);
      }
    };

    checkNotifications();
    const unsubscribe = addLiveEventListener(
      LIVE_EVENT_NOTIFICATIONS_UPDATED,
      checkNotifications
    );
    return unsubscribe;
  }, [location.pathname]);

  const handleLogout = async () => {
    try {
      await api.post("/logout");
    } catch (err) {
      console.error("Logout error:", err);
    } finally {
      clearAuthValues();
      navigate("/login");
    }
  };

  return (
    <header className="collector-header">
      <div className="collector-logo">
        <div className="collector-logo-icon"></div>
        <span>Minutes Tracker System</span>
      </div>

      <div className="collector-header-icons" ref={dropdownRef}>
        <NavLink
          end
          to="/collector"
          className={({ isActive }) =>
            `collector-nav-link ${isActive ? "collector-active" : ""}`
          }
        >
          <span className="collector-nav-item">
            <HomeRoundedIcon className="collector-icon collector-home" />
            <span className="collector-nav-text">Home</span>
          </span>
        </NavLink>

        <NavLink
          to="/collector/minutes"
          className={({ isActive }) =>
            `collector-nav-link ${isActive ? "collector-active" : ""}`
          }
        >
          <span className="collector-nav-item">
            <DescriptionIcon className="collector-icon collector-minutes" />
            <span className="collector-nav-text">Minutes</span>
          </span>
        </NavLink>

        <NavLink
          to="/collector/notifications"
          className={({ isActive }) =>
            `collector-nav-link ${isActive ? "collector-active" : ""}`
          }
        >
          <span className="collector-nav-item">
            <span className="collector-bell-wrap">
              <NotificationsIcon className="collector-icon collector-bell" />
              {hasNewNotifications && <span className="collector-notification-dot" />}
            </span>
            <span className="collector-nav-text">Notifications</span>
          </span>
        </NavLink>

        <div
          className="collector-icon collector-profile"
          onClick={() => setOpen((prev) => !prev)}
        >
          C
        </div>

        {open && (
          <div className="collector-profile-dropdown">
            <button onClick={handleLogout} className="collector-logout-btn">
              <LogoutIcon className="collector-logout-icon" />
              Logout
            </button>
          </div>
        )}
      </div>
    </header>
  );
}

export default Header;
</file>

<file path="client/src/components/DPO/DPOHeader.css">
/* NavLink wrapper */
.dpo-nav-link {
  position: relative;
  display: flex;
  align-items: center;
  text-decoration: none;
}

.dpo-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  gap: 4px;
  width: 62px;

}

.dpo-nav-text {
  font-size: 12px;
  font-weight: 600;
  color: #2563eb;
  line-height: 1.1;
  text-align: center;
  white-space: nowrap;
  transition: transform 0.15s ease;
}

.dpo-bell-wrap {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.dpo-notification-dot {
  position: absolute;
  top: -2px;
  right: -1px;
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: #ef4444;
  border: 2px solid #fff;
}

/* Active icon pop */
.dpo-nav-link.dpo-active .dpo-icon,
.dpo-nav-link.active .dpo-icon {
  transform: none;
}

.dpo-nav-link.dpo-active .dpo-nav-item,
.dpo-nav-link.active .dpo-nav-item {
  transform: scale(1.1);
}

.dpo-nav-link.dpo-active .dpo-nav-text,
.dpo-nav-link.active .dpo-nav-text {
  transform: none;
  font-weight: 700;
}

/* Underline */

.dpo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
  padding: 15px 25px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.dpo-logo {
  display: flex;
  align-items: center;
  font-weight: 600;
  font-size: 1.1rem;
  color: #1a1a1a;
}

.dpo-logo-icon {
  width: 28px;
  height: 28px;
  background: #2563eb;
  border-radius: 5px;
  margin-right: 10px;
}

.dpo-header-icons {
  display: flex;
  align-items: flex-end;
  gap: 35px;
  position: relative;
}

/* standard icon container */

.dpo-icon.dpo-home {
  background: white;
  color: #2563eb;
  font-size: 28px;

  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}


.dpo-icon.dpo-bell {
  background: white; /* make the circular background white */
  color: #2563eb; /* bell color */
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
}

.dpo-icon.dpo-profile {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #2563eb;
  color: white;
  font-weight: 500;
  cursor: pointer;
  font-size: 16px;
  line-height: 30px;
  text-align: center;
  margin-bottom:6px;
}

/* Profile dropdown */
.dpo-profile-dropdown {
  position: absolute;
  top: 55px;
  right: 0;
  background: #fff;
  border-radius: 10px;
  width: 140px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
  padding: 8px 0;
  animation: dpoDropdownFade 0.2s ease;
  z-index: 1000;
}

.dpo-profile-dropdown button {
  width: 100%;
  background: none;
  border: none;

  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111827;
}



/* Smooth appearance */
@keyframes dpoDropdownFade {
  from {
    opacity: 0;
    transform: translateY(-6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.dpo-logout-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  background: none;
  border: none;
  padding: 10px 16px;
  text-align: left;
  font-size: 14px;
  cursor: pointer;
  color: #111827;
}

.dpo-logout-btn:hover {
  background: #f3f4f6;
}

.dpo-logout-icon {
  font-size: 18px;
  color: #ef4444; /* subtle red for logout */
}

.dpo-icon.dpo-minutes {
  background: white;
  color: #2563eb;
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}



.dpo-icon.dpo-drafts {
    background: white;
  color: #2563eb;
  font-size: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  cursor: pointer;
  transition: transform 0.15s ease;
}
/* Modal Overlay */
.dpo-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

/* ========================= */
/* ===== Modal Overlay ===== */
/* ========================= */

.dpo-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  backdrop-filter: blur(3px);
}

/* ========================= */
/* ===== Modal Box ===== */
/* ========================= */

.dpo-modal {
  background: #ffffff;
  width: 380px;
  max-width: 90%;
  padding: 28px;
  border-radius: 14px;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.18);
  display: flex;
  flex-direction: column;
  gap: 18px;
  animation: dpoDropdownFade 0.2s ease;
}

/* Title */
.dpo-modal h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: #111827;
  text-align: center;
}

/* ========================= */
/* ===== Input Fields ===== */
/* ========================= */

.dpo-modal input {
  padding: 11px 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
  font-size: 14px;
  transition: all 0.2s ease;
  background: #f9fafb;
}

.dpo-modal input:focus {
  outline: none;
  border-color: #2563eb;
  background: #ffffff;
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
}

/* ========================= */
/* ===== Password Field ===== */
/* ========================= */

.dpo-password-field {
  position: relative;
  display: flex;
  align-items: center;
}

.dpo-password-field input {
  width: 100%;
  padding-right: 42px;
}

.dpo-eye-icon {
  position: absolute;
  right: 12px;
  cursor: pointer;
  color: #6b7280;
  display: flex;
  align-items: center;
  transition: color 0.2s ease;
}

.dpo-eye-icon:hover {
  color: #2563eb;
}

.dpo-eye-icon svg {
  font-size: 20px;
}

/* ========================= */
/* ===== Buttons ===== */
/* ========================= */

.dpo-modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 8px;
}

/* Cancel */
.dpo-cancel-btn {
  background: #f3f4f6;
  border: none;
  padding: 9px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}

.dpo-cancel-btn:hover {
  background: #e5e7eb;
}

/* Create */
.dpo-save-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 9px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.dpo-save-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

/* ========================= */
/* ===== Add Dept Icon ===== */
/* ========================= */

.dpo-adddept-icon {
  font-size: 18px;
  color: #2563eb;
}
</file>

<file path="client/src/pages/DPOPage/DPOIssuePage.css">
.dpo-container {
  width: 100%;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.dpo-container .dpo-content {
  padding: 10px 70px;
  position: relative;
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ---------- Title ---------- */
.dpo-container .dpo-page-title {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
}

.dpo-container .dpo-page-title h1 {
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
}

/* ---------- Upload Icon ---------- */
.dpo-upload-icon {
  font-size: 35px !important;
  margin-top: 40px;
  cursor: pointer;
  transition: 0.2s;
}

.dpo-upload-icon:hover {
  color: #1d4ed8;
  transform: scale(1.05);
}

.dpo-tab-scroll-area {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  padding-right: 10px;
  scrollbar-width: thin;
  scrollbar-color: #cbd5e1 transparent;
}

/* Custom scrollbar for Webkit browsers */
.dpo-tab-scroll-area::-webkit-scrollbar {
  width: 6px;
}

.dpo-tab-scroll-area::-webkit-scrollbar-track {
  background: transparent;
}

.dpo-tab-scroll-area::-webkit-scrollbar-thumb {
  background-color: #cbd5e1;
  border-radius: 20px;
}

/* ---------- Tabs ---------- */
.dpo-tabs-wrapper {
  position: relative;
  margin-top: 10px;
}

/* Add icon anchored to tabs (NO layout impact) */
.dpo-tabs-add-icon {
  position: absolute;
  right: -2px;
  top: 60%;
  transform: translateY(-50%);
  cursor: pointer;
  color: #555;
  transition: 0.2s;
}


@keyframes fadeIn {
  from {
    opacity: 0.3;
    transform: translateY(3px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.dpo-no-issues {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  background: #f3f4f6;
  border-radius: 12px;
}

.dpo-loading-text {
  opacity: 0.7;
}

/* ---------- MODAL ---------- */
.dpo-assign-overlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.dpo-assign-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(6px);
}

.dpo-assign-modal {
  position: relative;
  width: 720px;
  max-height: 85vh;
  background: white;
  border-radius: 12px;
  padding: 20px;
  overflow-y: auto;
  z-index: 10000;
}

.dpo-assign-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dpo-close-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

.dpo-allocate-btn {
  background: #1d4ed8;
  color: #fff;
  border: none;
  padding: 6px 14px;
  margin-bottom: 4px;
  border-radius: 6px;
  cursor: pointer;
}

.dpo-allocate-btn:hover {
  background: #1e40af;
}
.dpo-tab-scroll-area > .empty-state-card,
.dpo-tab-scroll-area > .loading-state {
  margin-top: 0;
  min-height: 100%;
}
</file>

<file path="client/src/pages/LoginPage.jsx">
// import React, { useState } from "react";
// import axios from "axios";
// import { useNavigate } from "react-router-dom";
// import "./LoginPage.css";

// export default function Login() {
//   const navigate = useNavigate();
//   const [username, setUsername] = useState("");
//   const [password, setPassword] = useState("");
//   const [error, setError] = useState("");

//   const handleSubmit = async (e) => {
//     e.preventDefault();
//     setError("");

//     try {
//       const res = await axios.post(
//         "http://127.0.0.1:8000/login",
//         { username, password },
//         { withCredentials: true }   // ‚≠ê VERY IMPORTANT
//       );
      

//       if (!res.data.success) {
//         setError("Login failed");
//         return;
//       }

//       const { role, department } = res.data;

//       // Store minimal info (optional but useful)
//       localStorage.setItem("username", username);
//       localStorage.setItem("role", role);

//       // ---- ROLE BASED REDIRECT ----
//       if (role === "dpo") {
//         navigate("/dpo");
//       } 
//       else if (role === "collector") {
//         navigate("/collector");
//       } 
//       else if (role === "department") {
//         navigate(`/department/${department}`);
//       }
//       else if(username==="openbox") {
//         navigate(`http://127.0.0.1:8000/admin`)
//       }
//       else {
//         setError("Unknown user role");
//       }

//     } catch (err) {
//       console.error(err);
//       setError("Invalid username or password");
//     }
//   };

//   return (
//     <div className="login-container">
//       <form className="login-card" onSubmit={handleSubmit}>
//         <h2 className="login-title">Login</h2>

//         {error && <div className="error-box">{error}</div>}

//         <div className="input-field">
//           <label>Username</label>
//           <input
//             type="text"
//             value={username}
//             onChange={(e) => setUsername(e.target.value)}
//             placeholder="Enter username"
//             required
//           />
//         </div>

//         <div className="input-field">
//           <label>Password</label>
//           <input
//             type="password"
//             value={password}
//             onChange={(e) => setPassword(e.target.value)}
//             placeholder="Enter password"
//             required
//           />
//         </div>

//         <button className="login-btn" type="submit">
//           Login
//         </button>
//       </form>
//     </div>
//   );
// }


// Updated Code Below- BY KEERTHI- TRYING TO FIX LOGIN ISSUE USING TOKEN AUTHENTICATION

import React, { useState } from "react";
import axios from "axios";
import { useNavigate } from "react-router-dom";
import "./LoginPage.css";
import { clearAuthValues, setAuthValue } from "../utils/authStorage";

// Backend base URL
// const API_BASE_URL = "http://localhost:8000";

export default function Login() {
  const navigate = useNavigate();

  // Form state
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");

  // UI state
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");
    setLoading(true);

    try {
      // üî¥ IMPORTANT:
      // Use plain axios for login (NOT api instance)
      // api instance adds token interceptor, but we don't have a token yet
      const response = await axios.post(
        "http://127.0.0.1:8000/login",
        {
          username: username.trim(),
          password: password,
        },
        {
          headers: {
            "Content-Type": "application/json",
          },
        }
      );

      if (!response.data.success) {
        setError("Login failed");
        return;
      }

      const { token, role, department, username: loggedUser } = response.data;

      // ‚úÖ Store auth in tab-scoped storage to support multi-role multi-tab.
      clearAuthValues();
      setAuthValue("token", token);
      setAuthValue("username", loggedUser);
      setAuthValue("role", role);

      if (department) {
        setAuthValue("department", department);
      }

      // ‚úÖ Role-based navigation (REQUIRED) 
      if (role === "dpo") {
        navigate("/dpo/home");
      } else if (role === "collector") {
        navigate("/collector");
      } else if (role === "department") {
        navigate(`/department/${department}`);
      } else {
        setError("Unknown user role");
      }

    } catch (err) {
      console.error("Login error:", err);
      setError("Invalid username or password");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="login-container">
      {/* left branding panel (3 parts) */}
      <div className="login-left">
        <div className="branding">
          <h1>Minutes Tracker</h1>
          <p>Efficiently manage meeting minutes</p>
        </div>
      </div>
      {/* right panel (1 part) with login form */}
      <div className="login-right">
        <form className="login-card" onSubmit={handleSubmit}>
          <h2 className="login-title">Login</h2>

        {error && <div className="error-box">{error}</div>}

        <div className="input-field">
          <label>Username</label>
          <input
            type="text"
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            required
          />
        </div>

        <div className="input-field">
          <label>Password</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />
        </div>

        <button className="login-btn" type="submit" disabled={loading}>
          {loading ? "Logging in..." : "Login"}
        </button>
      </form>
      
      </div> 
    </div> 
  );
}
</file>

<file path="client/src/components/DPO/DPOHeader.jsx">
import React, { useState, useRef, useEffect } from "react";
import "./DPOHeader.css";
import HomeRoundedIcon from "@mui/icons-material/HomeRounded";
import NotificationsIcon from "@mui/icons-material/Notifications";
import LogoutIcon from "@mui/icons-material/Logout";
import BusinessIcon from "@mui/icons-material/Business";
import VisibilityIcon from "@mui/icons-material/Visibility";
import VisibilityOffIcon from "@mui/icons-material/VisibilityOff";
import DescriptionIcon from "@mui/icons-material/Description";
import DraftsIcon from '@mui/icons-material/Drafts';

import { NavLink, useLocation, useNavigate } from "react-router-dom";
import api from "../../api/axios";
import { clearAuthValues, getAuthValue } from "../../utils/authStorage";
import {
  LIVE_EVENT_NOTIFICATIONS_UPDATED,
  addLiveEventListener,
} from "../../utils/liveUpdates";

function Header() {
  const [open, setOpen] = useState(false);
  const [showDeptModal, setShowDeptModal] = useState(false);
  const [hasNewNotifications, setHasNewNotifications] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  const [deptData, setDeptData] = useState({
    name: "",
    email: "",
    password: "",
    confirmPassword: "",
  });

  const dropdownRef = useRef(null);
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setOpen(false);
      }
    };

    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  useEffect(() => {
    const LAST_SEEN_KEY = "dpo_notifications_last_seen_at";

    const markSeen = () => {
      localStorage.setItem(LAST_SEEN_KEY, new Date().toISOString());
      setHasNewNotifications(false);
    };

    const checkNotifications = async () => {
      if (location.pathname === "/dpo/notifications") {
        markSeen();
        return;
      }
      try {
        const username = getAuthValue("username");
        const res = await api.get("/notifications", { params: { username } });
        const notifications = Array.isArray(res.data) ? res.data : [];
        if (notifications.length === 0) {
          setHasNewNotifications(false);
          return;
        }

        const latest = notifications[0];
        const latestTs = latest?.created_at ? new Date(latest.created_at).getTime() : 0;
        const seenTs = new Date(localStorage.getItem(LAST_SEEN_KEY) || 0).getTime();
        setHasNewNotifications(latestTs > seenTs);
      } catch (err) {
        console.error("Notification check error:", err);
      }
    };

    checkNotifications();
    const unsubscribe = addLiveEventListener(
      LIVE_EVENT_NOTIFICATIONS_UPDATED,
      checkNotifications
    );
    return unsubscribe;
  }, [location.pathname]);

  const handleLogout = async () => {
    try {
      await api.post("/logout");
    } catch (err) {
      console.error("Logout error:", err);
    } finally {
      clearAuthValues();
      navigate("/login");
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setDeptData((prev) => ({ ...prev, [name]: value }));
  };

  const handleCreateDepartment = () => {
    if (deptData.password !== deptData.confirmPassword) {
      alert("Passwords do not match");
      return;
    }

    setShowDeptModal(false);
    setDeptData({
      name: "",
      email: "",
      password: "",
      confirmPassword: "",
    });
  };

  return (
    <>
      <header className="dpo-header">
        <div className="dpo-logo">
          <div className="dpo-logo-icon"></div>
          <span>Minutes Tracker System</span>
        </div>

        <div className="dpo-header-icons" ref={dropdownRef}>
          <NavLink
            end
            to="/dpo/home"
            className={({ isActive }) => `dpo-nav-link ${isActive ? "dpo-active" : ""}`}
          >
            <span className="dpo-nav-item">
              <HomeRoundedIcon className="dpo-icon dpo-home" />
              <span className="dpo-nav-text">Home</span>
            </span>
          </NavLink>

          <NavLink
            to="/dpo/drafts"
            className={({ isActive }) => `dpo-nav-link ${isActive ? "dpo-active" : ""}`}
          >
            <span className="dpo-nav-item">
              <DraftsIcon className="dpo-icon dpo-drafts" />
              <span className="dpo-nav-text">Drafts</span>
            </span>
          </NavLink>

          <NavLink
            to="/dpo/minutes"
            className={({ isActive }) => `dpo-nav-link ${isActive ? "dpo-active" : ""}`}
          >
            <span className="dpo-nav-item">
              <DescriptionIcon className="dpo-icon dpo-minutes" />
              <span className="dpo-nav-text">Minutes</span>
            </span>
          </NavLink>

          <NavLink
            to="/dpo/notifications"
            className={({ isActive }) => `dpo-nav-link ${isActive ? "dpo-active" : ""}`}
          >
            <span className="dpo-nav-item">
              <span className="dpo-bell-wrap">
                <NotificationsIcon className="dpo-icon dpo-bell" />
                {hasNewNotifications && <span className="dpo-notification-dot" />}
              </span>
              <span className="dpo-nav-text">Notifications</span>
            </span>
          </NavLink>
          <div className="dpo-icon dpo-profile" onClick={() => setOpen((prev) => !prev)}>
            D
          </div>

          {open && (
            <div className="dpo-profile-dropdown">
              <button
                className="dpo-logout-btn"
                onClick={() => {
                  setOpen(false);
                  setShowDeptModal(true);
                }}
              >
                <BusinessIcon className="dpo-adddept-icon" />
                Add User
              </button>

              <button onClick={handleLogout} className="dpo-logout-btn">
                <LogoutIcon className="dpo-logout-icon" />
                Logout
              </button>
            </div>
          )}
        </div>
      </header>

      {showDeptModal && (
        <div className="dpo-modal-overlay">
          <div className="dpo-modal">
            <h3>Add Department</h3>

            <input
              type="text"
              name="name"
              placeholder="Department Name"
              value={deptData.name}
              onChange={handleInputChange}
            />

            <input
              type="email"
              name="email"
              placeholder="Department Email"
              value={deptData.email}
              onChange={handleInputChange}
            />

            <div className="dpo-password-field">
              <input
                type={showPassword ? "text" : "password"}
                name="password"
                placeholder="Create Password"
                value={deptData.password}
                onChange={handleInputChange}
              />
              <span className="dpo-eye-icon" onClick={() => setShowPassword((prev) => !prev)}>
                {showPassword ? <VisibilityOffIcon /> : <VisibilityIcon />}
              </span>
            </div>

            <div className="dpo-password-field">
              <input
                type={showConfirmPassword ? "text" : "password"}
                name="confirmPassword"
                placeholder="Confirm Password"
                value={deptData.confirmPassword}
                onChange={handleInputChange}
              />
              <span
                className="dpo-eye-icon"
                onClick={() => setShowConfirmPassword((prev) => !prev)}
              >
                {showConfirmPassword ? <VisibilityOffIcon /> : <VisibilityIcon />}
              </span>
            </div>

            <div className="dpo-modal-buttons">
              <button className="dpo-cancel-btn" onClick={() => setShowDeptModal(false)}>
                Cancel
              </button>

              <button className="dpo-save-btn" onClick={handleCreateDepartment}>
                Create
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}

export default Header;
</file>

<file path="backend/api/serializers.py">
from rest_framework import serializers
from .models import IssueDepartment, Notification, Issue

class IssueDepartmentSerializer(serializers.ModelSerializer):
    id = serializers.IntegerField(read_only=True)
    issue_no = serializers.CharField(source='issue.id', read_only=True)
    issue_description = serializers.CharField(source='issue.issue_description', read_only=True)
    issue = serializers.CharField(source='issue.issue_title', read_only=True)
    department = serializers.CharField(source='department.dept_name', read_only=True)
    deadline = serializers.DateField(source='deadline_date', read_only=True, format="%d-%m-%Y")
    location = serializers.CharField(source='issue.location', read_only=True)
    priority = serializers.CharField(source='issue.priority', read_only=True)
    
    # Custom response field to return both text and the file link
    response = serializers.SerializerMethodField()

    class Meta:
        model = IssueDepartment
        fields = [
            'id',             
            'issue_no', 
            'issue',
            'issue_description',
            'department', 
            'location', 
            'priority', 
            'deadline', 
            'status', 
            'response'
        ]

    def get_response(self, obj):
        # Fetch the latest response record for this specific issue-department link
        last_response = obj.responses.last()
        if not last_response:
            return None
            
        return {
            "text": last_response.response_text,
            "attachment": last_response.attachment_path.url if last_response.attachment_path else None
        }

class DPOIssueSerializer(serializers.ModelSerializer):
    issue_no = serializers.IntegerField(source='id', read_only=True)
    issue = serializers.CharField(source='issue_title')
    issue_description = serializers.CharField()
    location = serializers.CharField()
    priority = serializers.CharField()
    
    # For DPO, we group by departments and collect ALL responses
    department = serializers.SerializerMethodField()
    status = serializers.SerializerMethodField()
    deadline = serializers.SerializerMethodField()
    response = serializers.SerializerMethodField()
    meeting_date = serializers.SerializerMethodField()
    minutes_uploaded_date = serializers.SerializerMethodField()
    created_at = serializers.DateTimeField(read_only=True)

    class Meta:
        model = Issue
        fields = [
            'id', 
            'issue_no', 
            'issue', 
            'issue_description',
            'location', 
            'priority', 
            'department', 
            'status', 
            'deadline', 
            'response',
            'meeting_date',
            'minutes_uploaded_date',
            'created_at',
        ]
    
    def get_department(self, obj):
        assignments = obj.issuedepartment_set.all()
        return ", ".join([a.department.dept_name for a in assignments])

    def get_status(self, obj):
        statuses = [a.status.lower() for a in obj.issuedepartment_set.all()]
        if not statuses: return "pending"
        if "overdue" in statuses: return "overdue"
        if any(s in ["submitted", "completed"] for s in statuses):
            return "submitted"
        return "pending"

    def get_deadline(self, obj):
        deadlines = [a.deadline_date for a in obj.issuedepartment_set.all() if a.deadline_date]
        if not deadlines: return "N/A"
        return min(deadlines).strftime("%d-%m-%Y")

    def get_response(self, obj):
        # Returns a list of response objects from all assigned departments
        response_list = []
        for assign in obj.issuedepartment_set.all():
            latest_resp = assign.responses.last()
            if latest_resp:
                response_list.append({
                    "department": assign.department.dept_name,
                    "text": latest_resp.response_text or "",
                    "attachment": latest_resp.attachment_path.url if latest_resp.attachment_path else None
                })
        return response_list if response_list else None

    def get_meeting_date(self, obj):
        if obj.minutes and obj.minutes.meeting_date:
            return obj.minutes.meeting_date.isoformat()
        return None

    def get_minutes_uploaded_date(self, obj):
        if obj.minutes and obj.minutes.created_at:
            return obj.minutes.created_at.date().isoformat()
        return None

class NotificationSerializer(serializers.ModelSerializer):
    time_ago = serializers.SerializerMethodField()
    type = serializers.SerializerMethodField()

    class Meta:
        model = Notification
        fields = ['id', 'message', 'is_read', 'time_ago', 'created_at', 'type']

    def get_time_ago(self, obj):
        from django.utils.timesince import timesince
        return timesince(obj.created_at) + " ago"

    def get_type(self, obj):
        msg = obj.message.lower()
        if "response" in msg: return "response"
        if "assigned" in msg or "action required" in msg: return "assign"
        if "deadline" in msg or "overdue" in msg: return "deadline"
        return "general"
</file>

<file path="backend/backend/settings.py">
from pathlib import Path
import os
from dotenv import load_dotenv

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(os.path.join(BASE_DIR, '.env'))
SECRET_KEY = os.getenv('DJANGO_SECRET_KEY', 'insecure-dev-key')
DEBUG = os.getenv('DEBUG', 'True').lower() == 'true'
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', '*').split(',')

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'rest_framework.authtoken',
    'api',

]


MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]




CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
]

CSRF_TRUSTED_ORIGINS = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
]


ROOT_URLCONF = 'backend.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'backend.wsgi.application'

DATABASES = {
    'default': {
        'ENGINE': os.getenv('DB_ENGINE', 'django.db.backends.postgresql'),
        'NAME': os.getenv('DB_NAME', 'postgres'),
        'USER': os.getenv('DB_USER', 'postgres'),
        'PASSWORD': os.getenv('DB_PASSWORD', ''),
        'HOST': os.getenv('DB_HOST', 'localhost'),
        'PORT': os.getenv('DB_PORT', '5432'),
        'OPTIONS': {
            'sslmode': os.getenv('DB_SSL_MODE', 'require'),
        }
    }
}



LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True
STATIC_URL = 'static/'
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
# Point to our custom user model
AUTH_USER_MODEL = 'api.User'
AUTHENTICATION_BACKENDS = [
    'django.contrib.auth.backends.ModelBackend',
]
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.TokenAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
}
SESSION_COOKIE_SAMESITE = 'Lax'
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SECURE = False  # localhost only
CSRF_COOKIE_SAMESITE = 'Lax'
CSRF_COOKIE_SECURE = False

EMAIL_BACKEND = os.getenv('EMAIL_BACKEND', "django.core.mail.backends.smtp.EmailBackend")
EMAIL_HOST = os.getenv('EMAIL_HOST', "smtp-relay.brevo.com")
EMAIL_PORT = int(os.getenv('EMAIL_PORT', 587))
EMAIL_USE_TLS = os.getenv('EMAIL_USE_TLS', 'True').lower() == 'true'
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER', "")
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD', "")
DEFAULT_FROM_EMAIL = os.getenv('DEFAULT_FROM_EMAIL', "noreply@example.com")
</file>

<file path="backend/api/urls.py">
from django.urls import path
from . import views

urlpatterns = [
    path('login', views.login_view),
    path('logout', views.logout_view),
    path('upload-minutes', views.upload_minutes),
    path('minutes', views.get_minutes),
    path('minutes/<int:minutes_id>', views.delete_minutes),
    path('assign-issues', views.get_assign_issues),
    path('assign-issues/allocate-all', views.allocate_all),
    path('assign-issues/allocate-single', views.allocate_single),
    path('issues', views.get_all_issues),
    path('issues/<str:dept_name>', views.get_dept_issues),
    path('submit-response', views.submit_response),
    path('notifications', views.get_notifications),
    path('generate-report', views.generate_report),
    path('send-overdue-alerts', views.send_overdue_alerts),
]
</file>

<file path="client/src/pages/DPOPage/DPOIssuePage.jsx">
import React, { useEffect, useState, useMemo } from "react";
import { Link } from "react-router-dom";
import DriveFolderUploadSharpIcon from "@mui/icons-material/DriveFolderUploadSharp";
import AddBoxIcon from "@mui/icons-material/AddBox";

// Components
import DPOHeader from "../../components/DPO/DPOHeader";
import DPOTabs from "../../components/DPO/IssuePage/DPOTabs";
import DPOFilterBar from "../../components/DPO/IssuePage/DPOFilterBar";
import DPOIssueCard from "../../components/DPO/IssuePage/DPOIssueCard";
import DPOSingleIssueAssignCard from "../../components/DPO/IssuePage/DPOSingleIssueAssignCard";
import EmptyStateCard from "../../components/common/EmptyStateCard";
import LoadingState from "../../components/common/LoadingState";
import { LIVE_EVENT_ISSUES_UPDATED, addLiveEventListener } from "../../utils/liveUpdates";

// CSS
import "./DPOIssuePage.css";

// API
import api from "../../api/axios";

function DPOIssuePage() {
  const [activeTab, setActiveTab] = useState("Pending");
  const [filters, setFilters] = useState({});
  const [defaultDateRange, setDefaultDateRange] = useState(null);
  const [didInitDateRange, setDidInitDateRange] = useState(false);
  const [allIssues, setAllIssues] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [emailLoading, setEmailLoading] = useState(false);
  const [emailStatus, setEmailStatus] = useState(""); // For "sending..." or success message
  const [showAssignModal, setShowAssignModal] = useState(false);

  const fetchIssues = async () => {
    if (allIssues.length === 0) setLoading(true);
    setError("");
    try {
      const params = filters.date ? { date: filters.date } : {};
      const res = await api.get("/issues", { params });
      setAllIssues(Array.isArray(res.data) ? res.data : []);
    } catch (err) {
      console.error("Error fetching DPO issues:", err);
      setError("Failed to refresh issues. Retrying automatically...");
    } finally {
      setLoading(false);
    }
  };

  const dateKeyFromRaw = (raw) => {
    if (!raw || typeof raw !== "string") return null;

    const ymdMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (ymdMatch) {
      return Number(`${ymdMatch[1]}${ymdMatch[2]}${ymdMatch[3]}`);
    }

    const dt = new Date(raw);
    if (Number.isNaN(dt.getTime())) return null;
    const y = dt.getFullYear();
    const m = String(dt.getMonth() + 1).padStart(2, "0");
    const d = String(dt.getDate()).padStart(2, "0");
    return Number(`${y}${m}${d}`);
  };

  const getIssueDateKeys = (issue) => {
    const keys = [dateKeyFromRaw(issue?.meeting_date || "")].filter(Boolean);
    return [...new Set(keys)];
  };

  const getIssueDateKey = (issue) => {
    const keys = getIssueDateKeys(issue);
    return keys.length > 0 ? Math.max(...keys) : null;
  };

  const toDDMMYYYY = (dt) => {
    const day = String(dt.getDate()).padStart(2, "0");
    const month = String(dt.getMonth() + 1).padStart(2, "0");
    const year = dt.getFullYear();
    return `${day}-${month}-${year}`;
  };

  const parseDDMMYYYYToKey = (value) => {
    if (!value || typeof value !== "string") return null;
    const [dd, mm, yyyy] = value.split("-");
    if (!dd || !mm || !yyyy) return null;
    return Number(`${yyyy}${mm.padStart(2, "0")}${dd.padStart(2, "0")}`);
  };

  // ===== FETCH =====
  useEffect(() => {
    fetchIssues();
  }, [filters.date]);

  useEffect(() => {
    if (didInitDateRange || allIssues.length === 0) return;

    const dated = allIssues
      .map((issue) => {
        const k = getIssueDateKey(issue);
        if (!k) return null;
        const s = String(k);
        return new Date(Number(s.slice(0, 4)), Number(s.slice(4, 6)) - 1, Number(s.slice(6, 8)));
      })
      .filter(Boolean)
      .sort((a, b) => b.getTime() - a.getTime());
    if (dated.length === 0) return;

    const latest = toDDMMYYYY(dated[0]);
    setDefaultDateRange({ fromDate: latest, toDate: latest });
    setFilters((prev) => ({ ...prev, fromDate: latest, toDate: latest }));
    setDidInitDateRange(true);
  }, [allIssues, didInitDateRange]);

  useEffect(() => {
    const onIssuesUpdated = () => {
      fetchIssues();
    };
    const unsubscribe = addLiveEventListener(LIVE_EVENT_ISSUES_UPDATED, onIssuesUpdated);
    return unsubscribe;
  }, [filters.date, allIssues.length]);

  // ===== FILTER =====
  const displayedIssues = useMemo(() => {
    return allIssues.filter((issue) => {
      const status = issue.status?.toLowerCase() || "pending";
      const tab = activeTab.toLowerCase();

      if (
        tab === "received"
          ? !["submitted", "completed"].includes(status)
          : status !== tab
      )
        return false;

      if (filters.searchQuery) {
        const q = filters.searchQuery.toLowerCase();
        if (
          !issue.issue?.toLowerCase().includes(q) &&
          !issue.issue_no?.toString().includes(q) &&
          !issue.department?.toLowerCase().includes(q)
        )
          return false;
      }

      if (filters.filterBy && filters.filterBy !== "all") {
        const f = filters.filterBy.toLowerCase();
        if (["high", "medium", "low"].includes(f)) {
          if (issue.priority?.toLowerCase() !== f) return false;
        } else if (!issue.department?.toLowerCase().includes(f)) return false;
      }

      const issueDateKeys = getIssueDateKeys(issue);
      const fromDateKeyRaw = parseDDMMYYYYToKey(filters.fromDate);
      const toDateKeyRaw = parseDDMMYYYYToKey(filters.toDate);
      const lowerBound =
        fromDateKeyRaw && toDateKeyRaw ? Math.min(fromDateKeyRaw, toDateKeyRaw) : fromDateKeyRaw;
      const upperBound =
        fromDateKeyRaw && toDateKeyRaw ? Math.max(fromDateKeyRaw, toDateKeyRaw) : toDateKeyRaw;
      if ((lowerBound || upperBound) && issueDateKeys.length === 0) return false;
      if (lowerBound || upperBound) {
        const inRange = issueDateKeys.some((key) => {
          if (lowerBound && key < lowerBound) return false;
          if (upperBound && key > upperBound) return false;
          return true;
        });
        if (!inRange) return false;
      }

      return true;
    });
  }, [allIssues, activeTab, filters]);
  const handleAllocateIssue = (issue) => {
    console.log("Allocating issue:", issue);

    api.post("/issues/allocate", issue)
      .then(() => {
        alert("Issue allocated successfully");
        setShowAssignModal(false);
      })
      .catch(() => {
        alert("Backend not ready");
      });
  };
  const handleSendOverdueEmails = () => {
    setEmailLoading(true);
    setEmailStatus("Performing overdue email checks and sending..");

    api.post("/send-overdue-alerts")
      .then((res) => {
        if (res.data.sent_count > 0) {
          setEmailStatus(`All ${res.data.sent_count} Emails sent successfully`);
        } else {
          setEmailStatus("Nothing overdue");
        }
        // Auto-refresh issues to reflect status changes if any
        api.get("/issues").then(r => setAllIssues(r.data));
      })
      .catch((err) => {
        console.error(err);
        setEmailStatus("Error sending emails");
      })
      .finally(() => {
        // Clear status after some time
        setTimeout(() => {
          setEmailLoading(false);
          setEmailStatus("");
        }, 3000);
      });
  };

  return (
    <div className="dpo-container">
      <DPOHeader />
      
      <div className="dpo-content">

        <DPOFilterBar
          activeTab={activeTab}
          onFilterChange={(nf) => setFilters((p) => ({ ...p, ...nf }))}
          issue_date={defaultDateRange}
          handleSendOverdueEmails={handleSendOverdueEmails}
          emailLoading={emailLoading}
          emailStatus={emailStatus}
        />

        {/* ‚úÖ Tabs wrapper (DO NOT TOUCH DPOTabs) */}
        <div className="dpo-tabs-wrapper">
          <DPOTabs activeTab={activeTab} setActiveTab={setActiveTab} />

          <AddBoxIcon
            className="dpo-tabs-add-icon"
            onClick={() => setShowAssignModal(true)}
          />
        </div>

        <div className="dpo-tab-scroll-area">
          {loading && allIssues.length === 0 ? (
            <LoadingState text="Loading issues..." />
          ) : error && allIssues.length === 0 ? (
            <EmptyStateCard
              title="Unable to load issues"
              description={error}
            />
          ) : displayedIssues.length === 0 ? (
            <EmptyStateCard
              title="No issues found"
              description={`There are no ${activeTab.toLowerCase()} issues to display.`}
            />
          ) : (
            displayedIssues.map((issue) => (
              <DPOIssueCard key={issue.id} issue={issue} />
            ))
          )}
        </div>
      </div>

      {/* ===== MODAL ===== */}
      {showAssignModal && (
        <div className="dpo-assign-overlay">
          <div
            className="dpo-assign-backdrop"
            onClick={() => setShowAssignModal(false)}
          />

          <div className="dpo-assign-modal">
            <div className="dpo-assign-header">
              <h2>Add New Issue</h2>
              <button
                className="dpo-close-btn"
                onClick={() => setShowAssignModal(false)}
              >
                ‚úï
              </button>
            </div>

            <DPOSingleIssueAssignCard
              issue={{
                issue_no: "NEW",
                issue: "",
                issue_description: "",
                department: "",
                priority: "Medium",
                location: "",
                deadline: "",
              }}
              index={0}
              onChange={() => { }}
              onAllocate={handleAllocateIssue}
            />

          </div>
        </div>
      )}
    </div>
  );
}

export default DPOIssuePage;
</file>

<file path="backend/api/gemini_utils.py">
import google.generativeai as genai
from google.generativeai.types import HarmCategory, HarmBlockThreshold
import os
import json
import time
from dotenv import load_dotenv

load_dotenv()
GOOGLE_API_KEY = os.getenv('GOOGLE_API_KEY', '')

def get_best_model():
    try:
        for m in genai.list_models():
            if 'generateContent' in m.supported_generation_methods and 'flash' in m.name:
                return m.name
    except: pass
    return 'models/gemini-1.5-flash'

def analyze_document_with_gemini(file_path):
    print(f"--- üß† Starting AI Analysis for: {file_path} ---")
    genai.configure(api_key=GOOGLE_API_KEY)
    
    try:
        uploaded_file = genai.upload_file(path=file_path, display_name="Minutes")
        while uploaded_file.state.name == "PROCESSING":
            time.sleep(1)
            uploaded_file = genai.get_file(uploaded_file.name)
    except Exception as e:
        print(f"‚ùå Upload Error: {e}")
        return []

    model = genai.GenerativeModel(get_best_model())
    safety = {cat: HarmBlockThreshold.BLOCK_NONE for cat in [
        HarmCategory.HARM_CATEGORY_HARASSMENT, HarmCategory.HARM_CATEGORY_HATE_SPEECH,
        HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT
    ]}
    
    prompt = """
    Analyze this Malayalam PDF. Extract every actionable issue.
    
    FORCE RULES:
    1. EXTRACT EVERY ISSUE listed. Do not skip any.
    2. YOU MUST ASSIGN AT LEAST ONE DEPARTMENT. If it is not explicitly mentioned, you MUST INFER it based on these keywords:
       - '‡¥±‡µã‡¥°‡µç' (Road), '‡¥™‡¥æ‡¥≤‡¥Ç' (Bridge) -> PWD_ROADS
       - '‡¥ï‡µÜ‡¥ü‡µç‡¥ü‡¥ø‡¥ü‡¥Ç' (Building), '‡¥∏‡µç‡¥ï‡µÇ‡µæ ‡¥Ö‡¥±‡µç‡¥±‡¥ï‡µÅ‡¥±‡µç‡¥±‡¥™‡µç‡¥™‡¥£‡¥ø' (School repair) -> PWD_BUILDINGS
       - '‡¥ï‡µÅ‡¥ü‡¥ø‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç' (Drinking water), '‡¥™‡µà‡¥™‡µç‡¥™‡µç' (Pipe) -> KWA
       - '‡¥µ‡µà‡¥¶‡µç‡¥Ø‡µÅ‡¥§‡¥ø' (Electricity), '‡¥≤‡µà‡µª' (Line), '‡¥ü‡µç‡¥∞‡¥æ‡µª‡¥∏‡µç‡¥´‡µã‡µº‡¥Æ‡µº' -> KSEB
       - '‡¥Æ‡¥æ‡¥≤‡¥ø‡¥®‡µç‡¥Ø‡¥Ç' (Waste), '‡¥™‡¥û‡µç‡¥ö‡¥æ‡¥Ø‡¥§‡µç‡¥§‡µç' (Panchayat), '‡¥§‡µÜ‡¥∞‡µÅ‡¥µ‡µÅ‡¥®‡¥æ‡¥Ø' (Stray dog) -> LSGD
       - '‡¥ï‡µÉ‡¥∑‡¥ø' (Farming), '‡¥ï‡µº‡¥∑‡¥ï‡µº' (Farmers), '‡¥µ‡¥ø‡¥≥‡¥®‡¥æ‡¥∂‡¥Ç' (Crop damage) -> AGRICULTURE
       - '‡¥ï‡µç‡¥∞‡¥Æ‡¥∏‡¥Æ‡¥æ‡¥ß‡¥æ‡¥®‡¥Ç' (Law & Order), '‡¥ü‡µç‡¥∞‡¥æ‡¥´‡¥ø‡¥ï‡µç' (Traffic) -> POLICE

    STRICT RULES:
    1. Do NOT invent dates. If no deadline is explicitly mentioned in the text for an issue, the "deadline" field MUST be an empty string "".
    2. Do NOT use today's date or any date like '18-12-25'.
    
    
    Return a JSON ARRAY of objects:
    - issue_no: string
    - departments: ARRAY of strings (e.g. ["PWD_ROADS", "LSGD"]) should be extracted from text after ‡¥®‡¥ü‡¥™‡¥ü‡¥ø:- only give the dept, not the officer position, and also convert to the english names of the  departments as above.
    - issue: ONE-LINE Malayalam summary (max 20 words)
    - issue_description: FULL detailed Malayalam issue description (multiple sentences),dont assume anything not in the document.
    - location: Malayalam place name (if mentioned) or "".
    - priority: High/Medium/Low (based on urgency in text, urgency can be inferred from words and high priority for issues that involve MLA/MP/Minister requests)
    - deadline (DD-MM-YYYY or "")
    
    Output ONLY PURE JSON. Do not include any other text.
    """

    try:
        response = model.generate_content([uploaded_file, prompt], safety_settings=safety)
        text = response.text.replace("```json", "").replace("```", "").strip()
        return json.loads(text)
    except Exception as e:
        print(f"‚ùå Generation Error: {e}")
        return []
</file>

<file path="backend/api/views.py">
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated, AllowAny
from rest_framework.response import Response

from django.contrib.auth import authenticate, login, logout, get_user_model
from django.views.decorators.csrf import csrf_exempt
from django.utils import timezone
from django.db.models import Q

from datetime import datetime, date
import os
import openpyxl
from openpyxl.styles import Font, Alignment, Border, Side
from django.http import HttpResponse

from rest_framework.authtoken.models import Token
from collections import defaultdict
import httpx
import requests
import uuid
from urllib.parse import quote

from .models import (
    User,
    Department,
    Issue,
    IssueDepartment,
    Minutes,
    Response as ResponseModel,
    Notification
)
from .services import check_and_send_overdue_emails
from .serializers import IssueDepartmentSerializer, NotificationSerializer, DPOIssueSerializer
from .gemini_utils import analyze_document_with_gemini
import os
from datetime import datetime, date, timedelta
import io
from reportlab.lib.pagesizes import landscape, A4
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, PageBreak
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib import colors
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont

# ================= SUPABASE STORAGE CONFIG ================= #
SUPABASE_URL = os.getenv('SUPABASE_URL', '')
SUPABASE_KEY = os.getenv('SUPABASE_KEY', '')
SUPABASE_BUCKET = os.getenv('SUPABASE_BUCKET_NAME', 'Mnutes')

# ================= TEMP CACHE (ONLY FOR NOW) ================= #
TEMP_DATA_CACHE = []


# ================= AUTH ================= #


@api_view(['POST'])
@permission_classes([AllowAny]) 
def login_view(request):
    print("\n\nüî• ================= DIAGNOSTIC LOGIN START ================= üî•")
    
    # 1. Capture what the Frontend sent
    username_input = request.data.get('username')
    password_input = request.data.get('password')
    print(f"üî• INPUT RECEIVED -> Username: '{username_input}' | Password: '{password_input}'")

    if not username_input or not password_input:
        print("üî• ERROR: Username or Password missing in request body.")
        return Response({"success": False, "message": "Missing credentials"}, status=400)

    # 2. direct Database Check (Bypassing authentication to see if user exists)
    User = get_user_model()
    try:
        # Try finding exact match
        user_db = User.objects.get(username=username_input)
        print(f"üî• DB LOOKUP -> ‚úÖ User '{username_input}' found in database.")
        print(f"   - ID: {user_db.id}")
        print(f"   - Role: {user_db.role}")
        print(f"   - is_active: {user_db.is_active}")
        print(f"   - Password Valid?: {user_db.check_password(password_input)}")
        
        if not user_db.is_active:
            print("   ‚ö†Ô∏è WARNING: User is INACTIVE. Login will fail.")
        
        if not user_db.check_password(password_input):
            print("   ‚ö†Ô∏è WARNING: Password check FAILED. The password stored does not match the input.")

    except User.DoesNotExist:
        print(f"üî• DB LOOKUP -> ‚ùå User '{username_input}' does NOT exist.")
        # Check if it exists with different capitalization
        similar = User.objects.filter(username__iexact=username_input)
        if similar.exists():
            print(f"   ‚ö†Ô∏è FOUND MISMATCH: Did you mean '{similar.first().username}'?")
        else:
            print(f"   ‚ö†Ô∏è No user found. Available users: {list(User.objects.values_list('username', flat=True))}")

    # 3. Actual Authentication Attempt
    user = authenticate(username=username_input, password=password_input)

    if user is None:
        print("üî• FINAL RESULT -> ‚ùå authenticate() failed.")
        print("üî• ================= DIAGNOSTIC LOGIN END ================= üî•\n\n")
        return Response({"success": False, "message": "Invalid username or password"}, status=401)

    print("üî• FINAL RESULT -> ‚úÖ Login Successful!")
    print("üî• ================= DIAGNOSTIC LOGIN END ================= üî•\n\n")

    token, _ = Token.objects.get_or_create(user=user)

    return Response({
        "success": True,
        "token": token.key,
        "username": user.username,
        "role": user.role,
        "department": user.department.dept_name if user.department else None
    })


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def logout_view(request):
    request.user.auth_token.delete()  # Delete the token
    return Response({"success": True})



# ================= MINUTES UPLOAD ================= #

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def upload_minutes(request):
    if request.user.role.lower() != 'dpo':
        return Response({"error": "Only DPO can upload minutes"}, status=403)

    global TEMP_DATA_CACHE

    file = request.FILES.get('file')
    meeting_date_str = request.POST.get('meeting_date')
    
    if not file:
        return Response({"error": "File required"}, status=400)

    # Save file locally temporarily for Gemini analysis
    os.makedirs('media/minutes', exist_ok=True)
    local_file_path = f"media/minutes/{file.name}"

    with open(local_file_path, 'wb+') as dest:
        for chunk in file.chunks():
            dest.write(chunk)

    # Analyze with Gemini
    raw_data = analyze_document_with_gemini(local_file_path)

    # Upload to Supabase Storage
    supabase_file_path = None
    if SUPABASE_URL and SUPABASE_KEY:
        try:
            with open(local_file_path, 'rb') as f:
                file_data = f.read()
            
            # Generate unique filename to avoid collisions
            file_name = f"{uuid.uuid4()}_{file.name}"
            # Upload to public/ folder (required by RLS policy)
            supabase_file_path = f"public/{file_name}"
            
            # URL-encode the file path to handle spaces and special characters
            encoded_file_path = quote(supabase_file_path, safe='/')
            
            # Supabase Storage REST API endpoint
            upload_url = f"{SUPABASE_URL}/storage/v1/object/{SUPABASE_BUCKET}/{encoded_file_path}"
            
            # Use apikey header for Supabase Storage API
            headers = {
                'apikey': SUPABASE_KEY,
                'Content-Type': 'application/octet-stream'
            }
            
            print(f"üì§ Uploading to Supabase: {upload_url}")
            response = requests.put(upload_url, data=file_data, headers=headers, timeout=30)
            
            if response.status_code == 200:
                # Generate public URL for viewing/downloading
                public_url = f"{SUPABASE_URL}/storage/v1/object/public/{SUPABASE_BUCKET}/{encoded_file_path}"
                print(f"‚úÖ File uploaded to Supabase successfully!")
                print(f"   Public URL: {public_url}")
            else:
                print(f"‚ö†Ô∏è Supabase upload failed: {response.status_code}")
                print(f"   Response: {response.text}")
                supabase_file_path = None
        except Exception as e:
            print(f"‚ö†Ô∏è Supabase upload exception: {e}")
            supabase_file_path = None

    clean_data = []
    for item in raw_data:
        depts = item.get('departments') or []
        if not depts:
            depts = [item.get('department', 'GENERAL')]

        item['department'] = ", ".join(d.upper() for d in depts if d)
        clean_data.append(item)

    # ===== CREATE MINUTES RECORD NOW (not waiting for allocate_all) ===== #
    # Get or create DPO user
    u_by = User.objects.filter(role='DPO').first()
    if not u_by:
        u_by = User.objects.first()
    if not u_by:
        u_by = User.objects.create_user(username='dpo', password='dpo', role='DPO')
    # Parse meeting date if provided
    try:
        if meeting_date_str:
            # Handle dd-mm-yyyy format
            parts = meeting_date_str.split('-')
            if len(parts) == 3:
                meeting_date_obj = datetime.strptime(meeting_date_str, '%d-%m-%Y').date()
            else:
                meeting_date_obj = timezone.now().date()
        else:
            meeting_date_obj = timezone.now().date()
    except:
        meeting_date_obj = timezone.now().date()
    
    # Create file_path for database (full URL if Supabase, local path if not)
    if supabase_file_path:
        file_path_for_db = f"{SUPABASE_URL}/storage/v1/object/public/{SUPABASE_BUCKET}/{supabase_file_path}"
    else:
        file_path_for_db = local_file_path
    
    # Create Minutes record IMMEDIATELY
    minute_obj = Minutes.objects.create(
        title=file.name,  # Use actual filename as title
        meeting_date=meeting_date_obj,
        uploaded_by=u_by,
        file_path=file_path_for_db
    )
    
    print(f"‚úÖ Minutes record created: ID {minute_obj.id}, Title: {file.name}")
    # ===== END NEW ===== #

    # Store file path and minutes ID in TEMP_DATA_CACHE for the allocate step
    TEMP_DATA_CACHE = {
        'file_path': supabase_file_path or local_file_path,
        'is_supabase': supabase_file_path is not None,
        'issues': clean_data,
        'minutes_id': minute_obj.id  # Store the minutes ID
    }
    
    return Response({"success": True, "data": clean_data, "minutes_id": minute_obj.id})


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_assign_issues(request):
    if request.user.role.lower() != 'dpo':
        return Response({"error": "Unauthorized"}, status=403)
    # Return only issues, not the file_path
    if isinstance(TEMP_DATA_CACHE, dict) and 'issues' in TEMP_DATA_CACHE:
        return Response(TEMP_DATA_CACHE['issues'])
    return Response(TEMP_DATA_CACHE)


# ================= ISSUE ALLOCATION ================= #

def _resolve_minutes_id(request):
    request_minutes_id = request.data.get('minutes_id') or request.data.get('minutesId')
    try:
        minutes_id = int(request_minutes_id) if request_minutes_id not in [None, '', 'null', 'undefined'] else None
    except (TypeError, ValueError):
        minutes_id = None

    if minutes_id is None and isinstance(TEMP_DATA_CACHE, dict):
        minutes_id = TEMP_DATA_CACHE.get('minutes_id')

    return minutes_id


def _resolve_minutes_obj(minutes_id):
    if not minutes_id:
        return None, Response({"error": "minutes_id is required for allocation."}, status=400)

    try:
        minute_obj = Minutes.objects.get(id=minutes_id)
        return minute_obj, None
    except Minutes.DoesNotExist:
        return None, Response({"error": "Minutes record not found. Please upload file again."}, status=400)


def _create_issues_for_minutes(minute_obj, issues_data):
    dept_counts = {}

    for item in issues_data:
        issue = Issue.objects.create(
            minutes=minute_obj,
            issue_title=item.get('issue', 'No Title'),
            issue_description=item.get('issue_description', ''),
            location=item.get('location', ''),
            priority=item.get('priority', 'Medium')
        )

        dept_list = [
            d.strip().upper()
            for d in str(item.get('department', 'GENERAL')).split(',')
            if d.strip()
        ]

        for dept_name in dept_list:
            safe_dept_name = dept_name[:100]
            dept, _ = Department.objects.get_or_create(dept_name=safe_dept_name)
            dept_counts[dept] = dept_counts.get(dept, 0) + 1

            d_date = date.today() + timedelta(days=14)
            IssueDepartment.objects.create(
                issue=issue,
                department=dept,
                deadline_date=d_date,
                status='pending'
            )

    for dept, count in dept_counts.items():
        users = User.objects.filter(department=dept).exclude(role__in=['DPO', 'COLLECTOR'])
        for u in users:
            Notification.objects.create(
                user=u,
                issue_department=None,
                message=f"ACTION REQUIRED: {count} new issues have been assigned to your department."
            )


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def allocate_single(request):
    if request.user.role.lower() != 'dpo':
        return Response({"error": "Only DPO can allocate"}, status=403)

    issue_item = request.data.get('issue')
    if not isinstance(issue_item, dict):
        return Response({"error": "issue payload is required."}, status=400)

    minutes_id = _resolve_minutes_id(request)
    minute_obj, err = _resolve_minutes_obj(minutes_id)
    if err:
        return err

    _create_issues_for_minutes(minute_obj, [issue_item])
    return Response({"success": True, "allocated": 1})


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def allocate_all(request):
    if request.user.role.lower() != 'dpo':
        return Response({"error": "Only DPO can allocate"}, status=403)

    global TEMP_DATA_CACHE

    issues_data = request.data.get('issues', [])
    if not issues_data and isinstance(TEMP_DATA_CACHE, dict):
        issues_data = TEMP_DATA_CACHE.get('issues', [])
    elif not issues_data and isinstance(TEMP_DATA_CACHE, list):
        issues_data = TEMP_DATA_CACHE

    if not isinstance(issues_data, list) or len(issues_data) == 0:
        return Response({"error": "No issues provided for allocation."}, status=400)

    minutes_id = _resolve_minutes_id(request)
    minute_obj, err = _resolve_minutes_obj(minutes_id)
    if err:
        return err

    _create_issues_for_minutes(minute_obj, issues_data)

    TEMP_DATA_CACHE = []
    return Response({"success": True, "allocated": len(issues_data)})


# ================= ISSUES ================= #

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_all_issues(request):
    if request.user.role.lower() not in ['dpo', 'collector']:
        return Response({"error": "Unauthorized"}, status=403)

    today = date.today()
    
    # 1. Update Overdue Status (Optimized)
    overdue_assignments = IssueDepartment.objects.filter(
        status__iexact='pending', 
        deadline_date__lt=today
    )
    for i in overdue_assignments:
        i.status = 'overdue'
        i.save()

    # 2. Get the date filter
    filter_date = request.query_params.get('date')

    # 3. Start Query (FIXED for Speed AND Accuracy)
    # We kept 'department' (Major Speed Boost) but REMOVED 'responses'.
    # This ensures the serializer finds the latest response text correctly.
    issues_query = Issue.objects.prefetch_related(
        'issuedepartment_set',
        'issuedepartment_set__department'
        # REMOVED: 'issuedepartment_set__responses' (This was causing the bug)
    ).all().order_by('-id')

    # 4. Apply Date Filter
    if filter_date:
        issues_query = issues_query.filter(minutes__meeting_date__date=filter_date)

    serializer = DPOIssueSerializer(issues_query, many=True)
    return Response(serializer.data)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_dept_issues(request, dept_name):
    if request.user.role.lower() != 'department':
        return Response({"error": "Unauthorized"}, status=403)

    today = date.today()
    
    # 1. OPTIMIZATION: 'select_related' fetches the parent Issue and Dept info in the SAME query.
    # 'prefetch_related' fetches all the responses in the SAME query.
    issues_query = IssueDepartment.objects.select_related('issue', 'department').prefetch_related('responses').filter(
        department__dept_name__iexact=dept_name.strip()
    ).order_by('-issue__id') 
    
    # 2. Update Overdue Status (Only for pending items to save time)
    # We iterate through the already fetched list to avoid a second DB hit
    for i in issues_query:
        if i.status.lower() == 'pending' and i.deadline_date and i.deadline_date < today:
            i.status = 'overdue'
            i.save()
            
    serializer = IssueDepartmentSerializer(issues_query, many=True)
    return Response(serializer.data)

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def submit_response(request):
    # 1. Get data safely (handle both JSON and FormData)
    issue_id = request.data.get('issue_id') or request.data.get('id')
    response_text = request.data.get('response')
    attachment = request.FILES.get('attachment')

    print(f"üìù Submitting response for ID: {issue_id}")

    if not issue_id or str(issue_id) == "undefined":
        return Response({"error": "Invalid ID provided"}, status=400)

    try:
        issue_link = IssueDepartment.objects.get(id=issue_id)
        
        # FIX: Create Response with attachment
        ResponseModel.objects.create(
            issue_department=issue_link, 
            response_text=response_text or "",
            attachment_path=attachment
        )
        
        issue_link.status = 'submitted'
        issue_link.save()
        
        # --- NOTIFY DPO ---
        dpos = User.objects.filter(Q(role__iexact='DPO') | Q(username__iexact='dpo'))
        issue_number = issue_link.issue.id 
        dept_name = issue_link.department.dept_name

        for d in dpos:
            Notification.objects.create(
                user=d, 
                issue_department=issue_link,
                message=f"Response Received: {dept_name} responded to Issue #{issue_number}"
            )
            
        return Response({"success": True})

    except IssueDepartment.DoesNotExist:
        return Response({"error": "Issue not found"}, status=404)
    except Exception as e:
        print(f"üî• CRITICAL SUBMIT ERROR: {str(e)}")
        import traceback
        traceback.print_exc()
        return Response({"error": str(e)}, status=500)

@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_notifications(request):
    notifs = Notification.objects.filter(
        user=request.user
    ).order_by('-created_at')[:20]

    return Response(NotificationSerializer(notifs, many=True).data)
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def me(request):
    return Response({
        "authenticated": True,
        "username": request.user.username,
        "role": request.user.role,
    })
# core/views.py
from django.http import JsonResponse

def test_view(request):
    print("üî• TEST VIEW HIT:", request.method)
    return JsonResponse({"ok": True})


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def generate_report(request):
    # 1. Parse request data sent from the frontend modal
    req_format = request.data.get('format', 'excel')
    reports_data = request.data.get('reports', [])

    # Fallback just in case no data was sent (backward compatibility)
    if not reports_data:
        return Response({"error": "No report data provided."}, status=400)

    # ==========================================
    #             PDF GENERATION
    # ==========================================
    if req_format == 'pdf':
        buffer = io.BytesIO()
        # Set to Landscape A4 for TV Presentation
        doc = SimpleDocTemplate(buffer, pagesize=landscape(A4), rightMargin=40, leftMargin=40, topMargin=40, bottomMargin=40)
        elements = []
        styles = getSampleStyleSheet()
        
        # --- REGISTER MALAYALAM FONT ---
        import os
        from django.conf import settings
        
        # Adjust path if you placed the font somewhere else
        font_path = os.path.join(settings.BASE_DIR, 'font', 'NotoSansMalayalam-Regular.ttf') 
        
        try:
            pdfmetrics.registerFont(TTFont('MalayalamFont', font_path))
            font_name = 'MalayalamFont'
        except Exception as e:
            print(f"Font loading error: {e}")
            font_name = 'Helvetica' # Fallback if font isn't found

        # Presentation Styles
        issue_no_style = ParagraphStyle(
            'IssueNo', parent=styles['Normal'], fontName=font_name, fontSize=18,
            textColor=colors.white, backColor=colors.HexColor('#1E3A8A'),
            borderPadding=8, spaceAfter=20
        )
        issue_text_style = ParagraphStyle(
            'IssueText', parent=styles['Normal'], fontName=font_name, fontSize=24,
            leading=34, spaceAfter=40
        )
        dept_style = ParagraphStyle(
            'DeptText', parent=styles['Normal'], fontName=font_name, fontSize=18,
            textColor=colors.red, alignment=2 # 2 = Right aligned
        )
        response_header_style = ParagraphStyle(
            'ResponseHeader', parent=styles['Normal'], fontName=font_name, fontSize=22,
            textColor=colors.white, backColor=colors.HexColor('#0284c7'), # Lighter blue
            borderPadding=10, spaceAfter=20
        )
        response_text_style = ParagraphStyle(
            'ResponseText', parent=styles['Normal'], fontName=font_name, fontSize=22,
            leading=32, spaceAfter=20
        )

        for report in reports_data:
            # --- SLIDE 1: THE ISSUE ---
            issue_title = report.get('issue_no', 'Unknown Issue')
            elements.append(Paragraph(f"Issue: {issue_title}", issue_no_style))
            
            issue_desc = report.get('issue', '')
            elements.append(Paragraph(issue_desc, issue_text_style))
            
            dept_name = report.get('department', '')
            elements.append(Paragraph(f"{dept_name}", dept_style))
            
            # --- SLIDE 2: THE RESPONSE ---
            elements.append(PageBreak()) 
            
            elements.append(Paragraph("‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥Ö‡¥µ‡¥∏‡µç‡¥• / Action Taken", response_header_style))
            
            response_text = report.get('response', 'No response yet')
            # Split response by newlines so it formats nicely
            for para in response_text.split('\n'):
                if para.strip():
                    elements.append(Paragraph(para.strip(), response_text_style))
                    elements.append(Spacer(1, 10))

            # Move to next issue
            elements.append(PageBreak())

        doc.build(elements)
        pdf = buffer.getvalue()
        buffer.close()
        
        response = HttpResponse(content_type='application/pdf')
        response['Content-Disposition'] = 'attachment; filename="DDC_Presentation.pdf"'
        response.write(pdf)
        return response

    # ==========================================
    #            EXCEL GENERATION
    # ==========================================
    else:
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "Follow Up Report"

        header_font = Font(bold=True, size=11, name='Calibri')
        center_align = Alignment(horizontal='center', vertical='center', wrap_text=True)
        content_align = Alignment(horizontal='left', vertical='center', wrap_text=True, indent=1)
        thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))

        ws.column_dimensions['A'].width = 10  
        ws.column_dimensions['B'].width = 40  
        ws.column_dimensions['C'].width = 30  
        ws.column_dimensions['D'].width = 80  
        ws.column_dimensions['E'].width = 60  

        headers = [
            "‡¥ï‡µç‡¥∞‡¥Æ ‡¥®‡¥Æ‡µç‡¥™‡µº", 
            "‡¥â‡¥®‡µç‡¥®‡¥Ø‡¥ø‡¥ö‡µç‡¥ö ‡¥§‡µÄ‡¥Ø‡¥§‡¥ø & ‡¥µ‡¥ï‡µÅ‡¥™‡µç‡¥™‡µç/‡¥µ‡¥ø‡¥∑‡¥Ø‡¥Ç", 
            "‡¥®‡¥ü‡¥™‡¥ü‡¥ø ‡¥∏‡µç‡¥µ‡µÄ‡¥ï‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µá‡¥£‡µç‡¥ü ‡¥â‡¥¶‡µç‡¥Ø‡µã‡¥ó‡¥∏‡µç‡¥•‡µª",
            "‡¥Æ‡µÅ‡µª ‡¥Ø‡µã‡¥ó‡¥§‡µç‡¥§‡¥ø‡µΩ ‡¥ö‡µº‡¥ö‡µç‡¥ö ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥§‡µÅ‡¥Ç ‡¥Ø‡µã‡¥ó ‡¥®‡¥ø‡µº‡¥¶‡µç‡¥¶‡µá‡¥∂‡¥µ‡µÅ‡¥Ç", 
            "‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÜ ‡¥∏‡µç‡¥±‡µç‡¥±‡¥æ‡¥±‡µç‡¥±‡¥∏‡µç"
        ]
        
        meeting_date_str = timezone.now().strftime("%d-%m-%Y")

        ws.merge_cells('A1:E1')
        main_header = ws['A1']
        main_header.value = f"{meeting_date_str} -‡¥®‡µç ‡¥ö‡µá‡µº‡¥®‡µç‡¥® ‡¥ú‡¥ø‡¥≤‡µç‡¥≤‡¥æ ‡¥µ‡¥ø‡¥ï‡¥∏‡¥® ‡¥∏‡¥Æ‡¥ø‡¥§‡¥ø ‡¥Ø‡µã‡¥ó‡¥§‡µç‡¥§‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡µÅ‡¥ü‡µº ‡¥®‡¥ü‡¥™‡¥ü‡¥ø ‡¥±‡¥ø‡¥™‡µç‡¥™‡µã‡µº‡¥ü‡µç‡¥ü‡µç"
        main_header.font = Font(bold=True, size=12, name='Calibri')
        main_header.alignment = Alignment(horizontal='center', vertical='center')
        main_header.border = thin_border
        ws.row_dimensions[1].height = 30

        ws.append(headers)

        for cell in ws[2]:
            cell.font = header_font
            cell.alignment = center_align
            cell.border = thin_border
            ws.row_dimensions[2].height = 45

        # Populate Excel with the EDITED data from the frontend
        for index, report in enumerate(reports_data, start=1):
            subject_col_text = f"‡¥§‡µÄ‡¥Ø‡¥§‡¥ø: {meeting_date_str}\n\n{report.get('issue_no', '')}"

            row_data = [
                index,
                subject_col_text,
                report.get('department', ''),
                report.get('issue', ''),
                report.get('response', '')
            ]
            ws.append(row_data)

            current_row = ws.max_row
            for cell in ws[current_row]:
                cell.alignment = content_align
                cell.border = thin_border

        response = HttpResponse(content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
        response['Content-Disposition'] = 'attachment; filename="Follow_Up_Report.xlsx"'
        wb.save(response)
        return response

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def send_overdue_alerts(request):
    if request.user.role.lower() != 'dpo':
        return Response({"error": "Unauthorized"}, status=403)
    
    sent_count = check_and_send_overdue_emails()
    
    return Response({
        "success": True,
        "sent_count": sent_count
    })


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def get_minutes(request):
    """Fetch all uploaded minutes - accessible to DPO and Department users"""
    # Allow both DPO and department users to view
    if request.user.role.lower() not in ['dpo', 'department', 'collector']:
        return Response({"error": "Unauthorized to view minutes"}, status=403)
    
    minutes = Minutes.objects.all().order_by('-created_at').prefetch_related('issues')
    
    minutes_data = []
    for m in minutes:
        # Convert FieldFile to string
        file_path_str = str(m.file_path) if m.file_path else None
        
        # file_path is already a full URL if from Supabase, or a local path if not
        file_url = file_path_str
        if file_url and not file_url.startswith('http'):
            # Local file - add /media/ prefix
            file_url = f"/media/{file_url}"
        
        # Extract original filename from the file path
        # For Supabase files: "public/uuid_filename.pdf" -> "filename.pdf"
        # For local files: "media/minutes/filename.pdf" -> "filename.pdf"
        original_filename = file_path_str
        if original_filename and '_' in original_filename:
            # Extract filename after UUID prefix
            original_filename = original_filename.split('_', 1)[1]
        elif original_filename:
            # Extract just the filename from path
            original_filename = original_filename.split('/')[-1]
        
        minutes_data.append({
            'id': m.id,
            'title': m.title,
            'originalFileName': original_filename,
            'uploadedDate': m.created_at.isoformat(),
            'meetingDate': m.meeting_date.isoformat() if m.meeting_date else None,
            'fileUrl': file_url,
            'uploadedBy': m.uploaded_by.username if m.uploaded_by else 'Unknown',
            'issueCount': m.issues.count()
        })
    
    return Response(minutes_data)


@api_view(['DELETE'])
@permission_classes([IsAuthenticated])
def delete_minutes(request, minutes_id):
    """Delete a Minutes record"""
    if request.user.role.lower() != 'dpo':
        return Response({"error": "Only DPO can delete minutes"}, status=403)
    
    try:
        minute = Minutes.objects.get(id=minutes_id)
        
        # Get original filename for response
        file_path_str = str(minute.file_path) if minute.file_path else "Unknown"
        original_filename = file_path_str
        if original_filename and '_' in original_filename:
            original_filename = original_filename.split('_', 1)[1]
        elif original_filename:
            original_filename = original_filename.split('/')[-1]
        
        print(f"üóëÔ∏è  Deleting Minutes: {original_filename} (ID: {minutes_id})")
        
        # Delete the minute and associated issues
        minute.delete()
        
        return Response({
            "success": True,
            "message": f"Deleted: {original_filename}"
        })
    
    except Minutes.DoesNotExist:
        return Response({"error": "Minutes record not found"}, status=404)
    except Exception as e:
        print(f"‚ùå Error deleting minutes: {e}")
        return Response({"error": str(e)}, status=500)
</file>

</files>
